<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quote | Customer Portal | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css?v=30">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    .quote-container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .quote-section {
      background: var(--color-bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-xl);
      overflow: hidden;
    }
    
    .quote-section-header {
      background: var(--color-bg-alt);
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--color-border-light);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .quote-section-body {
      padding: var(--space-lg);
    }
    
    .line-item {
      display: grid;
      grid-template-columns: auto 60px 1fr auto;
      gap: var(--space-md);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      transition: background var(--transition-fast);
      align-items: start;
    }
    
    .line-item:hover {
      background: var(--color-bg-alt);
    }
    
    .line-item.optional {
      background: rgba(99, 102, 241, 0.05);
      border: 1px dashed var(--color-primary);
    }
    
    .line-item.optional.selected {
      background: rgba(99, 102, 241, 0.1);
      border-style: solid;
    }
    
    .line-item-action {
      min-width: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .line-item-action .btn {
      white-space: nowrap;
    }
    
    .line-item-photo {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: transform var(--transition-fast);
    }
    
    .line-item-photo:hover {
      transform: scale(1.05);
    }
    
    .line-item-photo-placeholder {
      width: 60px;
      height: 60px;
      background: var(--color-bg-alt);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
    }
    
    .line-item-content h4 {
      margin: 0 0 var(--space-xs);
      font-size: 1rem;
    }
    
    .line-item-details {
      font-size: 0.875rem;
      color: var(--color-text-light);
    }
    
    .line-item-price {
      text-align: right;
      white-space: nowrap;
    }
    
    .line-item-price-value {
      font-weight: 700;
      font-size: 1.125rem;
      color: var(--color-primary);
    }
    
    .line-item-price-range {
      font-size: 0.875rem;
      color: var(--color-text-muted);
    }
    
    .optional-badge {
      display: inline-block;
      background: var(--color-primary);
      color: var(--color-text-inverse);
      font-size: 0.6875rem;
      font-weight: 700;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      margin-left: var(--space-sm);
    }
    
    .totals-section {
      background: var(--color-primary);
      color: var(--color-text-inverse);
      padding: var(--space-xl);
      border-radius: var(--radius-lg);
    }
    
    .totals-row {
      display: flex;
      justify-content: space-between;
      padding: var(--space-sm) 0;
    }
    
    .totals-row.grand-total {
      font-size: 1.5rem;
      font-weight: 700;
      padding-top: var(--space-md);
      margin-top: var(--space-md);
      border-top: 2px solid rgba(255,255,255,0.2);
    }
    
    .deposit-info {
      background: rgba(255,255,255,0.1);
      padding: var(--space-md);
      border-radius: var(--radius-md);
      margin-top: var(--space-lg);
      text-align: center;
    }
    
    .deposit-amount {
      font-size: 1.25rem;
      font-weight: 700;
    }
    
    .accept-section {
      text-align: center;
      padding: var(--space-xl);
    }
    
    .accept-btn {
      font-size: 1.125rem;
      padding: var(--space-md) var(--space-2xl);
    }
    
    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      border-radius: var(--radius-md);
    }
    
    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .attachment-list {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
    }
    
    .attachment-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      background: var(--color-bg-alt);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      text-decoration: none;
      color: var(--color-text);
      transition: background var(--transition-fast);
    }
    
    .attachment-item:hover {
      background: var(--color-border);
    }
    
    .attachment-item svg {
      width: 16px;
      height: 16px;
      color: var(--color-text-muted);
    }
    
    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: pointer;
    }
    
    .image-modal img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }
    
    .quote-expired {
      background: var(--color-warning);
      color: white;
      padding: var(--space-md);
      border-radius: var(--radius-md);
      text-align: center;
      margin-bottom: var(--space-xl);
    }
    
    .quote-accepted {
      background: var(--color-success);
      color: white;
      padding: var(--space-md);
      border-radius: var(--radius-md);
      text-align: center;
      margin-bottom: var(--space-xl);
    }
    
    /* Change Order Styles */
    .change-order-card {
      background: var(--color-bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-xl);
      overflow: hidden;
      border-left: 4px solid var(--color-primary);
    }
    
    .change-order-header {
      background: var(--color-bg-alt);
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--color-border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .change-order-title {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .change-order-badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    
    .change-order-badge.pending {
      background: #dbeafe;
      color: #1d4ed8;
    }
    
    .change-order-badge.accepted {
      background: #d1fae5;
      color: #047857;
    }
    
    .change-order-badge.declined {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .change-order-body {
      padding: var(--space-lg);
    }
    
    .change-order-item {
      display: flex;
      justify-content: space-between;
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--color-border-light);
    }
    
    .change-order-item:last-child {
      border-bottom: none;
    }
    
    .change-order-total {
      display: flex;
      justify-content: space-between;
      padding: var(--space-md);
      background: var(--color-primary);
      color: white;
      font-weight: 600;
      margin-top: var(--space-md);
      border-radius: var(--radius-md);
    }
    
    .change-order-actions {
      display: flex;
      gap: var(--space-sm);
      margin-top: var(--space-lg);
      padding-top: var(--space-lg);
      border-top: 1px solid var(--color-border-light);
    }
    
    .declined-item {
      opacity: 0.7;
      color: var(--color-text-muted);
    }
    
    .declined-item .line-item-content h4 {
      color: #f59e0b;
    }
    
    /* Payment History Styles */
    .payment-history {
      background: var(--color-bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-xl);
      overflow: hidden;
      border-left: 4px solid var(--color-success);
    }
    
    .payment-history-header {
      background: #d1fae5;
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--color-border-light);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      color: #047857;
    }
    
    .payment-history-body {
      padding: var(--space-lg);
    }
    
    .payment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md);
      background: var(--color-bg-soft);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
    }
    
    .payment-item:last-child {
      margin-bottom: 0;
    }
    
    .payment-item-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .payment-item-date {
      font-weight: 500;
    }
    
    .payment-item-method {
      font-size: 0.75rem;
      color: var(--color-text-muted);
    }
    
    .payment-item-amount {
      font-weight: 600;
      color: var(--color-success);
      font-size: 1.125rem;
    }
    
    .payment-summary {
      display: flex;
      justify-content: space-between;
      padding: var(--space-md);
      background: #d1fae5;
      border-radius: var(--radius-md);
      margin-top: var(--space-md);
    }
    
    .payment-summary-label {
      font-weight: 500;
      color: #047857;
    }
    
    .payment-summary-value {
      font-weight: 600;
      color: #047857;
    }
    
    .quote-actions {
      display: flex;
      gap: var(--space-md);
      justify-content: flex-end;
      margin-bottom: var(--space-lg);
    }
    
    .print-btn {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    /* Print Styles */
    @media print {
      body {
        background: white !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .portal-header,
      .portal-nav,
      .quote-actions,
      .accept-section,
      #accept-btn,
      .line-item-action {
        display: none !important;
      }
      
      .portal-container {
        padding: 0 !important;
        max-width: none !important;
      }
      
      .quote-container {
        max-width: none !important;
      }
      
      .quote-section {
        break-inside: avoid;
        box-shadow: none !important;
        border: 1px solid #ddd;
      }
      
      .line-item {
        grid-template-columns: 60px 1fr auto !important;
      }
      
      .totals-section {
        background: #6366f1 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      .quote-header {
        background: #6366f1 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      
      /* Add company header for print */
      .print-header {
        display: block !important;
        text-align: center;
        margin-bottom: var(--space-xl);
        padding-bottom: var(--space-lg);
        border-bottom: 2px solid #6366f1;
      }
      
      .print-header h1 {
        color: #6366f1;
        margin: 0;
      }
      
      .print-header p {
        color: #666;
        margin: var(--space-sm) 0 0;
      }
    }
    
    @media screen {
      .print-header {
        display: none;
      }
    }
    
    /* Package Selection Styles */
    .packages-section {
      margin-bottom: var(--space-xl);
    }
    
    .packages-section h2 {
      text-align: center;
      margin-bottom: var(--space-sm);
    }
    
    .packages-section .packages-subtitle {
      text-align: center;
      color: var(--color-text-muted);
      margin-bottom: var(--space-xl);
    }
    
    .packages-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-lg);
    }
    
    @media (max-width: 900px) {
      .packages-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 600px) {
      .packages-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .package-card {
      background: var(--color-bg-card);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      position: relative;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .package-card:hover {
      border-color: var(--color-primary);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12), 0 4px 12px rgba(0, 0, 0, 0.08);
      transform: translateY(-4px);
    }
    
    .package-card.recommended {
      border-color: var(--color-primary);
    }
    
    .package-card.selected {
      border-color: var(--color-success);
      box-shadow: 0 0 0 2px var(--color-success), 0 10px 40px rgba(0, 0, 0, 0.1);
    }
    
    .package-card.selected:hover {
      transform: translateY(-4px);
      box-shadow: 0 0 0 2px var(--color-success), 0 10px 40px rgba(0, 0, 0, 0.15);
    }
    
    .package-recommended-badge {
      position: absolute;
      top: -1px;
      right: 20px;
      background: var(--color-text-muted);
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      padding: 4px 8px;
      border-radius: 0 0 4px 4px;
      transform: rotate(0deg);
    }
    
    .package-card.recommended .package-recommended-badge {
      background: var(--color-primary);
    }
    
    .package-radio {
      position: absolute;
      top: var(--space-md);
      left: var(--space-md);
      width: 20px;
      height: 20px;
      border: 2px solid var(--color-border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .package-card.selected .package-radio {
      border-color: var(--color-success);
      background: var(--color-success);
    }
    
    .package-card.selected .package-radio::after {
      content: '';
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
    }
    
    .package-name {
      font-size: 1.25rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: var(--space-sm);
    }
    
    .package-description {
      text-align: center;
      color: var(--color-text-muted);
      font-size: 0.875rem;
      margin-bottom: var(--space-md);
      min-height: 40px;
    }
    
    .package-price {
      text-align: center;
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: var(--space-lg);
    }
    
    .package-price sup {
      font-size: 1rem;
      vertical-align: super;
    }
    
    .package-items-list {
      border-top: 1px solid var(--color-border-light);
      padding-top: var(--space-md);
    }
    
    .package-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--color-border-light);
      font-size: 0.875rem;
    }
    
    .package-item.excluded {
      color: var(--color-text-muted);
      text-decoration: line-through;
    }
    
    .package-item-name {
      flex: 1;
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .package-item-price {
      font-weight: 500;
    }
    
    .package-item .info-icon {
      color: var(--color-text-muted);
      cursor: help;
    }
    
    .package-select-btn {
      width: 100%;
      margin-top: var(--space-lg);
      padding: var(--space-md);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .package-select-btn:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }
    
    .package-card.selected .package-select-btn {
      background: var(--color-success);
      border-color: var(--color-success);
      color: white;
    }
    
    .package-warning {
      background: #fef3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: var(--space-md) var(--space-lg);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-xl);
    }
  </style>
</head>
<body>
  <header class="portal-header" id="portal-header">
    <a href="/portal/dashboard.html" class="portal-logo">
      <img src="/images/logo.gif" alt="Homestead Cabinet Design" style="height: 36px; filter: brightness(0) invert(1);">
    </a>
    <nav class="portal-nav" id="portal-nav">
      <a href="/portal/dashboard.html" class="portal-nav-link">Dashboard</a>
      <a href="/portal/quotes.html" class="portal-nav-link active">Quotes</a>
      <a href="/portal/invoices.html" class="portal-nav-link">Invoices</a>
      <a href="/portal/payments.html" class="portal-nav-link">Payments</a>
      <a href="/portal/files.html" class="portal-nav-link">Files</a>
      <a href="/portal/uploads.html" class="portal-nav-link">Uploads</a>
    </nav>
  </header>
  
  <main class="portal-container">
    <div class="quote-container">
      <!-- Loading State -->
      <div id="loading-state">
        <div class="skeleton" style="height: 200px; margin-bottom: 20px;"></div>
        <div class="skeleton" style="height: 300px; margin-bottom: 20px;"></div>
        <div class="skeleton" style="height: 150px;"></div>
      </div>
      
      <!-- Quote Content -->
      <div id="quote-content" style="display: none;">
        <!-- Print Header (only shows when printing) -->
        <div class="print-header">
          <h1>Homestead Cabinet Design</h1>
          <p>raymond@homesteadcabinetdesign.com</p>
        </div>
        
        <!-- Actions Bar -->
        <div class="quote-actions no-print">
          <button class="btn btn-secondary print-btn" onclick="window.print()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 6 2 18 2 18 9"/>
              <path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/>
              <rect x="6" y="14" width="12" height="8"/>
            </svg>
            Print / Save PDF
          </button>
        </div>
        
        <!-- Status Banner -->
        <div id="status-banner"></div>
        
        <!-- Quote Header -->
        <div class="quote-header" style="border-radius: var(--radius-lg); margin-bottom: var(--space-xl);">
          <div class="quote-number" id="quote-number"></div>
          <h1 class="quote-title" id="quote-title"></h1>
          <div id="quote-date"></div>
        </div>
        
        <!-- Packages Section (shown when packages_enabled) -->
        <div id="packages-section" class="packages-section" style="display: none;">
          <h2>Select Your Bundle</h2>
          <p class="packages-subtitle">Choose the option that best fits your needs</p>
          <div class="packages-grid" id="packages-grid"></div>
          <div id="package-warning" class="package-warning" style="display: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
            Please select a bundle to continue with your proposal.
          </div>
        </div>
        
        <!-- Line Items Section -->
        <div class="quote-section">
          <div class="quote-section-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"/>
              <line x1="8" y1="12" x2="21" y2="12"/>
              <line x1="8" y1="18" x2="21" y2="18"/>
              <line x1="3" y1="6" x2="3.01" y2="6"/>
              <line x1="3" y1="12" x2="3.01" y2="12"/>
              <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            Quote Details
          </div>
          <div class="quote-section-body" id="line-items-container">
            <!-- Line items will be rendered here -->
          </div>
        </div>
        
        <!-- Attachments Section -->
        <div id="attachments-section" class="quote-section" style="display: none;">
          <div class="quote-section-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
            </svg>
            Attachments
          </div>
          <div class="quote-section-body">
            <div class="attachment-list" id="attachment-list"></div>
          </div>
        </div>
        
        <!-- Declined Options Section -->
        <div id="declined-options-section" class="quote-section" style="display: none; border-left: 4px solid #f59e0b;">
          <div class="quote-section-header" style="background: #fffbeb;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            Declined Options
          </div>
          <div class="quote-section-body" id="declined-options-container">
            <!-- Declined options will be rendered here -->
          </div>
        </div>
        
        <!-- Change Orders Section -->
        <div id="change-orders-section" style="display: none;">
          <!-- Change orders will be rendered here -->
        </div>
        
        <!-- Payment History Section -->
        <div id="payment-history-section" class="payment-history" style="display: none;">
          <div class="payment-history-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
              <line x1="1" y1="10" x2="23" y2="10"/>
            </svg>
            Payment History
          </div>
          <div class="payment-history-body" id="payment-history-body">
            <!-- Payments will be rendered here -->
          </div>
        </div>
        
        <!-- Totals Section -->
        <div class="totals-section" id="totals-section">
          <div class="totals-row">
            <span>Subtotal</span>
            <span id="subtotal">$0.00</span>
          </div>
          <div class="totals-row" id="tax-row" style="display: none;">
            <span>Tax (<span id="tax-rate">0</span>%)</span>
            <span id="tax-amount">$0.00</span>
          </div>
          <div class="totals-row grand-total">
            <span>Total</span>
            <span id="grand-total">$0.00</span>
          </div>
          <div class="deposit-info" id="deposit-info">
            <div>Deposit required to begin:</div>
            <div class="deposit-amount" id="deposit-amount">$0.00</div>
          </div>
        </div>
        
        <!-- Accept Section -->
        <div class="accept-section" id="accept-section">
          <p class="text-muted mb-lg">
            By accepting this quote, you agree to the terms and authorize the payment.
          </p>
          
          <div style="max-width: 300px; margin: 0 auto var(--space-lg);">
            <label class="form-label text-center" style="color: var(--color-text-light);">Payment Amount</label>
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
              <span style="font-size: 1.25rem;">$</span>
              <input type="number" id="payment-amount" class="form-input" style="font-size: 1.25rem; text-align: center;" step="0.01" min="1">
            </div>
            <div class="text-sm text-muted mt-sm text-center">
              Minimum deposit: <span id="min-deposit">$0.00</span>
            </div>
          </div>
          
          <button class="btn btn-accent accept-btn" id="accept-btn">
            Accept Quote & Pay
          </button>
        </div>
        
        <!-- Notes Section -->
        <div id="notes-section" class="quote-section" style="display: none;">
          <div class="quote-section-header">Notes</div>
          <div class="quote-section-body" id="notes-content"></div>
        </div>
        
        <!-- Terms and Conditions Section -->
        <div id="terms-section" class="quote-section" style="display: none;">
          <div class="quote-section-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
              <polyline points="10 9 9 9 8 9"/>
            </svg>
            Terms & Conditions
          </div>
          <div class="quote-section-body" id="terms-content" style="white-space: pre-line; color: var(--color-text-light); font-size: 0.875rem; line-height: 1.6;"></div>
        </div>
        
        <!-- Video Section (About Your Project) -->
        <div id="video-section" class="quote-section" style="display: none;">
          <div class="quote-section-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="23 7 16 12 23 17 23 7"/>
              <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
            </svg>
            About Your Project
          </div>
          <div class="quote-section-body">
            <div class="video-container" id="video-container"></div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <script src="/js/utils.js"></script>
  <script src="/js/portal-auth.js"></script>
  <script>
    
    let quote = null;
    let lineItems = [];
    let attachments = [];
    let changeOrders = [];
    let payments = [];
    let packages = [];
    let selectedPackageId = null;
    let stripe = null;
    let accessToken = null;
    let isPublicAccess = false;
    
    // Get quote ID or token from URL
    const params = new URLSearchParams(window.location.search);
    const quoteId = params.get('id');
    accessToken = params.get('token');
    
    // Check for payment status
    const paymentStatus = params.get('payment');
    if (paymentStatus === 'success') {
      setTimeout(() => {
        showToast('Payment successful! Thank you.', 'success');
      }, 500);
    } else if (paymentStatus === 'cancelled') {
      setTimeout(() => {
        showToast('Payment was cancelled.', 'info');
      }, 500);
    }
    
    // Determine access mode
    if (accessToken) {
      isPublicAccess = true;
      // Skip auth check for public access
      window.skipAuthCheck = true;
    } else if (!quoteId) {
      window.location.href = '/portal/quotes.html';
    }
    
    async function loadQuote() {
      try {
        let response;
        
        if (isPublicAccess) {
          // Use public API with token
          response = await fetch(`/.netlify/functions/public-quote?token=${accessToken}`);
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to load quote');
          }
          response = await response.json();
        } else {
          // Use authenticated API
          response = await apiCall(`portal-quote?id=${quoteId}`);
        }
        
        quote = response.quote;
        lineItems = response.line_items;
        attachments = response.attachments;
        changeOrders = response.change_orders || [];
        payments = response.payments || [];
        packages = response.packages || [];
        
        renderQuote();
        
      } catch (err) {
        console.error('Failed to load quote:', err);
        showToast(err.message || 'Failed to load quote', 'error');
        
        // Show error state
        $('#loading-state').innerHTML = `
          <div class="card">
            <div class="card-body text-center" style="padding: var(--space-3xl);">
              <h3 style="color: var(--color-danger);">Unable to Load Quote</h3>
              <p class="text-muted">${err.message || 'The quote link may be invalid or expired.'}</p>
              <a href="/portal/login.html" class="btn btn-primary mt-lg">Go to Portal</a>
            </div>
          </div>
        `;
      }
    }
    
    function renderQuote() {
      $('#loading-state').style.display = 'none';
      $('#quote-content').style.display = 'block';
      
      // Hide navigation for public access
      if (isPublicAccess) {
        const nav = $('#portal-nav');
        if (nav) nav.style.display = 'none';
      }
      
      // Status banner
      const statusBanner = $('#status-banner');
      if (quote.status === 'expired') {
        statusBanner.innerHTML = '<div class="quote-expired">This quote has expired. Please contact us for a new quote.</div>';
        $('#accept-section').style.display = 'none';
      } else if (quote.status === 'accepted' || quote.status === 'converted') {
        const totalPaid = payments.reduce((sum, p) => sum + parseFloat(p.amount || 0), 0);
        let statusHtml = `<div class="quote-accepted">âœ“ Quote accepted on ${formatDate(quote.accepted_at)}`;
        if (totalPaid > 0) {
          statusHtml += ` â€¢ Deposit paid: ${formatCurrency(totalPaid)}`;
        }
        statusHtml += '</div>';
        statusBanner.innerHTML = statusHtml;
        $('#accept-section').style.display = 'none';
      } else if (quote.status === 'declined') {
        statusBanner.innerHTML = '<div class="quote-expired">This quote was declined.</div>';
        $('#accept-section').style.display = 'none';
      }
      
      // Header
      $('#quote-number').textContent = quote.quote_number;
      $('#quote-title').textContent = quote.title;
      $('#quote-date').textContent = `Valid until ${formatDate(quote.expires_at)}`;
      
      // Video
      if (quote.video_url) {
        $('#video-section').style.display = 'block';
        const videoId = extractVideoId(quote.video_url);
        if (videoId) {
          $('#video-container').innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>`;
        }
      }
      
      // Check if packages are enabled
      console.log('Quote packages_enabled:', quote.packages_enabled);
      console.log('Packages:', packages);
      console.log('Line items:', lineItems);
      
      if (quote.packages_enabled && packages && packages.length > 0) {
        // Show packages section
        $('#packages-section').style.display = 'block';
        renderPackages();
        
        // Check if a package is already selected
        selectedPackageId = quote.selected_package_id || packages.find(p => p.is_selected)?.id || null;
        if (!selectedPackageId && quote.status !== 'accepted' && quote.status !== 'converted') {
          $('#package-warning').style.display = 'flex';
        }
        
        // Also show line items if there are any additional items
        if (lineItems && lineItems.length > 0) {
          renderLineItems();
        }
      } else {
        // Show regular line items
        renderLineItems();
        
        // If packages exist but not enabled, still show them (for preview)
        if (packages && packages.length > 0) {
          $('#packages-section').style.display = 'block';
          renderPackages();
        }
      }
      
      // Attachments
      if (attachments.length > 0) {
        $('#attachments-section').style.display = 'block';
        const attachmentList = $('#attachment-list');
        attachments.forEach(att => {
          const icon = getFileIcon(att.file_type);
          const item = createElement('a', {
            className: 'attachment-item',
            href: att.file_url,
            target: '_blank',
            innerHTML: `${icon} ${att.file_name}`
          });
          attachmentList.appendChild(item);
        });
      }
      
      // Notes
      if (quote.notes) {
        $('#notes-section').style.display = 'block';
        $('#notes-content').textContent = quote.notes;
      }
      
      // Render declined options (optional items not selected)
      renderDeclinedOptions();
      
      // Render change orders
      renderChangeOrders();
      
      // Render payment history
      renderPayments();
      
      // Load and display terms
      loadTerms();
      
      // Calculate totals
      updateTotals();
    }
    
    function renderDeclinedOptions() {
      // Only show declined options after quote has been accepted
      if (!['accepted', 'converted'].includes(quote.status)) {
        $('#declined-options-section').style.display = 'none';
        return;
      }
      
      const declinedItems = lineItems.filter(item => item.is_optional && !item.is_selected);
      
      if (declinedItems.length === 0) {
        $('#declined-options-section').style.display = 'none';
        return;
      }
      
      $('#declined-options-section').style.display = 'block';
      const container = $('#declined-options-container');
      clearElement(container);
      
      declinedItems.forEach(item => {
        const itemEl = createElement('div', { className: 'line-item declined-item' });
        
        // Empty action cell
        itemEl.appendChild(createElement('div', { className: 'line-item-action' }));
        
        // Photo or placeholder
        if (item.photo_url) {
          itemEl.appendChild(createElement('img', { className: 'line-item-photo', src: item.photo_url, alt: item.description }));
        } else {
          itemEl.appendChild(createElement('div', { className: 'line-item-photo-placeholder', innerHTML: 'ðŸ“¦' }));
        }
        
        // Content
        const contentDiv = createElement('div', { className: 'line-item-content' });
        contentDiv.appendChild(createElement('h4', { textContent: item.description }));
        if (item.details) contentDiv.appendChild(createElement('p', { textContent: item.details }));
        itemEl.appendChild(contentDiv);
        
        // Price
        const priceCell = createElement('div', { className: 'line-item-price' });
        priceCell.appendChild(createElement('div', { className: 'line-item-price-value', textContent: formatCurrency(item.line_total || 0) }));
        itemEl.appendChild(priceCell);
        
        container.appendChild(itemEl);
      });
    }
    
    function renderChangeOrders() {
      if (changeOrders.length === 0) {
        $('#change-orders-section').style.display = 'none';
        return;
      }
      
      $('#change-orders-section').style.display = 'block';
      const container = $('#change-orders-section');
      clearElement(container);
      
      changeOrders.forEach(co => {
        const items = co.change_order_items || [];
        const isPending = ['sent', 'viewed'].includes(co.status);
        const isAccepted = co.status === 'accepted';
        const isDeclined = co.status === 'declined';
        
        const card = createElement('div', { className: 'change-order-card' });
        
        // Header
        const header = createElement('div', { className: 'change-order-header' });
        const titleDiv = createElement('div', { className: 'change-order-title' });
        titleDiv.innerHTML = `Change Order #${co.change_order_number}`;
        
        let badgeClass = 'pending';
        let badgeText = 'Awaiting Response';
        if (isAccepted) {
          badgeClass = 'accepted';
          badgeText = `Accepted â€“ on ${formatDate(co.accepted_at)}`;
        } else if (isDeclined) {
          badgeClass = 'declined';
          badgeText = 'Declined';
        }
        
        header.appendChild(titleDiv);
        header.appendChild(createElement('span', { className: `change-order-badge ${badgeClass}`, textContent: badgeText }));
        card.appendChild(header);
        
        // Body with items
        const body = createElement('div', { className: 'change-order-body' });
        
        let subtotal = 0;
        items.forEach(item => {
          const qty = item.quantity || 1;
          const price = item.unit_price || 0;
          const total = qty * price;
          subtotal += total;
          
          const itemRow = createElement('div', { className: 'change-order-item' });
          itemRow.innerHTML = `
            <div>
              <strong>${item.description}</strong>
              <span style="color: var(--color-text-muted); margin-left: var(--space-sm);">${qty} Ã— ${formatCurrency(price)}</span>
            </div>
            <div>${formatCurrency(total)}</div>
          `;
          body.appendChild(itemRow);
        });
        
        // Total
        const taxRate = parseFloat(quote.tax_rate || 0);
        const tax = subtotal * taxRate;
        const total = subtotal + tax;
        
        const totalDiv = createElement('div', { className: 'change-order-total' });
        totalDiv.innerHTML = `<span>Total</span><span>${formatCurrency(total)}</span>`;
        body.appendChild(totalDiv);
        
        // Actions for pending change orders
        if (isPending) {
          const actionsDiv = createElement('div', { className: 'change-order-actions' });
          
          const acceptBtn = createElement('button', { className: 'btn btn-primary', textContent: 'Accept Change Order' });
          acceptBtn.onclick = () => respondToChangeOrder(co.id, 'accept');
          
          const declineBtn = createElement('button', { className: 'btn btn-secondary', textContent: 'Decline' });
          declineBtn.onclick = () => respondToChangeOrder(co.id, 'decline');
          
          actionsDiv.appendChild(acceptBtn);
          actionsDiv.appendChild(declineBtn);
          body.appendChild(actionsDiv);
        }
        
        card.appendChild(body);
        container.appendChild(card);
      });
    }
    
    async function respondToChangeOrder(changeOrderId, action) {
      if (action === 'decline' && !confirm('Are you sure you want to decline this change order?')) {
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/change-order-response', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: accessToken, change_order_id: changeOrderId, action })
        });
        
        if (!response.ok) throw new Error('Failed to process response');
        
        // Update local state
        const co = changeOrders.find(c => c.id === changeOrderId);
        if (co) {
          co.status = action === 'accept' ? 'accepted' : 'declined';
          if (action === 'accept') co.accepted_at = new Date().toISOString();
        }
        
        // Re-render
        renderChangeOrders();
        updateTotals();
        
        showToast(action === 'accept' ? 'Change order accepted!' : 'Change order declined', 'success');
        
      } catch (err) {
        console.error(err);
        showToast('Failed to process response', 'error');
      }
    }
    
    function renderPayments() {
      if (payments.length === 0) {
        $('#payment-history-section').style.display = 'none';
        return;
      }
      
      $('#payment-history-section').style.display = 'block';
      const container = $('#payment-history-body');
      clearElement(container);
      
      let totalPaid = 0;
      
      payments.forEach(payment => {
        const amount = parseFloat(payment.amount || 0);
        totalPaid += amount;
        
        const paymentEl = createElement('div', { className: 'payment-item' });
        
        const infoDiv = createElement('div', { className: 'payment-item-info' });
        infoDiv.innerHTML = `
          <div class="payment-item-date">${formatDate(payment.created_at)}</div>
          <div class="payment-item-method">${payment.payment_method || 'Card'} ${payment.stripe_payment_id ? 'â€¢ ' + payment.stripe_payment_id.substring(0, 12) + '...' : ''}</div>
        `;
        
        const amountDiv = createElement('div', { className: 'payment-item-amount', textContent: formatCurrency(amount) });
        
        paymentEl.appendChild(infoDiv);
        paymentEl.appendChild(amountDiv);
        container.appendChild(paymentEl);
      });
      
      // Add total summary
      const summaryEl = createElement('div', { className: 'payment-summary' });
      summaryEl.innerHTML = `
        <span class="payment-summary-label">Total Paid</span>
        <span class="payment-summary-value">${formatCurrency(totalPaid)}</span>
      `;
      container.appendChild(summaryEl);
    }
    
    async function loadTerms() {
      try {
        const { data, error } = await supabase
          .from('settings')
          .select('value')
          .eq('key', 'terms_and_conditions')
          .single();
        
        if (data && data.value && data.value.quote) {
          $('#terms-section').style.display = 'block';
          $('#terms-content').textContent = data.value.quote;
        }
      } catch (err) {
        console.log('Terms not configured');
      }
    }
    
    function renderLineItems() {
      const container = $('#line-items-container');
      clearElement(container);
      
      // Sort: required items first, then optional
      const sortedItems = [...lineItems].sort((a, b) => {
        const aOpt = a.is_optional === true;
        const bOpt = b.is_optional === true;
        if (aOpt === bOpt) return (a.sort_order || 0) - (b.sort_order || 0);
        return aOpt ? 1 : -1;
      });
      
      sortedItems.forEach(item => {
        const isOptional = item.is_optional === true;
        const isSelected = item.is_selected === true;
        const isSelectable = isOptional && ['sent', 'viewed'].includes(quote.status);
        const itemId = item.id;
        
        const itemEl = createElement('div', {
          className: `line-item ${isOptional ? 'optional' : ''} ${isSelected ? 'selected' : ''}`,
          dataset: { id: itemId }
        });
        
        // Action button cell (for optional items)
        const actionCell = createElement('div', { className: 'line-item-action' });
        if (isOptional) {
          const btn = document.createElement('button');
          btn.className = `btn btn-sm ${isSelected ? 'btn-danger' : 'btn-primary'}`;
          btn.textContent = isSelected ? 'Remove' : 'Add';
          btn.disabled = !isSelectable;
          btn.dataset.itemId = itemId;
          btn.dataset.action = 'toggle-optional';
          actionCell.appendChild(btn);
        }
        itemEl.appendChild(actionCell);
        
        // Photo
        if (item.photo_url) {
          const photo = createElement('img', {
            className: 'line-item-photo',
            src: item.photo_url,
            alt: item.description,
            onClick: () => showImageModal(item.photo_url)
          });
          itemEl.appendChild(photo);
        } else {
          const placeholder = createElement('div', {
            className: 'line-item-photo-placeholder',
            innerHTML: '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>'
          });
          itemEl.appendChild(placeholder);
        }
        
        // Content
        const content = createElement('div', { className: 'line-item-content' });
        const title = createElement('h4', { textContent: item.description });
        if (isOptional) {
          title.innerHTML += '<span class="optional-badge">Optional</span>';
        }
        content.appendChild(title);
        
        if (item.details) {
          content.appendChild(createElement('div', { className: 'line-item-details', textContent: item.details }));
        }
        if (item.quantity > 1) {
          content.appendChild(createElement('div', { className: 'line-item-details', textContent: `Qty: ${item.quantity}` }));
        }
        itemEl.appendChild(content);
        
        // Price
        const priceCell = createElement('div', { className: 'line-item-price' });
        if (item.is_range_pricing) {
          priceCell.appendChild(createElement('div', { 
            className: 'line-item-price-value',
            textContent: formatCurrencyRange(item.line_total_low, item.line_total_high)
          }));
          priceCell.appendChild(createElement('div', {
            className: 'line-item-price-range',
            textContent: 'Range estimate'
          }));
        } else {
          priceCell.appendChild(createElement('div', {
            className: 'line-item-price-value',
            textContent: formatCurrency(item.line_total)
          }));
        }
        itemEl.appendChild(priceCell);
        
        container.appendChild(itemEl);
      });
    }
    
    function toggleOption(itemId, selected) {
      const item = lineItems.find(i => i.id === itemId);
      if (item) {
        item.is_selected = selected;
        
        // Update UI
        const itemEl = $(`.line-item[data-id="${itemId}"]`);
        if (itemEl) {
          itemEl.classList.toggle('selected', selected);
        }
        
        updateTotals();
        
        // Save selection to server
        if (isPublicAccess) {
          fetch('/.netlify/functions/public-quote-selection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: accessToken, item_id: itemId, is_selected: selected })
          }).catch(() => {});
        } else {
          apiCall('portal-quote-selection', {
            method: 'POST',
            body: JSON.stringify({ quote_id: quote.id, item_id: itemId, selected })
          }).catch(() => {});
        }
      }
    }
    
    function renderPackages() {
      const container = $('#packages-grid');
      clearElement(container);
      
      // Sort packages by sort_order
      const sortedPackages = [...packages].sort((a, b) => (a.sort_order || 0) - (b.sort_order || 0));
      
      sortedPackages.forEach(pkg => {
        const isSelected = pkg.id === selectedPackageId || pkg.is_selected;
        const total = pkg.price || pkg.items.filter(i => i.is_included).reduce((sum, item) => sum + (item.quantity * item.price), 0);
        
        // Filter items to show
        const itemsToShow = pkg.hide_non_included 
          ? pkg.items.filter(i => i.is_included)
          : pkg.items;
        
        const card = createElement('div', {
          className: `package-card ${pkg.is_recommended ? 'recommended' : ''} ${isSelected ? 'selected' : ''}`,
          dataset: { packageId: pkg.id }
        });
        
        // Radio button indicator
        card.innerHTML = `
          <div class="package-radio"></div>
          ${pkg.is_recommended ? '<div class="package-recommended-badge">Recommended</div>' : ''}
          <div class="package-name">${pkg.name}</div>
          ${pkg.description ? `<div class="package-description">${pkg.description}</div>` : '<div class="package-description"></div>'}
          <div class="package-price"><sup>$</sup>${formatNumber(total)}</div>
          <div class="package-items-list">
            ${itemsToShow.map(item => `
              <div class="package-item ${!item.is_included ? 'excluded' : ''}">
                <div class="package-item-name">
                  ${item.name}
                  ${item.description ? `<span class="info-icon" title="${item.description}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                  </span>` : ''}
                </div>
                <div class="package-item-price">
                  ${item.is_included ? formatCurrency(item.price * item.quantity) : ''}
                  ${!item.is_included ? '<span style="color: var(--color-danger);">âœ•</span>' : ''}
                </div>
              </div>
            `).join('')}
          </div>
          <button class="package-select-btn" onclick="selectPackage('${pkg.id}')">
            ${isSelected ? 'Selected<br><small>(click to remove)</small>' : 'Select Bundle'}
          </button>
        `;
        
        // Make whole card clickable
        card.addEventListener('click', (e) => {
          if (!e.target.closest('.package-select-btn')) {
            selectPackage(pkg.id);
          }
        });
        
        container.appendChild(card);
      });
      
      // Update totals based on selected package
      updateTotals();
    }
    
    function selectPackage(packageId) {
      // Toggle selection
      if (selectedPackageId === packageId) {
        selectedPackageId = null;
      } else {
        selectedPackageId = packageId;
      }
      
      // Update UI
      $$('.package-card').forEach(card => {
        const isSelected = card.dataset.packageId === selectedPackageId;
        card.classList.toggle('selected', isSelected);
        const btn = card.querySelector('.package-select-btn');
        if (btn) {
          btn.innerHTML = isSelected ? 'Selected<br><small>(click to remove)</small>' : 'Select Bundle';
        }
      });
      
      // Update warning message
      const warning = $('#package-warning');
      if (warning) {
        warning.style.display = selectedPackageId ? 'none' : 'flex';
      }
      
      // Update totals
      updateTotals();
      
      // Save selection to server
      if (isPublicAccess) {
        fetch('/.netlify/functions/public-quote-selection', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: accessToken, package_id: selectedPackageId })
        }).catch(() => {});
      } else {
        apiCall('portal-quote-selection', {
          method: 'POST',
          body: JSON.stringify({ quote_id: quote.id, package_id: selectedPackageId })
        }).catch(() => {});
      }
    }
    
    function formatNumber(num) {
      return num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }
    
    function updateTotals() {
      let subtotal = 0;
      let subtotalLow = 0;
      let subtotalHigh = 0;
      let taxableSubtotal = 0;
      let taxableSubtotalLow = 0;
      let taxableSubtotalHigh = 0;
      let hasRange = false;
      
      // If packages are enabled and one is selected, calculate from package
      if (quote.packages_enabled && packages.length > 0) {
        const selectedPkg = packages.find(p => p.id === selectedPackageId);
        if (selectedPkg) {
          // Calculate package total
          const pkgTotal = selectedPkg.price || selectedPkg.items
            .filter(i => i.is_included)
            .reduce((sum, item) => sum + (item.quantity * item.price), 0);
          
          subtotal = pkgTotal;
          subtotalLow = pkgTotal;
          subtotalHigh = pkgTotal;
          
          // Handle package tax
          if (selectedPkg.apply_tax) {
            taxableSubtotal = pkgTotal;
            taxableSubtotalLow = pkgTotal;
            taxableSubtotalHigh = pkgTotal;
          }
        }
        
        // Also add any selected optional line items (add-ons)
        lineItems.forEach(item => {
          const isOptional = item.is_optional === true;
          const isSelected = item.is_selected === true;
          const isTaxable = item.is_taxable === true;
          
          // Only add optional items that are selected
          if (isOptional && isSelected) {
            const total = parseFloat(item.line_total || 0);
            subtotal += total;
            subtotalLow += total;
            subtotalHigh += total;
            if (isTaxable) {
              taxableSubtotal += total;
              taxableSubtotalLow += total;
              taxableSubtotalHigh += total;
            }
          }
        });
      } else {
        // Standard line items calculation
        lineItems.forEach(item => {
          const isOptional = item.is_optional === true;
          const isSelected = item.is_selected === true;
          const isTaxable = item.is_taxable === true;
          
          if (!isOptional || isSelected) {
            if (item.is_range_pricing) {
              hasRange = true;
              const lowTotal = parseFloat(item.line_total_low || 0);
              const highTotal = parseFloat(item.line_total_high || 0);
              subtotalLow += lowTotal;
              subtotalHigh += highTotal;
              if (isTaxable) {
                taxableSubtotalLow += lowTotal;
                taxableSubtotalHigh += highTotal;
              }
            } else {
              const total = parseFloat(item.line_total || 0);
              subtotal += total;
              subtotalLow += total;
              subtotalHigh += total;
              if (isTaxable) {
                taxableSubtotal += total;
                taxableSubtotalLow += total;
                taxableSubtotalHigh += total;
              }
            }
          }
        });
      }
      
      // Add accepted change orders to totals
      changeOrders.forEach(co => {
        if (co.status === 'accepted') {
          const items = co.change_order_items || [];
          items.forEach(item => {
            const qty = item.quantity || 1;
            const price = item.unit_price || 0;
            const total = qty * price;
            subtotal += total;
            subtotalLow += total;
            subtotalHigh += total;
            // Change order items are always taxable
            taxableSubtotal += total;
            taxableSubtotalLow += total;
            taxableSubtotalHigh += total;
          });
        }
      });
      
      const taxRate = parseFloat(quote.tax_rate || 0);
      const taxAmount = taxableSubtotal * taxRate;
      const taxAmountLow = taxableSubtotalLow * taxRate;
      const taxAmountHigh = taxableSubtotalHigh * taxRate;
      
      const grandTotal = subtotal + taxAmount;
      const grandTotalLow = subtotalLow + taxAmountLow;
      const grandTotalHigh = subtotalHigh + taxAmountHigh;
      
      // Update display
      if (hasRange) {
        $('#subtotal').textContent = formatCurrencyRange(subtotalLow, subtotalHigh);
        $('#grand-total').textContent = formatCurrencyRange(grandTotalLow, grandTotalHigh);
      } else {
        $('#subtotal').textContent = formatCurrency(subtotal);
        $('#grand-total').textContent = formatCurrency(grandTotal);
      }
      
      if (taxRate > 0) {
        $('#tax-row').style.display = 'flex';
        $('#tax-rate').textContent = (taxRate * 100).toFixed(2);
        $('#tax-amount').textContent = hasRange ? formatCurrencyRange(taxAmountLow, taxAmountHigh) : formatCurrency(taxAmount);
      }
      
      // Deposit calculation (based on lower estimate for ranges)
      let depositAmount;
      if (quote.deposit_type === 'percentage') {
        depositAmount = (hasRange ? grandTotalLow : grandTotal) * (parseFloat(quote.deposit_value) / 100);
      } else {
        depositAmount = parseFloat(quote.deposit_value || 0);
      }
      
      // Store minimum deposit for validation
      window.minDepositAmount = depositAmount;
      
      $('#deposit-amount').textContent = formatCurrency(depositAmount);
      $('#min-deposit').textContent = formatCurrency(depositAmount);
      
      // Set payment amount input to deposit amount (default)
      const paymentInput = $('#payment-amount');
      if (paymentInput) {
        paymentInput.min = depositAmount.toFixed(2);
        if (!paymentInput.dataset.userModified) {
          paymentInput.value = depositAmount.toFixed(2);
        }
      }
    }
    
    function showImageModal(imageUrl) {
      const modal = createElement('div', {
        className: 'image-modal',
        onClick: (e) => { if (e.target === modal) modal.remove(); }
      }, [
        createElement('img', { src: imageUrl })
      ]);
      document.body.appendChild(modal);
    }
    
    function extractVideoId(url) {
      const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
      return match ? match[1] : null;
    }
    
    function getFileIcon(fileType) {
      if (fileType?.includes('pdf')) {
        return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>';
      }
      if (fileType?.includes('image')) {
        return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>';
      }
      return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/><path d="M13 2v7h7"/></svg>';
    }
    
    // Track when user modifies payment amount
    $('#payment-amount').addEventListener('input', function() {
      this.dataset.userModified = 'true';
    });
    
    // Accept quote button
    $('#accept-btn').addEventListener('click', async () => {
      const btn = $('#accept-btn');
      const paymentAmount = Math.round(parseFloat($('#payment-amount').value) * 100) / 100;
      const minDeposit = Math.round((window.minDepositAmount || 0) * 100) / 100;
      
      // Validate payment amount (use small epsilon for floating point comparison)
      if (!paymentAmount || paymentAmount < minDeposit - 0.01) {
        showToast(`Minimum payment is ${formatCurrency(minDeposit)}`, 'error');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Processing...';
      
      try {
        // Get selected options
        const selectedOptions = lineItems
          .filter(i => i.is_optional === true && i.is_selected === true)
          .map(i => i.id);
        
        let response;
        
        if (isPublicAccess) {
          // Use public checkout API
          const res = await fetch('/.netlify/functions/public-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              token: accessToken,
              selected_options: selectedOptions,
              payment_amount: paymentAmount
            })
          });
          
          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || 'Failed to create checkout');
          }
          response = await res.json();
        } else {
          // Use authenticated API
          response = await apiCall('create-checkout', {
            method: 'POST',
            body: JSON.stringify({
              quote_id: quote.id,
              selected_options: selectedOptions,
              payment_amount: paymentAmount
            })
          });
        }
        
        // Redirect to Stripe
        if (response.url) {
          window.location.href = response.url;
        } else {
          throw new Error('Failed to create checkout session');
        }
        
      } catch (err) {
        console.error('Checkout error:', err);
        showToast(err.message || 'Failed to process. Please try again.', 'error');
        btn.disabled = false;
        btn.textContent = 'Accept Quote & Pay';
      }
    });
    
    // Event delegation for optional item buttons
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('[data-action="toggle-optional"]');
      if (!btn) return;
      
      const itemId = btn.dataset.itemId;
      
      // Find the item in lineItems
      const item = lineItems.find(i => i.id === itemId);
      if (!item) return;
      
      // Toggle selection
      const nowSelected = !(item.is_selected === true);
      item.is_selected = nowSelected;
      
      // Re-render line items and update totals
      renderLineItems();
      updateTotals();
      
      // Save to server
      if (isPublicAccess) {
        fetch('/.netlify/functions/public-quote-selection', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: accessToken, item_id: itemId, is_selected: nowSelected })
        }).catch(() => {});
      } else {
        apiCall('portal-quote-selection', {
          method: 'POST',
          body: JSON.stringify({ quote_id: quote.id, item_id: itemId, selected: nowSelected })
        }).catch(() => {});
      }
    });
    
    // Initialize
    loadQuote();
  </script>
</body>
</html>
