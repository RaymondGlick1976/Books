<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quotes | Admin | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css?v=36">
</head>
<body>
  <div class="app-layout">
    <aside class="app-sidebar">
      <div class="sidebar-logo">
        <img src="/images/logo.gif" alt="Homestead Cabinet Design" style="height: 40px; filter: brightness(0) invert(1);">
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item"><a href="/admin/index.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard</a></li>
          <li class="sidebar-nav-item"><a href="/admin/pipeline.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Deals Pipeline</a></li>
          <li class="sidebar-nav-item"><a href="/admin/customers.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Customers</a></li>
          <li class="sidebar-nav-item"><a href="/admin/quotes.html" class="sidebar-nav-link active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>Quotes</a></li>
          <li class="sidebar-nav-item"><a href="/admin/invoices.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>Invoices</a></li>
        </ul>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Lead Capture</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/booking-forms.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>Booking Forms</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Catalog</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/catalog.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>Items Catalog</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/settings.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</a></li>
          </ul>
        </div>
      </nav>
    </aside>
    
    <main class="app-main">
      <header class="app-header">
        <h2>Quotes</h2>
        <a href="/admin/quote-builder.html" class="btn btn-primary">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          New Quote
        </a>
      </header>
      
      <div class="app-content">
        <!-- Filters -->
        <div class="card mb-xl">
          <div class="card-body">
            <div class="flex gap-md items-center">
              <input type="text" id="search-input" class="form-input" placeholder="Search quotes..." style="max-width: 300px;">
              <select id="status-filter" class="form-select" style="max-width: 150px;">
                <option value="">All Status</option>
                <option value="draft">Draft</option>
                <option value="sent">Sent</option>
                <option value="viewed">Viewed</option>
                <option value="accepted">Accepted</option>
                <option value="declined">Declined</option>
                <option value="expired">Expired</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Quotes Table -->
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Quote #</th>
                  <th>Customer</th>
                  <th>Title</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Expires</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="quotes-tbody">
                <tr>
                  <td colspan="8" style="text-align: center; padding: 40px;">
                    <div class="loading-spinner" style="margin: 0 auto;"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script src="/js/utils.js"></script>
  <script>
    let quotes = [];
    
    async function loadQuotes() {
      try {
        const supabase = await app.waitForSupabase();
        
        const { data, error } = await supabase
          .from('quotes')
          .select('*, customers(name, email)')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        quotes = data || [];
        renderQuotes(quotes);
      } catch (err) {
        console.error('Load error:', err);
        showToast('Failed to load quotes', 'error');
      }
    }
    
    function renderQuotes(data) {
      const tbody = $('#quotes-tbody');
      clearElement(tbody);
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted p-xl">No quotes found</td></tr>';
        return;
      }
      
      data.forEach(quote => {
        const hasRange = quote.total_low && quote.total_high && quote.total_low !== quote.total_high;
        
        const row = createElement('tr');
        row.innerHTML = `
          <td><a href="/admin/quote-detail.html?id=${quote.id}" style="color: var(--color-primary); font-weight: 600;">${quote.quote_number}</a></td>
          <td>
            <div>${quote.customers?.name || '—'}</div>
            <div class="text-sm text-muted">${quote.customers?.email || ''}</div>
          </td>
          <td>${quote.title}</td>
          <td>${hasRange ? formatCurrencyRange(quote.total_low, quote.total_high) : formatCurrency(quote.total)}</td>
          <td><span class="badge badge-${quote.status}">${quote.status}</span></td>
          <td>${formatDate(quote.created_at)}</td>
          <td>${quote.expires_at ? formatDate(quote.expires_at) : '—'}</td>
          <td class="table-actions">
            <a href="/admin/quote-detail.html?id=${quote.id}" class="btn btn-ghost btn-sm">View</a>
            <a href="/admin/quote-builder.html?id=${quote.id}" class="btn btn-ghost btn-sm">Edit</a>
            <button class="btn btn-ghost btn-sm" onclick="duplicateQuote('${quote.id}')">Duplicate</button>
            ${quote.status === 'accepted' ? `<button class="btn btn-ghost btn-sm" onclick="createInvoice('${quote.id}')">→ Invoice</button>` : ''}
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    
    // Search & Filter
    const searchInput = $('#search-input');
    const statusFilter = $('#status-filter');
    
    function applyFilters() {
      const query = searchInput.value.toLowerCase();
      const status = statusFilter.value;
      
      let filtered = quotes;
      
      if (query) {
        filtered = filtered.filter(q => 
          q.quote_number.toLowerCase().includes(query) ||
          q.title.toLowerCase().includes(query) ||
          q.customers?.name?.toLowerCase().includes(query) ||
          q.customers?.email?.toLowerCase().includes(query)
        );
      }
      
      if (status) {
        filtered = filtered.filter(q => q.status === status);
      }
      
      renderQuotes(filtered);
    }
    
    searchInput.addEventListener('input', debounce(applyFilters, 300));
    statusFilter.addEventListener('change', applyFilters);
    
    window.duplicateQuote = async (id) => {
      const quote = quotes.find(q => q.id === id);
      if (!quote) return;
      
      try {
        const supabase = await app.waitForSupabase();
        
        // Get line items
        const { data: lineItems } = await supabase
          .from('quote_line_items')
          .select('*')
          .eq('quote_id', id);
        
        // Generate new quote number
        const { data: quoteNumber } = await supabase.rpc('generate_quote_number');
        
        // Create duplicate quote
        const { data: newQuote, error } = await supabase
          .from('quotes')
          .insert({
            quote_number: quoteNumber,
            customer_id: quote.customer_id,
            title: quote.title + ' (Copy)',
            description: quote.description,
            quote_type: quote.quote_type,
            status: 'draft',
            valid_days: quote.valid_days,
            expires_at: new Date(Date.now() + quote.valid_days * 24 * 60 * 60 * 1000).toISOString(),
            deposit_type: quote.deposit_type,
            deposit_value: quote.deposit_value,
            video_url: quote.video_url,
            notes: quote.notes,
            internal_notes: quote.internal_notes,
            tax_rate: quote.tax_rate,
            subtotal: quote.subtotal,
            subtotal_low: quote.subtotal_low,
            subtotal_high: quote.subtotal_high,
            tax_amount: quote.tax_amount,
            total: quote.total,
            total_low: quote.total_low,
            total_high: quote.total_high
          })
          .select()
          .single();
        
        if (error) throw error;
        
        // Copy line items
        if (lineItems?.length) {
          await supabase.from('quote_line_items').insert(
            lineItems.map(item => ({
              ...item,
              id: undefined,
              quote_id: newQuote.id
            }))
          );
        }
        
        showToast('Quote duplicated', 'success');
        window.location.href = `/admin/quote-builder.html?id=${newQuote.id}`;
      } catch (err) {
        showToast('Failed to duplicate: ' + err.message, 'error');
      }
    };
    
    window.createInvoice = async (quoteId) => {
      if (!confirm('Create an invoice from this quote?')) return;
      
      try {
        const supabase = await app.waitForSupabase();
        const quote = quotes.find(q => q.id === quoteId);
        
        // Get line items
        const { data: lineItems } = await supabase
          .from('quote_line_items')
          .select('*')
          .eq('quote_id', quoteId);
        
        // Get accepted change orders with items
        const { data: changeOrders } = await supabase
          .from('change_orders')
          .select('*, change_order_items(*)')
          .eq('quote_id', quoteId)
          .eq('status', 'accepted');
        
        // Calculate totals including change orders
        let subtotal = 0;
        let taxableSubtotal = 0;
        const taxRate = quote.tax_rate || 0;
        
        // Selected line items
        const selectedItems = (lineItems || []).filter(i => !i.is_optional || i.is_selected);
        selectedItems.forEach(item => {
          const lineTotal = (item.unit_price || item.price_range_low || 0) * item.quantity;
          subtotal += lineTotal;
          if (item.is_taxable) taxableSubtotal += lineTotal;
        });
        
        // Change order items
        const changeOrderItems = [];
        (changeOrders || []).forEach(co => {
          (co.change_order_items || []).forEach(item => {
            const lineTotal = (item.unit_price || 0) * (item.quantity || 1);
            subtotal += lineTotal;
            taxableSubtotal += lineTotal;
            changeOrderItems.push({
              description: item.description,
              details: `Change Order #${co.change_order_number}`,
              quantity: item.quantity || 1,
              unit_price: item.unit_price || 0,
              line_total: lineTotal,
              is_taxable: true
            });
          });
        });
        
        const taxAmount = taxableSubtotal * taxRate;
        const total = subtotal + taxAmount;
        
        // Generate invoice number
        const { data: invoiceNumber } = await supabase.rpc('generate_invoice_number');
        
        // Create invoice
        const { data: invoice, error } = await supabase
          .from('invoices')
          .insert({
            invoice_number: invoiceNumber,
            quote_id: quoteId,
            customer_id: quote.customer_id,
            title: quote.title,
            status: 'draft',
            subtotal: subtotal,
            tax_rate: taxRate,
            tax_amount: taxAmount,
            total: total,
            amount_due: total,
            due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
          })
          .select()
          .single();
        
        if (error) throw error;
        
        // Copy line items to invoice
        const allInvoiceItems = [];
        
        selectedItems.forEach((item, index) => {
          allInvoiceItems.push({
            invoice_id: invoice.id,
            description: item.description,
            details: item.details,
            quantity: item.quantity,
            unit_price: item.unit_price || item.price_range_low,
            line_total: (item.unit_price || item.price_range_low) * item.quantity,
            is_taxable: item.is_taxable,
            sort_order: index
          });
        });
        
        changeOrderItems.forEach((item, index) => {
          allInvoiceItems.push({
            invoice_id: invoice.id,
            description: item.description,
            details: item.details,
            quantity: item.quantity,
            unit_price: item.unit_price,
            line_total: item.line_total,
            is_taxable: item.is_taxable,
            sort_order: selectedItems.length + index
          });
        });
        
        if (allInvoiceItems.length > 0) {
          await supabase.from('invoice_line_items').insert(allInvoiceItems);
        }
        
        // Update quote status
        await supabase.from('quotes').update({ status: 'converted' }).eq('id', quoteId);
        
        showToast('Invoice created', 'success');
        window.location.href = '/admin/invoices.html';
      } catch (err) {
        showToast('Failed to create invoice: ' + err.message, 'error');
      }
    };
    
    window.approveQuote = async (id) => {
      if (!confirm('Manually approve this quote? This will mark it as accepted.')) return;
      
      try {
        const supabase = await app.waitForSupabase();
        
        await supabase
          .from('quotes')
          .update({ 
            status: 'accepted',
            accepted_at: new Date().toISOString()
          })
          .eq('id', id);
        
        showToast('Quote approved', 'success');
        loadQuotes();
      } catch (err) {
        showToast('Failed to approve: ' + err.message, 'error');
      }
    };
    
    // Initialize
    loadQuotes();
  </script>
</body>
</html>
