<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customers | Admin | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css?v=37">
  <style>
    .import-dropzone {
      border: 2px dashed var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-2xl);
      text-align: center;
      cursor: pointer;
      transition: all var(--transition-fast);
      background: var(--color-bg-soft);
    }
    
    .import-dropzone:hover, .import-dropzone.dragover {
      border-color: var(--color-primary);
      background: var(--color-primary-soft);
    }
    
    .import-dropzone-icon {
      font-size: 3rem;
      margin-bottom: var(--space-md);
    }
    
    .import-preview {
      max-height: 300px;
      overflow: auto;
      margin-top: var(--space-lg);
    }
    
    .import-preview table {
      font-size: 0.75rem;
    }
    
    .import-preview th {
      position: sticky;
      top: 0;
      background: var(--color-bg-soft);
    }
    
    .mapping-row {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--color-border-light);
    }
    
    .mapping-row:last-child {
      border-bottom: none;
    }
    
    .mapping-source {
      flex: 1;
      font-weight: 500;
      font-size: 0.875rem;
    }
    
    .mapping-arrow {
      color: var(--color-text-muted);
    }
    
    .mapping-target {
      flex: 1;
    }
    
    .import-stats {
      display: flex;
      gap: var(--space-xl);
      padding: var(--space-lg);
      background: var(--color-bg-soft);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-lg);
    }
    
    .import-stat {
      text-align: center;
    }
    
    .import-stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--color-primary);
    }
    
    .import-stat-label {
      font-size: 0.75rem;
      color: var(--color-text-muted);
    }
  </style>
</head>
<body>
  <script>
    // Permission check before page loads
    const user = JSON.parse(localStorage.getItem('app_user') || 'null');
    if (!user) {
      window.location.href = '/admin/login.html';
    } else if (!user.permissions?.can_view_customers) {
      window.location.href = user.permissions?.can_view_pipeline ? '/admin/pipeline.html' : '/admin/index.html';
    }
  </script>
  <div class="app-layout">
    <aside class="app-sidebar">
      <div class="sidebar-logo">
        <img src="/images/logo.gif" alt="Homestead Cabinet Design" style="height: 40px; filter: brightness(0) invert(1);">
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item"><a href="/admin/index.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard</a></li>
          <li class="sidebar-nav-item"><a href="/admin/pipeline.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Deals Pipeline</a></li>
          <li class="sidebar-nav-item"><a href="/admin/customers.html" class="sidebar-nav-link active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Customers</a></li>
          <li class="sidebar-nav-item"><a href="/admin/quotes.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>Quotes</a></li>
          <li class="sidebar-nav-item"><a href="/admin/invoices.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>Invoices</a></li>
        </ul>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Lead Capture</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/booking-forms.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>Booking Forms</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Catalog</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/catalog.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>Items Catalog</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/settings.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</a></li>
          </ul>
        </div>
      </nav>
    </aside>
    
    <main class="app-main">
      <header class="app-header">
        <h2>Customers</h2>
        <div class="btn-group">
          <button class="btn btn-secondary" id="import-csv-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Import CSV
          </button>
          <button class="btn btn-primary" id="add-customer-btn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add Customer
          </button>
        </div>
      </header>
      
      <div class="app-content">
        <!-- Search -->
        <div class="card mb-xl">
          <div class="card-body">
            <div class="flex gap-md">
              <input type="text" id="search-input" class="form-input" placeholder="Search customers..." style="max-width: 400px;">
            </div>
          </div>
        </div>
        
        <!-- Customers Table -->
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Location</th>
                  <th>Lead Source</th>
                  <th>Quotes</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="customers-tbody">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 40px;">
                    <div class="loading-spinner" style="margin: 0 auto;"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script src="/js/utils.js"></script>
  <script>
    let customers = [];
    let leadSources = [];
    
    async function loadLeadSources() {
      try {
        const supabase = await app.waitForSupabase();
        const { data } = await supabase
          .from('lead_sources')
          .select('*')
          .eq('is_active', true)
          .order('sort_order');
        leadSources = data || [];
      } catch (err) {
        console.error('Failed to load lead sources:', err);
        leadSources = [];
      }
    }
    
    async function loadCustomers() {
      try {
        const supabase = await app.waitForSupabase();
        
        const { data, error } = await supabase
          .from('customers')
          .select(`
            *,
            quotes:quotes(count),
            invoices:invoices(amount_due)
          `)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        customers = data || [];
        renderCustomers(customers);
      } catch (err) {
        console.error('Load error:', err);
        showToast('Failed to load customers', 'error');
      }
    }
    
    function renderCustomers(data) {
      const tbody = $('#customers-tbody');
      clearElement(tbody);
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted p-xl">No customers found</td></tr>';
        return;
      }
      
      data.forEach(customer => {
        const quoteCount = customer.quotes?.[0]?.count || 0;
        
        const row = createElement('tr');
        row.innerHTML = `
          <td><strong>${customer.name}</strong></td>
          <td><a href="mailto:${customer.email}">${customer.email}</a></td>
          <td>${formatPhone(customer.phone) || 'â€”'}</td>
          <td>${customer.city ? `${customer.city}, ${customer.state}` : 'â€”'}</td>
          <td>${customer.lead_source ? `<span class="badge badge-info">${customer.lead_source}</span>` : 'â€”'}</td>
          <td>${quoteCount}</td>
          <td class="table-actions">
            <button class="btn btn-ghost btn-sm" onclick="editCustomer('${customer.id}')">Edit</button>
            <a href="/admin/quote-builder.html?customer=${customer.id}" class="btn btn-ghost btn-sm">New Quote</a>
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    
    // Search
    const searchInput = $('#search-input');
    searchInput.addEventListener('input', debounce((e) => {
      const query = e.target.value.toLowerCase();
      if (!query) {
        renderCustomers(customers);
        return;
      }
      
      const filtered = customers.filter(c => 
        c.name.toLowerCase().includes(query) ||
        c.email.toLowerCase().includes(query) ||
        (c.phone && c.phone.includes(query)) ||
        (c.city && c.city.toLowerCase().includes(query))
      );
      renderCustomers(filtered);
    }, 300));
    
    // Add customer
    $('#add-customer-btn').addEventListener('click', () => showCustomerModal());
    
    function showCustomerModal(customer = null) {
      const isEdit = !!customer;
      
      const leadSourceOptions = leadSources.map(ls => 
        `<option value="${ls.name}" ${customer?.lead_source === ls.name ? 'selected' : ''}>${ls.name}</option>`
      ).join('');
      
      // Parse existing name into first/last for editing
      let firstName = customer?.first_name || '';
      let lastName = customer?.last_name || '';
      if (!firstName && customer?.name) {
        // Fallback: split the name field
        const parts = customer.name.split(' ');
        firstName = parts[0] || '';
        lastName = parts.slice(1).join(' ') || '';
      }
      
      const content = createElement('form', { id: 'customer-form' });
      content.innerHTML = `
        <div class="grid grid-cols-2 gap-lg">
          <div class="form-group">
            <label class="form-label">First Name *</label>
            <input type="text" name="first_name" class="form-input" value="${firstName}" placeholder="Enter first name" required>
          </div>
          <div class="form-group">
            <label class="form-label">Last Name *</label>
            <input type="text" name="last_name" class="form-input" value="${lastName}" placeholder="Enter last name" required>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-lg">
          <div class="form-group">
            <label class="form-label">Email *</label>
            <input type="email" name="email" class="form-input" value="${customer?.email || ''}" placeholder="Enter email" required>
          </div>
          <div class="form-group">
            <label class="form-label">Phone</label>
            <input type="tel" name="phone" class="form-input" value="${customer?.phone || ''}" placeholder="Enter phone number">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-lg">
          <div class="form-group">
            <label class="form-label">Lead Source</label>
            <select name="lead_source" class="form-select">
              <option value="">-- Select --</option>
              ${leadSourceOptions}
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Company</label>
            <input type="text" name="company" class="form-input" value="${customer?.company || ''}" placeholder="Company name (optional)">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Address</label>
          <input type="text" name="address" class="form-input" value="${customer?.address || ''}" placeholder="Street address">
        </div>
        <div class="grid grid-cols-3 gap-lg">
          <div class="form-group">
            <label class="form-label">City</label>
            <input type="text" name="city" class="form-input" value="${customer?.city || ''}" placeholder="City">
          </div>
          <div class="form-group">
            <label class="form-label">State</label>
            <input type="text" name="state" class="form-input" value="${customer?.state || 'MA'}">
          </div>
          <div class="form-group">
            <label class="form-label">ZIP</label>
            <input type="text" name="zip" class="form-input" value="${customer?.zip || ''}" placeholder="Zip code">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Notes</label>
          <textarea name="notes" class="form-textarea" rows="2" placeholder="Any additional notes...">${customer?.notes || ''}</textarea>
        </div>
      `;
      
      const footer = createElement('div', { className: 'flex justify-between' });
      
      const leftBtns = createElement('div');
      let deleteBtn = null;
      if (isEdit) {
        deleteBtn = createElement('button', {
          type: 'button',
          className: 'btn btn-danger',
          textContent: 'Delete'
        });
        leftBtns.appendChild(deleteBtn);
      }
      footer.appendChild(leftBtns);
      
      const rightBtns = createElement('div', { className: 'btn-group' });
      const cancelBtn = createElement('button', {
        type: 'button',
        className: 'btn btn-secondary',
        textContent: 'Cancel'
      });
      const submitBtn = createElement('button', {
        type: 'button',
        className: 'btn btn-primary',
        textContent: isEdit ? 'Save Changes' : 'Add Customer'
      });
      rightBtns.appendChild(cancelBtn);
      rightBtns.appendChild(submitBtn);
      footer.appendChild(rightBtns);
      
      const modal = createModal({
        title: isEdit ? 'Edit Customer' : 'Add Customer',
        content,
        footer,
        size: 'lg'
      });
      
      // Add event listeners AFTER modal is created
      cancelBtn.addEventListener('click', () => closeModal(modal));
      submitBtn.addEventListener('click', async () => {
        if (content.checkValidity()) {
          await saveCustomer(new FormData(content), customer?.id);
          closeModal(modal);
        } else {
          content.reportValidity();
        }
      });
      if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
          if (await confirm('Delete this customer? This cannot be undone.', { danger: true })) {
            await deleteCustomer(customer.id);
            closeModal(modal);
          }
        });
      }
    }
    
    async function saveCustomer(formData, id = null) {
      try {
        const supabase = await app.waitForSupabase();
        
        const firstName = formData.get('first_name').trim();
        const lastName = formData.get('last_name').trim();
        const fullName = `${firstName} ${lastName}`.trim();
        
        const data = {
          name: fullName,
          first_name: firstName,
          last_name: lastName,
          email: formData.get('email').toLowerCase(),
          phone: formData.get('phone') || null,
          company: formData.get('company') || null,
          address: formData.get('address') || null,
          city: formData.get('city') || null,
          state: formData.get('state') || null,
          zip: formData.get('zip') || null,
          lead_source: formData.get('lead_source') || null,
          notes: formData.get('notes') || null
        };
        
        if (id) {
          await supabase.from('customers').update(data).eq('id', id);
          showToast('Customer updated', 'success');
        } else {
          await supabase.from('customers').insert(data);
          showToast('Customer added', 'success');
        }
        
        loadCustomers();
      } catch (err) {
        showToast('Failed to save: ' + err.message, 'error');
      }
    }
    
    async function deleteCustomer(id) {
      try {
        const supabase = await app.waitForSupabase();
        await supabase.from('customers').delete().eq('id', id);
        showToast('Customer deleted', 'success');
        loadCustomers();
      } catch (err) {
        showToast('Failed to delete: ' + err.message, 'error');
      }
    }
    
    window.editCustomer = async (id) => {
      const customer = customers.find(c => c.id === id);
      if (customer) showCustomerModal(customer);
    };
    
    // ==========================================
    // CSV IMPORT FUNCTIONALITY
    // ==========================================
    
    let csvData = [];
    let csvHeaders = [];
    let columnMapping = {};
    
    const targetFields = [
      { key: 'first_name', label: 'First Name', required: false },
      { key: 'last_name', label: 'Last Name', required: false },
      { key: 'name', label: 'Full Name', required: false },
      { key: 'email', label: 'Email', required: true },
      { key: 'phone', label: 'Phone', required: false },
      { key: 'company', label: 'Company', required: false },
      { key: 'address', label: 'Address', required: false },
      { key: 'address2', label: 'Address 2', required: false },
      { key: 'city', label: 'City', required: false },
      { key: 'state', label: 'State', required: false },
      { key: 'zip', label: 'ZIP', required: false },
      { key: 'lead_source', label: 'Lead Source', required: false },
      { key: 'notes', label: 'Notes', required: false }
    ];
    
    $('#import-csv-btn').addEventListener('click', showImportModal);
    
    function showImportModal() {
      csvData = [];
      csvHeaders = [];
      columnMapping = {};
      
      const content = createElement('div', { id: 'import-content' });
      content.innerHTML = `
        <div id="import-step-1">
          <div class="import-dropzone" id="dropzone">
            <div class="import-dropzone-icon">ðŸ“„</div>
            <p><strong>Drop your CSV file here</strong></p>
            <p class="text-muted text-sm">or click to browse</p>
            <input type="file" id="csv-file-input" accept=".csv,.txt" style="display: none;">
          </div>
          <p class="text-muted text-sm mt-md">Supported: CSV files from Excel, Google Sheets, etc.</p>
        </div>
        
        <div id="import-step-2" style="display: none;">
          <div class="import-stats">
            <div class="import-stat">
              <div class="import-stat-value" id="row-count">0</div>
              <div class="import-stat-label">Rows Found</div>
            </div>
            <div class="import-stat">
              <div class="import-stat-value" id="col-count">0</div>
              <div class="import-stat-label">Columns</div>
            </div>
          </div>
          
          <h4>Map Columns</h4>
          <p class="text-muted text-sm mb-md">Match your CSV columns to customer fields</p>
          <div id="mapping-container"></div>
          
          <h4 class="mt-lg">Preview</h4>
          <div class="import-preview" id="preview-container"></div>
        </div>
      `;
      
      const footer = createElement('div', { className: 'flex justify-end gap-md' });
      footer.innerHTML = `
        <button type="button" class="btn btn-secondary" id="import-cancel-btn">Cancel</button>
        <button type="button" class="btn btn-primary" id="import-btn" style="display: none;">Import Customers</button>
      `;
      
      const modal = createModal({
        title: 'Import Customers from CSV',
        content,
        footer,
        size: 'xl'
      });
      
      // Set up dropzone
      const dropzone = $('#dropzone');
      const fileInput = $('#csv-file-input');
      
      dropzone.addEventListener('click', () => fileInput.click());
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });
      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('dragover');
      });
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) processCSVFile(file);
      });
      
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) processCSVFile(file);
      });
      
      $('#import-cancel-btn').addEventListener('click', () => closeModal(modal));
      $('#import-btn').addEventListener('click', () => {
        importCustomers();
        closeModal(modal);
      });
    }
    
    function processCSVFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        parseCSV(text);
        showStep2();
      };
      reader.readAsText(file);
    }
    
    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(line => line.trim());
      if (lines.length === 0) return;
      
      // Parse header
      csvHeaders = parseCSVLine(lines[0]);
      
      // Parse data rows
      csvData = [];
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.some(v => v.trim())) {
          const row = {};
          csvHeaders.forEach((header, idx) => {
            row[header] = values[idx] || '';
          });
          csvData.push(row);
        }
      }
      
      // Auto-map columns
      autoMapColumns();
    }
    
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }
    
    function autoMapColumns() {
      columnMapping = {};
      
      const mappings = {
        'first_name': ['first name', 'firstname', 'first', 'fname'],
        'last_name': ['last name', 'lastname', 'last', 'lname', 'surname'],
        'name': ['name', 'full name', 'fullname', 'customer name', 'customer', 'client'],
        'email': ['email', 'e-mail', 'email address', 'mail'],
        'phone': ['phone', 'telephone', 'tel', 'mobile', 'cell', 'phone number'],
        'company': ['company', 'company name', 'business', 'organization'],
        'address': ['address', 'street', 'street address', 'address1', 'address 1'],
        'address2': ['address2', 'address 2', 'apt', 'suite', 'unit'],
        'city': ['city', 'town'],
        'state': ['state', 'province', 'region', 'st'],
        'zip': ['zip', 'zipcode', 'zip code', 'postal', 'postal code', 'postcode'],
        'lead_source': ['lead source', 'leadsource', 'source', 'how heard', 'referral source'],
        'notes': ['notes', 'note', 'comments', 'comment', 'description']
      };
      
      csvHeaders.forEach(header => {
        const headerLower = header.toLowerCase().trim();
        for (const [field, aliases] of Object.entries(mappings)) {
          if (aliases.includes(headerLower)) {
            columnMapping[header] = field;
            break;
          }
        }
      });
    }
    
    function showStep2() {
      $('#import-step-1').style.display = 'none';
      $('#import-step-2').style.display = 'block';
      $('#import-btn').style.display = 'inline-flex';
      
      $('#row-count').textContent = csvData.length;
      $('#col-count').textContent = csvHeaders.length;
      
      renderMapping();
      renderPreview();
    }
    
    function renderMapping() {
      const container = $('#mapping-container');
      container.innerHTML = csvHeaders.map(header => `
        <div class="mapping-row">
          <div class="mapping-source">${header}</div>
          <div class="mapping-arrow">â†’</div>
          <div class="mapping-target">
            <select class="form-select form-select-sm" data-source="${header}" onchange="updateMapping(this)">
              <option value="">-- Skip --</option>
              ${targetFields.map(f => `
                <option value="${f.key}" ${columnMapping[header] === f.key ? 'selected' : ''}>
                  ${f.label}${f.required ? ' *' : ''}
                </option>
              `).join('')}
            </select>
          </div>
        </div>
      `).join('');
    }
    
    window.updateMapping = (select) => {
      const source = select.dataset.source;
      const target = select.value;
      
      // Remove any existing mapping to this target
      Object.keys(columnMapping).forEach(key => {
        if (columnMapping[key] === target && key !== source) {
          delete columnMapping[key];
        }
      });
      
      if (target) {
        columnMapping[source] = target;
      } else {
        delete columnMapping[source];
      }
      
      renderMapping();
      renderPreview();
    };
    
    function renderPreview() {
      const container = $('#preview-container');
      const previewRows = csvData.slice(0, 5);
      
      container.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              ${targetFields.filter(f => Object.values(columnMapping).includes(f.key)).map(f => `<th>${f.label}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
            ${previewRows.map(row => `
              <tr>
                ${targetFields.filter(f => Object.values(columnMapping).includes(f.key)).map(f => {
                  const sourceCol = Object.keys(columnMapping).find(k => columnMapping[k] === f.key);
                  return `<td>${sourceCol ? row[sourceCol] || '' : ''}</td>`;
                }).join('')}
              </tr>
            `).join('')}
          </tbody>
        </table>
        ${csvData.length > 5 ? `<p class="text-muted text-sm mt-sm">Showing 5 of ${csvData.length} rows</p>` : ''}
      `;
    }
    
    async function importCustomers() {
      // Validate required mappings
      const hasName = Object.values(columnMapping).includes('name');
      const hasFirstName = Object.values(columnMapping).includes('first_name');
      const hasLastName = Object.values(columnMapping).includes('last_name');
      const hasEmail = Object.values(columnMapping).includes('email');
      
      if (!hasEmail) {
        showToast('Please map the Email column', 'error');
        return;
      }
      
      if (!hasName && !hasFirstName && !hasLastName) {
        showToast('Please map Name or First Name/Last Name columns', 'error');
        return;
      }
      
      try {
        const supabase = await app.waitForSupabase();
        
        // Transform data
        const customersToImport = csvData.map(row => {
          const customer = {};
          
          // Get values from mapping
          Object.entries(columnMapping).forEach(([source, target]) => {
            let value = row[source]?.trim() || null;
            if (target === 'email' && value) {
              value = value.toLowerCase();
            }
            customer[target] = value;
          });
          
          // Combine first_name + last_name into name if no full name
          if (!customer.name && (customer.first_name || customer.last_name)) {
            customer.name = [customer.first_name, customer.last_name].filter(Boolean).join(' ');
          }
          
          // Combine address + address2
          if (customer.address2 && customer.address) {
            customer.address = customer.address + ', ' + customer.address2;
          }
          
          // Clean up temporary fields
          delete customer.first_name;
          delete customer.last_name;
          delete customer.address2;
          
          return customer;
        }).filter(c => c.name && c.email);
        
        if (customersToImport.length === 0) {
          showToast('No valid customers to import', 'error');
          return;
        }
        
        // Get existing emails to check for duplicates
        const emails = customersToImport.map(c => c.email);
        const { data: existingCustomers } = await supabase
          .from('customers')
          .select('email')
          .in('email', emails);
        
        const existingEmails = new Set((existingCustomers || []).map(c => c.email));
        
        // Split into new and updates
        const newCustomers = customersToImport.filter(c => !existingEmails.has(c.email));
        const updateCustomers = customersToImport.filter(c => existingEmails.has(c.email));
        
        let imported = 0;
        let updated = 0;
        let failed = 0;
        
        // Insert new customers in batches
        if (newCustomers.length > 0) {
          const batchSize = 50;
          for (let i = 0; i < newCustomers.length; i += batchSize) {
            const batch = newCustomers.slice(i, i + batchSize);
            const { data, error } = await supabase
              .from('customers')
              .insert(batch)
              .select();
            
            if (error) {
              console.error('Insert batch error:', error);
              failed += batch.length;
            } else {
              imported += data?.length || 0;
            }
          }
        }
        
        // Update existing customers one by one
        for (const customer of updateCustomers) {
          const { error } = await supabase
            .from('customers')
            .update(customer)
            .eq('email', customer.email);
          
          if (error) {
            console.error('Update error for', customer.email, error);
            failed++;
          } else {
            updated++;
          }
        }
        
        let message = `Imported ${imported} new customers`;
        if (updated > 0) message += `, updated ${updated}`;
        if (failed > 0) message += `, ${failed} failed`;
        
        showToast(message, failed > 0 ? 'warning' : 'success');
        loadCustomers();
        
      } catch (err) {
        console.error('Import error:', err);
        showToast('Import failed: ' + err.message, 'error');
      }
    }
    
    // Initialize
    async function init() {
      await loadLeadSources();
      await loadCustomers();
    }
    init();
  </script>
</body>
</html>
