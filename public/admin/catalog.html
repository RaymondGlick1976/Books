<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Items Catalog | Admin | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css?v=44">
</head>
<body>
  <script>
    // Permission check before page loads
    const user = JSON.parse(localStorage.getItem('app_user') || 'null');
    if (!user) {
      window.location.href = '/admin/login.html';
    } else if (!user.permissions?.can_view_quotes) {
      window.location.href = user.permissions?.can_view_pipeline ? '/admin/pipeline.html' : '/admin/index.html';
    }
  </script>
  <div class="app-layout">
    <aside class="app-sidebar">
      <div class="sidebar-logo">
        <img src="/images/logo.gif" alt="Homestead Cabinet Design" style="height: 40px; filter: brightness(0) invert(1);">
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item"><a href="/admin/index.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard</a></li>
          <li class="sidebar-nav-item"><a href="/admin/pipeline.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Deals Pipeline</a></li>
          <li class="sidebar-nav-item"><a href="/admin/customers.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Customers</a></li>
          <li class="sidebar-nav-item"><a href="/admin/quotes.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>Quotes</a></li>
          <li class="sidebar-nav-item"><a href="/admin/invoices.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>Invoices</a></li>
        </ul>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Lead Capture</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/booking-forms.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>Booking Forms</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Catalog</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/catalog.html" class="sidebar-nav-link active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>Items Catalog</a></li>
            <li class="sidebar-nav-item"><a href="/admin/pricing-attributes.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>Pricing Attributes</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/email-templates.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Email Templates</a></li>
          </ul>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/settings.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</a></li>
          </ul>
        </div>
      </nav>
    </aside>
    
    <main class="app-main">
      <header class="app-header">
        <h2>Items Catalog</h2>
        <button class="btn btn-primary" id="add-item-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Add Item
        </button>
      </header>
      
      <div class="app-content">
        <!-- Filters -->
        <div class="card mb-xl">
          <div class="card-body">
            <div class="flex gap-md items-center">
              <input type="text" id="search-input" class="form-input" placeholder="Search items..." style="max-width: 300px;">
              <select id="category-filter" class="form-select" style="max-width: 200px;">
                <option value="">All Categories</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Items Table -->
        <div class="card">
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="items-tbody">
                <tr>
                  <td colspan="5" style="text-align: center; padding: 40px;">
                    <div class="loading-spinner" style="margin: 0 auto;"></div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script src="/js/utils.js"></script>
  <script>
    
    let items = [];
    let categories = new Set();
    let pricingAttributes = [];
    let itemAttributeMap = {}; // Map of item_id -> [attribute_ids]
    
    async function loadItems() {
      try {
        const supabase = await app.waitForSupabase();
        
        const { data, error } = await supabase
          .from('items_catalog')
          .select('*')
          .order('category', { ascending: true })
          .order('name', { ascending: true });
        
        if (error) throw error;
        items = data || [];
        
        // Build category filter
        categories = new Set(items.map(i => i.category).filter(Boolean));
        const categorySelect = $('#category-filter');
        categorySelect.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat;
          option.textContent = cat;
          categorySelect.appendChild(option);
        });
        
        renderItems(items);
      } catch (err) {
        console.error('Load error:', err);
        showToast('Failed to load catalog', 'error');
      }
    }
    
    async function loadPricingAttributes() {
      try {
        const supabase = await app.waitForSupabase();
        
        // Load pricing attributes
        const { data: attrs, error: attrError } = await supabase
          .from('pricing_attributes')
          .select('*, options:pricing_attribute_options(*)')
          .eq('is_active', true)
          .order('sort_order, name');
        
        if (attrError) throw attrError;
        pricingAttributes = attrs || [];
        
        // Load item-attribute mappings
        const { data: mappings, error: mapError } = await supabase
          .from('catalog_item_attributes')
          .select('item_id, attribute_id');
        
        if (mapError) throw mapError;
        itemAttributeMap = {};
        (mappings || []).forEach(m => {
          if (!itemAttributeMap[m.item_id]) {
            itemAttributeMap[m.item_id] = [];
          }
          itemAttributeMap[m.item_id].push(m.attribute_id);
        });
      } catch (err) {
        console.log('Pricing attributes not available (migration may not be run yet):', err.message);
        pricingAttributes = [];
        itemAttributeMap = {};
      }
    }
    
    function renderItems(data) {
      const tbody = $('#items-tbody');
      clearElement(tbody);
      
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-xl">No items in catalog. Add your first item!</td></tr>';
        return;
      }
      
      data.forEach(item => {
        const row = createElement('tr');
        const itemAttrs = itemAttributeMap[item.id] || [];
        const attrNames = itemAttrs.map(attrId => {
          const attr = pricingAttributes.find(a => a.id === attrId);
          return attr?.name || '';
        }).filter(Boolean);
        
        let priceDisplay;
        if (item.default_price) {
          priceDisplay = formatCurrency(item.default_price);
          if (itemAttrs.length > 0) {
            priceDisplay += ' <span class="text-muted text-sm">(base)</span>';
          }
        } else if (item.price_range_low && item.price_range_high) {
          priceDisplay = `${formatCurrency(item.price_range_low)} - ${formatCurrency(item.price_range_high)}`;
        } else {
          priceDisplay = '—';
        }
        
        row.innerHTML = `
          <td>
            <strong>${item.name}</strong>
            ${item.description ? `<div class="text-sm text-muted">${item.description}</div>` : ''}
            ${attrNames.length > 0 ? `<div class="text-sm" style="color: var(--color-primary); margin-top: 4px;">⚙ ${attrNames.join(', ')}</div>` : ''}
          </td>
          <td>${item.category || '—'}</td>
          <td>${priceDisplay}</td>
          <td><span class="badge badge-${item.is_active ? 'success' : 'draft'}">${item.is_active ? 'Active' : 'Inactive'}</span></td>
          <td class="table-actions">
            <button class="btn btn-ghost btn-sm" onclick="editItem('${item.id}')">Edit</button>
            <button class="btn btn-ghost btn-sm" onclick="deleteItem('${item.id}')">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }
    
    // Search & Filter
    const searchInput = $('#search-input');
    const categoryFilter = $('#category-filter');
    
    function applyFilters() {
      const query = searchInput.value.toLowerCase();
      const category = categoryFilter.value;
      
      let filtered = items;
      
      if (query) {
        filtered = filtered.filter(item => 
          item.name.toLowerCase().includes(query) ||
          (item.description && item.description.toLowerCase().includes(query))
        );
      }
      
      if (category) {
        filtered = filtered.filter(item => item.category === category);
      }
      
      renderItems(filtered);
    }
    
    searchInput.addEventListener('input', debounce(applyFilters, 300));
    categoryFilter.addEventListener('change', applyFilters);
    
    // Add/Edit item
    $('#add-item-btn').addEventListener('click', () => showItemModal());
    
    function showItemModal(item = null) {
      const isEdit = !!item;
      const itemAttrs = item ? (itemAttributeMap[item.id] || []) : [];
      
      const content = createElement('form', { id: 'item-form' });
      content.innerHTML = `
        <div class="form-group">
          <label class="form-label">Item Name *</label>
          <input type="text" name="name" class="form-input" value="${item?.name || ''}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-textarea" rows="2">${item?.description || ''}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Category</label>
          <input type="text" name="category" class="form-input" value="${item?.category || ''}" list="category-list" placeholder="e.g., Cabinet Doors, Hardware">
          <datalist id="category-list">
            ${Array.from(categories).map(c => `<option value="${c}">`).join('')}
          </datalist>
        </div>
        <div class="form-group">
          <label class="form-label">Base Price</label>
          <input type="number" name="default_price" class="form-input" value="${item?.default_price || ''}" step="0.01" min="0" placeholder="Base price before attribute adjustments">
          <small class="text-muted">This is the starting price. Pricing attributes will adjust from this base.</small>
        </div>
        ${pricingAttributes.length > 0 ? `
        <div class="form-group">
          <label class="form-label">Pricing Attributes</label>
          <p class="text-muted text-sm mb-sm">Select which pricing attributes apply to this item. When added to quotes, users can select options that adjust the price.</p>
          <div class="attributes-checklist" style="display: grid; gap: var(--space-sm); max-height: 200px; overflow-y: auto; padding: var(--space-sm); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
            ${pricingAttributes.map(attr => `
              <label class="form-check" style="margin: 0;">
                <input type="checkbox" name="attributes" value="${attr.id}" ${itemAttrs.includes(attr.id) ? 'checked' : ''}>
                <span>
                  <strong>${attr.name}</strong>
                  <span class="text-muted text-sm"> - ${attr.options?.length || 0} options</span>
                </span>
              </label>
            `).join('')}
          </div>
          <a href="/admin/pricing-attributes.html" class="text-sm" style="color: var(--color-primary);">Manage pricing attributes →</a>
        </div>
        ` : `
        <div class="form-group">
          <label class="form-label">Pricing Attributes</label>
          <p class="text-muted text-sm">No pricing attributes created yet. <a href="/admin/pricing-attributes.html" style="color: var(--color-primary);">Create some</a> to enable dynamic pricing.</p>
        </div>
        `}
        <div class="form-group">
          <label class="form-check">
            <input type="checkbox" name="is_taxable" class="form-check-input" ${item?.is_taxable !== false ? 'checked' : ''}>
            <span class="form-check-label">Taxable</span>
          </label>
        </div>
        <div class="form-group">
          <label class="form-check">
            <input type="checkbox" name="is_active" class="form-check-input" ${item?.is_active !== false ? 'checked' : ''}>
            <span class="form-check-label">Active (available for use in quotes)</span>
          </label>
        </div>
      `;
      
      const footer = createElement('div', { className: 'btn-group' });
      const cancelBtn = createElement('button', {
        type: 'button',
        className: 'btn btn-secondary',
        textContent: 'Cancel'
      });
      const submitBtn = createElement('button', {
        type: 'button',
        className: 'btn btn-primary',
        textContent: isEdit ? 'Save Changes' : 'Add Item'
      });
      footer.appendChild(cancelBtn);
      footer.appendChild(submitBtn);
      
      const modal = createModal({
        title: isEdit ? 'Edit Catalog Item' : 'Add Catalog Item',
        content,
        footer,
        size: 'lg'
      });
      
      // Add event listeners AFTER modal is created
      cancelBtn.addEventListener('click', () => closeModal(modal));
      submitBtn.addEventListener('click', async () => {
        // Manual validation check
        const nameInput = content.querySelector('[name="name"]');
        if (!nameInput.value.trim()) {
          showToast('Item name is required', 'error');
          nameInput.focus();
          return;
        }
        await saveItem(content, item?.id);
        closeModal(modal);
      });
    }
    
    async function saveItem(form, id = null) {
      try {
        const supabase = await app.waitForSupabase();
        
        const data = {
          name: form.querySelector('[name="name"]').value,
          description: form.querySelector('[name="description"]').value || null,
          category: form.querySelector('[name="category"]').value || null,
          default_price: parseFloat(form.querySelector('[name="default_price"]').value) || null,
          is_taxable: form.querySelector('[name="is_taxable"]').checked,
          is_active: form.querySelector('[name="is_active"]').checked
        };
        
        // Get selected attributes
        const selectedAttrs = Array.from(form.querySelectorAll('[name="attributes"]:checked'))
          .map(cb => cb.value);
        
        let itemId = id;
        
        if (id) {
          await supabase.from('items_catalog').update(data).eq('id', id);
          showToast('Item updated', 'success');
        } else {
          const { data: newItem, error } = await supabase.from('items_catalog').insert(data).select().single();
          if (error) throw error;
          itemId = newItem.id;
          showToast('Item added', 'success');
        }
        
        // Update attribute mappings (if table exists)
        try {
          await supabase.from('catalog_item_attributes').delete().eq('item_id', itemId);
          
          if (selectedAttrs.length > 0) {
            const mappings = selectedAttrs.map((attrId, index) => ({
              item_id: itemId,
              attribute_id: attrId,
              sort_order: index
            }));
            await supabase.from('catalog_item_attributes').insert(mappings);
          }
        } catch (attrErr) {
          console.log('Could not save attribute mappings (migration may not be run yet)');
        }
        
        // Refresh data
        await loadPricingAttributes();
        loadItems();
      } catch (err) {
        showToast('Failed to save: ' + err.message, 'error');
      }
    }
    
    window.editItem = (id) => {
      const item = items.find(i => i.id === id);
      if (item) showItemModal(item);
    };
    
    window.deleteItem = async (id) => {
      if (!await confirm('Delete this catalog item?', { danger: true })) return;
      
      try {
        const supabase = await app.waitForSupabase();
        await supabase.from('items_catalog').delete().eq('id', id);
        showToast('Item deleted', 'success');
        loadItems();
      } catch (err) {
        showToast('Failed to delete: ' + err.message, 'error');
      }
    };
    
    // Initialize
    async function init() {
      await loadPricingAttributes();
      await loadItems();
    }
    init();
  </script>
</body>
</html>
