<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jobs Pipeline | Admin | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css?v=30">
  <style>
    /* Pipeline specific styles */
    .pipeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
      flex-wrap: wrap;
      gap: var(--space-md);
    }
    
    .pipeline-header h2 {
      margin: 0;
    }
    
    .pipeline-actions {
      display: flex;
      gap: var(--space-sm);
    }
    
    .pipeline-container {
      display: flex;
      gap: var(--space-md);
      overflow-x: auto;
      padding-bottom: var(--space-lg);
      min-height: calc(100vh - 200px);
    }
    
    .pipeline-column {
      flex: 0 0 280px;
      background: var(--color-bg-soft);
      border-radius: var(--radius-lg);
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 200px);
    }
    
    .column-header {
      padding: var(--space-md);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      position: sticky;
      top: 0;
      background: var(--color-bg-soft);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }
    
    .stage-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .column-title {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--color-text);
      flex: 1;
    }
    
    .column-count {
      background: var(--color-bg);
      color: var(--color-text-muted);
      font-size: 0.75rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    .column-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-sm);
    }
    
    .job-card {
      background: white;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      margin-bottom: var(--space-sm);
      cursor: grab;
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .job-card:hover {
      border-color: var(--color-primary);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
    }
    
    .job-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    
    .job-card-title {
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--color-text);
      margin-bottom: 4px;
    }
    
    .job-card-customer {
      font-size: 0.8125rem;
      color: var(--color-text-muted);
      margin-bottom: var(--space-sm);
    }
    
    .job-card-stats {
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
      margin-bottom: var(--space-sm);
    }
    
    .job-card-stat {
      font-size: 0.75rem;
      color: var(--color-text-light);
      background: var(--color-bg-soft);
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .job-card-dates {
      font-size: 0.75rem;
      color: var(--color-text-muted);
    }
    
    .job-card-date {
      margin-top: 2px;
    }
    
    .job-card-value {
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--color-primary);
      margin-top: var(--space-sm);
    }
    
    .empty-column {
      text-align: center;
      padding: var(--space-xl);
      color: var(--color-text-muted);
      font-size: 0.8125rem;
    }
    
    .drop-zone {
      min-height: 100px;
      border: 2px dashed transparent;
      border-radius: var(--radius-md);
      transition: all 0.2s;
    }
    
    .drop-zone.drag-over {
      border-color: var(--color-primary);
      background: rgba(99, 102, 241, 0.05);
    }
    
    /* Job Modal */
    .job-detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-md);
    }
    
    .job-detail-full {
      grid-column: 1 / -1;
    }
    
    .job-items-list {
      background: var(--color-bg-soft);
      border-radius: var(--radius-md);
      padding: var(--space-md);
    }
    
    .job-item-row {
      display: flex;
      justify-content: space-between;
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--color-border-light);
    }
    
    .job-item-row:last-child {
      border-bottom: none;
    }
    
    .color-chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      background: white;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      padding: var(--space-xs) var(--space-sm);
      margin: 2px;
      font-size: 0.8125rem;
    }
    
    /* Stage Settings */
    .stage-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }
    
    .stage-item {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      padding: var(--space-md);
      background: var(--color-bg-soft);
      border-radius: var(--radius-md);
    }
    
    .stage-item .stage-dot {
      width: 16px;
      height: 16px;
    }
    
    .stage-item-label {
      flex: 1;
      font-weight: 500;
    }
    
    .stage-item-actions {
      display: flex;
      gap: var(--space-xs);
    }
    
    .view-toggle {
      display: flex;
      background: var(--color-bg-soft);
      border-radius: var(--radius-md);
      padding: 4px;
    }
    
    .view-toggle button {
      padding: var(--space-sm) var(--space-md);
      border: none;
      background: transparent;
      color: var(--color-text-muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
    }
    
    .view-toggle button.active {
      background: white;
      color: var(--color-primary);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* Calendar Styles */
    .calendar-container {
      background: white;
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      overflow: hidden;
    }
    
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-lg);
      background: var(--color-bg-soft);
      border-bottom: 1px solid var(--color-border);
    }
    
    .calendar-nav {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    
    .calendar-nav-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--color-border);
      background: white;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: var(--color-text-muted);
      transition: all 0.2s;
    }
    
    .calendar-nav-btn:hover {
      background: var(--color-bg-soft);
      color: var(--color-primary);
    }
    
    .calendar-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text);
      min-width: 200px;
      text-align: center;
    }
    
    .calendar-today-btn {
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--color-border);
      background: white;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--color-text-muted);
    }
    
    .calendar-today-btn:hover {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    
    .calendar-legend {
      display: flex;
      gap: var(--space-lg);
      padding: var(--space-sm) var(--space-lg);
      background: var(--color-bg-soft);
      border-bottom: 1px solid var(--color-border);
    }
    
    .calendar-legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: 0.8125rem;
      color: var(--color-text-muted);
    }
    
    .calendar-legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }
    
    .calendar-day-header {
      padding: var(--space-sm);
      text-align: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--color-text-muted);
      text-transform: uppercase;
      background: var(--color-bg-soft);
      border-bottom: 1px solid var(--color-border);
    }
    
    .calendar-day {
      min-height: 120px;
      border-right: 1px solid var(--color-border);
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-xs);
      background: white;
      position: relative;
    }
    
    .calendar-day:nth-child(7n) {
      border-right: none;
    }
    
    .calendar-day.other-month {
      background: var(--color-bg-soft);
    }
    
    .calendar-day.other-month .calendar-day-number {
      color: var(--color-text-muted);
    }
    
    .calendar-day.today {
      background: rgba(99, 102, 241, 0.05);
    }
    
    .calendar-day.today .calendar-day-number {
      background: var(--color-primary);
      color: white;
    }
    
    .calendar-day-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--color-text);
      margin-bottom: var(--space-xs);
    }
    
    .calendar-events {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .calendar-event {
      padding: 3px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: transform 0.1s;
    }
    
    .calendar-event:hover {
      transform: scale(1.02);
    }
    
    .calendar-event.shop {
      background: rgba(245, 158, 11, 0.15);
      color: #b45309;
      border-left: 3px solid #f59e0b;
    }
    
    .calendar-event.install {
      background: rgba(16, 185, 129, 0.15);
      color: #047857;
      border-left: 3px solid #10b981;
    }
    
    .calendar-more {
      font-size: 0.7rem;
      color: var(--color-text-muted);
      padding: 2px 6px;
      cursor: pointer;
    }
    
    .calendar-more:hover {
      color: var(--color-primary);
    }
  </style>
</head>
<body>
  <div class="app-layout">
    <aside class="app-sidebar">
      <div class="sidebar-logo">
        <img src="/images/logo.gif" alt="Homestead Cabinet Design" style="height: 40px; filter: brightness(0) invert(1);">
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item"><a href="/admin/index.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard</a></li>
          <li class="sidebar-nav-item"><a href="/admin/pipeline.html" class="sidebar-nav-link active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Jobs Pipeline</a></li>
          <li class="sidebar-nav-item"><a href="/admin/customers.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Customers</a></li>
          <li class="sidebar-nav-item"><a href="/admin/quotes.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>Quotes</a></li>
          <li class="sidebar-nav-item"><a href="/admin/invoices.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>Invoices</a></li>
        </ul>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Catalog</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/catalog.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>Items Catalog</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/settings.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</a></li>
          </ul>
        </div>
      </nav>
    </aside>
    
    <main class="app-main">
      <header class="app-header">
        <div class="pipeline-header">
          <div>
            <h2>Jobs Pipeline</h2>
            <p class="text-muted" id="job-summary">Loading...</p>
          </div>
          <div class="pipeline-actions">
            <div class="view-toggle">
              <button class="active" data-view="pipeline">Pipeline</button>
              <button data-view="calendar">Calendar</button>
              <button data-view="list">List</button>
            </div>
            <button class="btn btn-secondary" onclick="openStageSettings()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
              Stages
            </button>
            <button class="btn btn-secondary" onclick="openEventTypesModal()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              Event Types
            </button>
            <button class="btn btn-primary" onclick="openJobModal()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              New Job
            </button>
          </div>
        </div>
      </header>
      
      <div class="app-content">
        <!-- Pipeline View -->
        <div id="pipeline-view">
          <div class="pipeline-container" id="pipeline-container">
            <!-- Columns rendered by JS -->
          </div>
        </div>
        
        <!-- Calendar View (hidden by default) -->
        <div id="calendar-view" style="display: none;">
          <div class="calendar-container">
            <div class="calendar-header">
              <div class="calendar-nav">
                <button class="calendar-nav-btn" onclick="prevMonth()">‚Üê</button>
                <span class="calendar-title" id="calendar-title">January 2025</span>
                <button class="calendar-nav-btn" onclick="nextMonth()">‚Üí</button>
              </div>
              <button class="calendar-today-btn" onclick="goToToday()">Today</button>
            </div>
            <div class="calendar-legend" id="calendar-legend">
              <!-- Populated by JS from event types -->
              </div>
            </div>
            <div class="calendar-grid" id="calendar-grid">
              <!-- Calendar days rendered by JS -->
            </div>
          </div>
        </div>
        
        <!-- List View (hidden by default) -->
        <div id="list-view" style="display: none;">
          <div class="card">
            <div class="card-body">
              <table class="data-table" id="jobs-table">
                <thead>
                  <tr>
                    <th>Job</th>
                    <th>Customer</th>
                    <th>Stage</th>
                    <th>Next Date</th>
                    <th>Events</th>
                    <th>Value</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="jobs-table-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Job Modal -->
  <div id="job-modal" class="modal-overlay">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 class="modal-title" id="job-modal-title">New Job</h3>
        <button class="modal-close" onclick="closeJobModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="job-form">
          <input type="hidden" id="job-id">
          
          <div class="job-detail-grid">
            <div class="form-group job-detail-full">
              <label class="form-label">Job Name *</label>
              <input type="text" id="job-name" class="form-input" required placeholder="e.g., Smith Kitchen Reface">
            </div>
            
            <div class="form-group">
              <label class="form-label">Customer *</label>
              <select id="job-customer" class="form-input" required>
                <option value="">Select customer...</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Stage</label>
              <select id="job-stage" class="form-input">
                <!-- Populated by JS -->
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">Estimated Value</label>
              <input type="number" id="job-value" class="form-input" step="0.01" placeholder="0.00">
            </div>
            
            <div class="form-group">
              <label class="form-label">Link to Quote</label>
              <select id="job-quote" class="form-input">
                <option value="">None</option>
              </select>
            </div>
          </div>
          
          <!-- Job Events/Dates Section -->
          <div class="form-group mt-xl">
            <div class="flex items-center justify-between mb-md">
              <label class="form-label mb-0">üìÖ Scheduled Dates</label>
              <button type="button" class="btn btn-secondary btn-sm" onclick="addJobEvent()">+ Add Date</button>
            </div>
            <div id="job-events-container" class="job-items-list">
              <p class="text-muted text-sm" id="no-events-msg">No dates scheduled. Click "+ Add Date" to schedule shop, install, delivery dates, etc.</p>
            </div>
          </div>
          
          <!-- Job Items Section -->
          <div class="form-group mt-lg">
            <div class="flex items-center justify-between mb-md">
              <label class="form-label mb-0">Job Items</label>
              <button type="button" class="btn btn-secondary btn-sm" onclick="addJobItem()">+ Add Item</button>
            </div>
            <div id="job-items-container" class="job-items-list">
              <p class="text-muted text-sm" id="no-items-msg">No items added. Click "+ Add Item" to add doors, drawer fronts, etc.</p>
            </div>
          </div>
          
          <!-- Colors Section -->
          <div class="form-group mt-lg">
            <div class="flex items-center justify-between mb-md">
              <label class="form-label mb-0">Colors / Finishes</label>
              <button type="button" class="btn btn-secondary btn-sm" onclick="addColor()">+ Add Color</button>
            </div>
            <div id="colors-container">
              <p class="text-muted text-sm" id="no-colors-msg">No colors added.</p>
            </div>
          </div>
          
          <div class="form-group mt-lg">
            <label class="form-label">Refacing Materials</label>
            <textarea id="job-materials" class="form-input" rows="2" placeholder="e.g., Maple veneer, White RTF..."></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea id="job-notes" class="form-input" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeJobModal()">Cancel</button>
        <button type="button" class="btn btn-danger" id="delete-job-btn" style="display: none;" onclick="deleteJob()">Delete</button>
        <button type="button" class="btn btn-primary" onclick="saveJob()">Save Job</button>
      </div>
    </div>
  </div>
  
  <!-- Stage Settings Modal -->
  <div id="stage-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Pipeline Stages</h3>
        <button class="modal-close" onclick="closeStageSettings()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-lg">Customize your pipeline stages. Drag to reorder.</p>
        <div id="stage-list" class="stage-list"></div>
        
        <div class="mt-xl" id="add-stage-form" style="display: none;">
          <h4 class="mb-md">Add New Stage</h4>
          <div class="flex gap-sm">
            <input type="text" id="new-stage-label" class="form-input" placeholder="Stage name">
            <input type="color" id="new-stage-color" value="#6366f1" style="width: 50px; height: 38px;">
            <button class="btn btn-primary" onclick="saveNewStage()">Add</button>
            <button class="btn btn-secondary" onclick="cancelAddStage()">Cancel</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="showAddStageForm()">+ Add Stage</button>
        <button class="btn btn-primary" onclick="closeStageSettings()">Done</button>
      </div>
    </div>
  </div>
  
  <!-- Event Types Modal -->
  <div id="event-types-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Calendar Event Types</h3>
        <button class="modal-close" onclick="closeEventTypesModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-lg">Customize calendar event types with colors and icons.</p>
        <div id="event-types-list" class="stage-list"></div>
        
        <div class="mt-xl" id="add-event-type-form" style="display: none;">
          <h4 class="mb-md">Add New Event Type</h4>
          <div class="flex gap-sm flex-wrap">
            <input type="text" id="new-event-type-name" class="form-input" placeholder="Event name" style="flex: 1;">
            <input type="text" id="new-event-type-icon" class="form-input" placeholder="üìÖ" style="width: 60px;" maxlength="2">
            <input type="color" id="new-event-type-color" value="#6366f1" style="width: 50px; height: 38px;">
            <button class="btn btn-primary" onclick="saveNewEventType()">Add</button>
            <button class="btn btn-secondary" onclick="cancelAddEventType()">Cancel</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="showAddEventTypeForm()">+ Add Event Type</button>
        <button class="btn btn-primary" onclick="closeEventTypesModal()">Done</button>
      </div>
    </div>
  </div>
  
  <script src="/js/utils.js"></script>
  <script>
    // Data
    let jobs = [];
    let stages = [];
    let customers = [];
    let quotes = [];
    let eventTypes = [];
    let jobEvents = [];
    let draggedJob = null;
    let jobItems = [];
    let colors = [];
    let currentJobEvents = []; // Events for current job being edited
    
    // Initialize
    async function init() {
      await loadData();
      renderPipeline();
      setupViewToggle();
    }
    
    async function loadData() {
      try {
        const supabase = await app.waitForSupabase();
        
        // Load all data in parallel
        const [stagesRes, jobsRes, customersRes, quotesRes, eventTypesRes, jobEventsRes] = await Promise.all([
          supabase.from('job_stages').select('*').order('sort_order'),
          supabase.from('jobs').select('*, customers(name, email, phone)').order('created_at', { ascending: false }),
          supabase.from('customers').select('id, name, email').order('name'),
          supabase.from('quotes').select('id, quote_number, title, customer_id, total').eq('status', 'sent').or('status.eq.viewed').order('created_at', { ascending: false }),
          supabase.from('job_event_types').select('*').eq('is_active', true).order('sort_order'),
          supabase.from('job_events').select('*, job_event_types(*)').order('event_date')
        ]);
        
        if (stagesRes.error) throw stagesRes.error;
        if (jobsRes.error) throw jobsRes.error;
        if (customersRes.error) throw customersRes.error;
        
        stages = stagesRes.data || [];
        jobs = jobsRes.data || [];
        customers = customersRes.data || [];
        quotes = quotesRes.data || [];
        eventTypes = eventTypesRes.data || [];
        jobEvents = jobEventsRes.data || [];
        
        // Update summary
        const totalJobs = jobs.length;
        const totalValue = jobs.reduce((sum, j) => sum + (parseFloat(j.estimated_value) || 0), 0);
        $('#job-summary').textContent = `${totalJobs} jobs ‚Ä¢ ${formatCurrency(totalValue)} total value`;
        
        // Populate dropdowns
        populateDropdowns();
        
        // Update calendar legend
        renderCalendarLegend();
        
      } catch (err) {
        console.error('Error loading data:', err);
        showToast('Failed to load data', 'error');
      }
    }
    
    function renderCalendarLegend() {
      const legend = $('#calendar-legend');
      if (!legend) return;
      
      legend.innerHTML = eventTypes.map(et => `
        <div class="calendar-legend-item">
          <span class="calendar-legend-dot" style="background: ${et.color};"></span>
          <span>${et.icon} ${et.name}</span>
        </div>
      `).join('');
    }
    
    function populateDropdowns() {
      // Customer dropdown
      const customerSelect = $('#job-customer');
      customerSelect.innerHTML = '<option value="">Select customer...</option>';
      customers.forEach(c => {
        customerSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
      });
      
      // Stage dropdown
      const stageSelect = $('#job-stage');
      stageSelect.innerHTML = '';
      stages.forEach(s => {
        stageSelect.innerHTML += `<option value="${s.stage_id}">${s.label}</option>`;
      });
      
      // Quote dropdown
      const quoteSelect = $('#job-quote');
      quoteSelect.innerHTML = '<option value="">None</option>';
      quotes.forEach(q => {
        quoteSelect.innerHTML += `<option value="${q.id}">${q.quote_number} - ${q.title}</option>`;
      });
    }
    
    function renderPipeline() {
      const container = $('#pipeline-container');
      container.innerHTML = '';
      
      stages.forEach(stage => {
        const stageJobs = jobs.filter(j => j.stage === stage.stage_id);
        
        const column = createElement('div', {
          className: 'pipeline-column',
          dataset: { stage: stage.stage_id }
        });
        
        // Header
        column.innerHTML = `
          <div class="column-header">
            <span class="stage-dot" style="background-color: ${stage.color}"></span>
            <span class="column-title">${stage.label}</span>
            <span class="column-count">${stageJobs.length}</span>
          </div>
        `;
        
        // Content
        const content = createElement('div', { className: 'column-content drop-zone' });
        
        if (stageJobs.length === 0) {
          content.innerHTML = '<div class="empty-column">No jobs in this stage</div>';
        } else {
          stageJobs.forEach(job => {
            const card = createJobCard(job);
            content.appendChild(card);
          });
        }
        
        // Drag & drop events
        content.addEventListener('dragover', (e) => {
          e.preventDefault();
          content.classList.add('drag-over');
        });
        
        content.addEventListener('dragleave', () => {
          content.classList.remove('drag-over');
        });
        
        content.addEventListener('drop', async (e) => {
          e.preventDefault();
          content.classList.remove('drag-over');
          if (draggedJob && draggedJob.stage !== stage.stage_id) {
            await updateJobStage(draggedJob.id, stage.stage_id);
          }
        });
        
        column.appendChild(content);
        container.appendChild(column);
      });
    }
    
    function createJobCard(job) {
      const card = createElement('div', {
        className: 'job-card',
        draggable: true,
        dataset: { id: job.id }
      });
      
      const customer = job.customers;
      const totalQty = (job.job_items || []).reduce((sum, item) => sum + (parseInt(item.quantity) || 0), 0);
      
      // Get upcoming events for this job
      const thisJobEvents = jobEvents
        .filter(e => e.job_id === job.id)
        .sort((a, b) => new Date(a.event_date) - new Date(b.event_date))
        .slice(0, 2); // Show max 2 events
      
      let html = `
        <div class="job-card-title">${job.name || 'Untitled'}</div>
        ${customer ? `<div class="job-card-customer">${customer.name}</div>` : ''}
      `;
      
      if (totalQty > 0) {
        html += `<div class="job-card-stats"><span class="job-card-stat">üì¶ ${totalQty} pcs</span></div>`;
      }
      
      if (thisJobEvents.length > 0) {
        html += '<div class="job-card-dates">';
        thisJobEvents.forEach(event => {
          const eventType = event.job_event_types || eventTypes.find(et => et.id === event.event_type_id);
          if (eventType) {
            html += `<div class="job-card-date">${eventType.icon} ${eventType.name}: ${formatDate(event.event_date)}</div>`;
          }
        });
        html += '</div>';
      }
      
      if (job.estimated_value) {
        html += `<div class="job-card-value">${formatCurrency(job.estimated_value)}</div>`;
      }
      
      card.innerHTML = html;
      
      // Drag events
      card.addEventListener('dragstart', () => {
        draggedJob = job;
        card.classList.add('dragging');
      });
      
      card.addEventListener('dragend', () => {
        draggedJob = null;
        card.classList.remove('dragging');
      });
      
      // Click to edit
      card.addEventListener('click', () => openJobModal(job));
      
      return card;
    }
    
    async function updateJobStage(jobId, newStage) {
      try {
        const supabase = await app.waitForSupabase();
        const { error } = await supabase
          .from('jobs')
          .update({ stage: newStage, updated_at: new Date().toISOString() })
          .eq('id', jobId);
        
        if (error) throw error;
        
        // Update local data
        const job = jobs.find(j => j.id === jobId);
        if (job) job.stage = newStage;
        
        renderPipeline();
        showToast('Job moved', 'success');
        
      } catch (err) {
        console.error('Error updating job:', err);
        showToast('Failed to move job', 'error');
      }
    }
    
    // Job Modal
    function openJobModal(job = null) {
      const modal = $('#job-modal');
      const title = $('#job-modal-title');
      const deleteBtn = $('#delete-job-btn');
      
      // Reset form
      jobItems = [];
      colors = [];
      currentJobEvents = [];
      renderJobItems();
      renderColors();
      renderJobEvents();
      
      if (job) {
        title.textContent = 'Edit Job';
        deleteBtn.style.display = 'block';
        $('#job-id').value = job.id;
        $('#job-name').value = job.name || '';
        $('#job-customer').value = job.customer_id || '';
        $('#job-stage').value = job.stage || stages[0]?.stage_id;
        $('#job-value').value = job.estimated_value || '';
        $('#job-quote').value = job.quote_id || '';
        $('#job-materials').value = job.refacing_materials || '';
        $('#job-notes').value = job.notes || '';
        
        jobItems = job.job_items || [];
        colors = job.colors || [];
        
        // Load events for this job
        currentJobEvents = jobEvents
          .filter(e => e.job_id === job.id)
          .map(e => ({
            id: e.id,
            event_type_id: e.event_type_id,
            event_date: e.event_date,
            notes: e.notes || '',
            isExisting: true
          }));
        
        renderJobItems();
        renderColors();
        renderJobEvents();
      } else {
        title.textContent = 'New Job';
        deleteBtn.style.display = 'none';
        $('#job-form').reset();
        $('#job-id').value = '';
        $('#job-stage').value = stages[0]?.stage_id || 'quotes';
      }
      
      modal.classList.add('active');
    }
    
    function closeJobModal() {
      $('#job-modal').classList.remove('active');
    }
    
    async function saveJob() {
      const id = $('#job-id').value;
      const data = {
        name: $('#job-name').value,
        customer_id: $('#job-customer').value || null,
        stage: $('#job-stage').value,
        estimated_value: parseFloat($('#job-value').value) || null,
        quote_id: $('#job-quote').value || null,
        refacing_materials: $('#job-materials').value,
        notes: $('#job-notes').value,
        job_items: jobItems,
        colors: colors,
        updated_at: new Date().toISOString()
      };
      
      if (!data.name) {
        showToast('Job name is required', 'error');
        return;
      }
      
      try {
        const supabase = await app.waitForSupabase();
        let jobId = id;
        
        if (id) {
          const { error } = await supabase.from('jobs').update(data).eq('id', id);
          if (error) throw error;
        } else {
          // Generate job number for new jobs
          const { data: numData } = await supabase.rpc('generate_job_number');
          data.job_number = numData;
          
          const { data: newJob, error } = await supabase.from('jobs').insert([data]).select().single();
          if (error) throw error;
          jobId = newJob.id;
        }
        
        // Save job events
        await saveJobEvents(supabase, jobId);
        
        closeJobModal();
        await loadData();
        renderPipeline();
        showToast(id ? 'Job updated' : 'Job created', 'success');
        
      } catch (err) {
        console.error('Error saving job:', err);
        showToast('Failed to save job: ' + err.message, 'error');
      }
    }
    
    async function saveJobEvents(supabase, jobId) {
      // Get existing events for this job
      const existingIds = currentJobEvents.filter(e => e.isExisting).map(e => e.id);
      
      // Delete events that were removed
      const { data: dbEvents } = await supabase.from('job_events').select('id').eq('job_id', jobId);
      const dbEventIds = (dbEvents || []).map(e => e.id);
      const toDelete = dbEventIds.filter(id => !existingIds.includes(id));
      
      if (toDelete.length > 0) {
        await supabase.from('job_events').delete().in('id', toDelete);
      }
      
      // Upsert all current events
      for (const event of currentJobEvents) {
        if (!event.event_type_id || !event.event_date) continue;
        
        const eventData = {
          job_id: jobId,
          event_type_id: event.event_type_id,
          event_date: event.event_date,
          notes: event.notes || null
        };
        
        if (event.isExisting && event.id) {
          await supabase.from('job_events').update(eventData).eq('id', event.id);
        } else {
          await supabase.from('job_events').insert([eventData]);
        }
      }
    }
    
    async function deleteJob() {
      const id = $('#job-id').value;
      if (!id || !confirm('Delete this job?')) return;
      
      try {
        const supabase = await app.waitForSupabase();
        const { error } = await supabase.from('jobs').delete().eq('id', id);
        if (error) throw error;
        
        closeJobModal();
        await loadData();
        renderPipeline();
        showToast('Job deleted', 'success');
        
      } catch (err) {
        console.error('Error deleting job:', err);
        showToast('Failed to delete job', 'error');
      }
    }
    
    // Job Items
    function addJobItem() {
      jobItems.push({ id: crypto.randomUUID(), name: '', quantity: '' });
      renderJobItems();
    }
    
    function removeJobItem(id) {
      jobItems = jobItems.filter(item => item.id !== id);
      renderJobItems();
    }
    
    function renderJobItems() {
      const container = $('#job-items-container');
      const noMsg = $('#no-items-msg');
      
      if (jobItems.length === 0) {
        noMsg.style.display = 'block';
        container.querySelectorAll('.job-item-row').forEach(el => el.remove());
        return;
      }
      
      noMsg.style.display = 'none';
      container.querySelectorAll('.job-item-row').forEach(el => el.remove());
      
      jobItems.forEach(item => {
        const row = createElement('div', { className: 'job-item-row' });
        row.innerHTML = `
          <input type="text" class="form-input" style="flex: 2;" placeholder="Item name" value="${item.name}" onchange="updateJobItem('${item.id}', 'name', this.value)">
          <input type="number" class="form-input" style="width: 80px;" placeholder="Qty" value="${item.quantity}" onchange="updateJobItem('${item.id}', 'quantity', this.value)">
          <button type="button" class="btn btn-sm" style="color: var(--color-danger);" onclick="removeJobItem('${item.id}')">√ó</button>
        `;
        container.appendChild(row);
      });
    }
    
    function updateJobItem(id, field, value) {
      const item = jobItems.find(i => i.id === id);
      if (item) item[field] = value;
    }
    
    // Job Events
    function addJobEvent() {
      currentJobEvents.push({ 
        id: crypto.randomUUID(), 
        event_type_id: eventTypes[0]?.id || '', 
        event_date: '', 
        notes: '',
        isExisting: false
      });
      renderJobEvents();
    }
    
    function removeJobEvent(id) {
      currentJobEvents = currentJobEvents.filter(e => e.id !== id);
      renderJobEvents();
    }
    
    function renderJobEvents() {
      const container = $('#job-events-container');
      const noMsg = $('#no-events-msg');
      
      if (currentJobEvents.length === 0) {
        noMsg.style.display = 'block';
        container.querySelectorAll('.job-event-row').forEach(el => el.remove());
        return;
      }
      
      noMsg.style.display = 'none';
      container.querySelectorAll('.job-event-row').forEach(el => el.remove());
      
      currentJobEvents.forEach(event => {
        const eventType = eventTypes.find(et => et.id === event.event_type_id);
        const row = createElement('div', { className: 'job-event-row job-item-row' });
        row.innerHTML = `
          <select class="form-input" style="flex: 1;" onchange="updateJobEvent('${event.id}', 'event_type_id', this.value)">
            ${eventTypes.map(et => `<option value="${et.id}" ${et.id === event.event_type_id ? 'selected' : ''}>${et.icon} ${et.name}</option>`).join('')}
          </select>
          <input type="date" class="form-input" style="width: 150px;" value="${event.event_date || ''}" onchange="updateJobEvent('${event.id}', 'event_date', this.value)">
          <input type="text" class="form-input" style="flex: 1;" placeholder="Notes (optional)" value="${event.notes || ''}" onchange="updateJobEvent('${event.id}', 'notes', this.value)">
          <button type="button" class="btn btn-sm" style="color: var(--color-danger);" onclick="removeJobEvent('${event.id}')">√ó</button>
        `;
        container.appendChild(row);
      });
    }
    
    function updateJobEvent(id, field, value) {
      const event = currentJobEvents.find(e => e.id === id);
      if (event) event[field] = value;
    }
    
    // Event Types Modal
    function openEventTypesModal() {
      renderEventTypesList();
      $('#event-types-modal').classList.add('active');
    }
    
    function closeEventTypesModal() {
      $('#event-types-modal').classList.remove('active');
      $('#add-event-type-form').style.display = 'none';
    }
    
    function renderEventTypesList() {
      const container = $('#event-types-list');
      container.innerHTML = '';
      
      eventTypes.forEach((et, idx) => {
        const item = createElement('div', { className: 'stage-item' });
        item.innerHTML = `
          <span style="font-size: 1.25rem;">${et.icon}</span>
          <span class="stage-dot" style="background-color: ${et.color}"></span>
          <span class="stage-item-label">${et.name}</span>
          <div class="stage-item-actions">
            <button class="btn btn-sm" onclick="moveEventType('${et.id}', 'up')" ${idx === 0 ? 'disabled' : ''}>‚Üë</button>
            <button class="btn btn-sm" onclick="moveEventType('${et.id}', 'down')" ${idx === eventTypes.length - 1 ? 'disabled' : ''}>‚Üì</button>
            <button class="btn btn-sm" style="color: var(--color-danger);" onclick="deleteEventType('${et.id}')">√ó</button>
          </div>
        `;
        container.appendChild(item);
      });
    }
    
    function showAddEventTypeForm() {
      $('#add-event-type-form').style.display = 'block';
      $('#new-event-type-name').value = '';
      $('#new-event-type-icon').value = 'üìÖ';
      $('#new-event-type-name').focus();
    }
    
    function cancelAddEventType() {
      $('#add-event-type-form').style.display = 'none';
    }
    
    async function saveNewEventType() {
      const name = $('#new-event-type-name').value.trim();
      const icon = $('#new-event-type-icon').value.trim() || 'üìÖ';
      const color = $('#new-event-type-color').value;
      
      if (!name) {
        showToast('Event type name is required', 'error');
        return;
      }
      
      const maxOrder = Math.max(...eventTypes.map(et => et.sort_order), -1);
      
      try {
        const supabase = await app.waitForSupabase();
        const { error } = await supabase.from('job_event_types').insert([{
          name: name,
          icon: icon,
          color: color,
          sort_order: maxOrder + 1
        }]);
        
        if (error) throw error;
        
        await loadData();
        renderEventTypesList();
        renderCalendarLegend();
        cancelAddEventType();
        showToast('Event type added', 'success');
        
      } catch (err) {
        console.error('Error adding event type:', err);
        showToast('Failed to add event type', 'error');
      }
    }
    
    async function deleteEventType(id) {
      if (!confirm('Delete this event type? Events using this type will also be deleted.')) return;
      
      try {
        const supabase = await app.waitForSupabase();
        const { error } = await supabase.from('job_event_types').delete().eq('id', id);
        if (error) throw error;
        
        await loadData();
        renderEventTypesList();
        renderCalendarLegend();
        showToast('Event type deleted', 'success');
        
      } catch (err) {
        console.error('Error deleting event type:', err);
        showToast('Failed to delete event type', 'error');
      }
    }
    
    async function moveEventType(id, direction) {
      const idx = eventTypes.findIndex(et => et.id === id);
      if (idx === -1) return;
      
      const newIdx = direction === 'up' ? idx - 1 : idx + 1;
      if (newIdx < 0 || newIdx >= eventTypes.length) return;
      
      try {
        const supabase = await app.waitForSupabase();
        const et1 = eventTypes[idx];
        const et2 = eventTypes[newIdx];
        
        await supabase.from('job_event_types').update({ sort_order: et2.sort_order }).eq('id', et1.id);
        await supabase.from('job_event_types').update({ sort_order: et1.sort_order }).eq('id', et2.id);
        
        await loadData();
        renderEventTypesList();
        renderCalendarLegend();
        
      } catch (err) {
        console.error('Error reordering event types:', err);
      }
    }
    
    // Colors
    function addColor() {
      colors.push({ id: crypto.randomUUID(), name: '', colorName: '', primer: '', topcoat: '', sheen: '' });
      renderColors();
    }
    
    function removeColor(id) {
      colors = colors.filter(c => c.id !== id);
      renderColors();
    }
    
    function renderColors() {
      const container = $('#colors-container');
      const noMsg = $('#no-colors-msg');
      
      if (colors.length === 0) {
        noMsg.style.display = 'block';
        container.querySelectorAll('.color-card').forEach(el => el.remove());
        return;
      }
      
      noMsg.style.display = 'none';
      container.querySelectorAll('.color-card').forEach(el => el.remove());
      
      colors.forEach((color, idx) => {
        const card = createElement('div', { className: 'color-card card mb-sm' });
        card.innerHTML = `
          <div class="card-body">
            <div class="flex items-center justify-between mb-sm">
              <strong>Color ${idx + 1}</strong>
              <button type="button" class="btn btn-sm" style="color: var(--color-danger);" onclick="removeColor('${color.id}')">√ó</button>
            </div>
            <div class="grid grid-cols-2 gap-sm">
              <input type="text" class="form-input" placeholder="Location (e.g., Uppers)" value="${color.name || ''}" onchange="updateColor('${color.id}', 'name', this.value)">
              <input type="text" class="form-input" placeholder="Color name" value="${color.colorName || ''}" onchange="updateColor('${color.id}', 'colorName', this.value)">
              <input type="text" class="form-input" placeholder="Primer" value="${color.primer || ''}" onchange="updateColor('${color.id}', 'primer', this.value)">
              <input type="text" class="form-input" placeholder="Topcoat" value="${color.topcoat || ''}" onchange="updateColor('${color.id}', 'topcoat', this.value)">
              <input type="text" class="form-input" placeholder="Sheen" value="${color.sheen || ''}" onchange="updateColor('${color.id}', 'sheen', this.value)">
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }
    
    function updateColor(id, field, value) {
      const color = colors.find(c => c.id === id);
      if (color) color[field] = value;
    }
    
    // Stage Settings
    function openStageSettings() {
      renderStageList();
      $('#stage-modal').classList.add('active');
    }
    
    function closeStageSettings() {
      $('#stage-modal').classList.remove('active');
      $('#add-stage-form').style.display = 'none';
    }
    
    function renderStageList() {
      const container = $('#stage-list');
      container.innerHTML = '';
      
      stages.forEach((stage, idx) => {
        const item = createElement('div', { className: 'stage-item' });
        item.innerHTML = `
          <span class="stage-dot" style="background-color: ${stage.color}"></span>
          <span class="stage-item-label">${stage.label}</span>
          <div class="stage-item-actions">
            <button class="btn btn-sm" onclick="moveStage('${stage.id}', 'up')" ${idx === 0 ? 'disabled' : ''}>‚Üë</button>
            <button class="btn btn-sm" onclick="moveStage('${stage.id}', 'down')" ${idx === stages.length - 1 ? 'disabled' : ''}>‚Üì</button>
            <button class="btn btn-sm" style="color: var(--color-danger);" onclick="deleteStage('${stage.id}')">√ó</button>
          </div>
        `;
        container.appendChild(item);
      });
    }
    
    function showAddStageForm() {
      $('#add-stage-form').style.display = 'block';
      $('#new-stage-label').value = '';
      $('#new-stage-label').focus();
    }
    
    function cancelAddStage() {
      $('#add-stage-form').style.display = 'none';
    }
    
    async function saveNewStage() {
      const label = $('#new-stage-label').value.trim();
      const color = $('#new-stage-color').value;
      
      if (!label) {
        showToast('Stage name is required', 'error');
        return;
      }
      
      const stageId = label.toLowerCase().replace(/\s+/g, '-');
      const maxOrder = Math.max(...stages.map(s => s.sort_order), -1);
      
      try {
        const supabase = await app.waitForSupabase();
        const { error } = await supabase.from('job_stages').insert([{
          stage_id: stageId,
          label: label,
          color: color,
          sort_order: maxOrder + 1
        }]);
        
        if (error) throw error;
        
        await loadData();
        renderStageList();
        renderPipeline();
        cancelAddStage();
        showToast('Stage added', 'success');
        
      } catch (err) {
        console.error('Error adding stage:', err);
        showToast('Failed to add stage', 'error');
      }
    }
    
    async function deleteStage(id) {
      if (!confirm('Delete this stage? Jobs in this stage will need to be reassigned.')) return;
      
      try {
        const supabase = await app.waitForSupabase();
        const { error } = await supabase.from('job_stages').delete().eq('id', id);
        if (error) throw error;
        
        await loadData();
        renderStageList();
        renderPipeline();
        showToast('Stage deleted', 'success');
        
      } catch (err) {
        console.error('Error deleting stage:', err);
        showToast('Failed to delete stage', 'error');
      }
    }
    
    async function moveStage(id, direction) {
      const idx = stages.findIndex(s => s.id === id);
      if (idx === -1) return;
      
      const newIdx = direction === 'up' ? idx - 1 : idx + 1;
      if (newIdx < 0 || newIdx >= stages.length) return;
      
      try {
        const supabase = await app.waitForSupabase();
        const stage1 = stages[idx];
        const stage2 = stages[newIdx];
        
        await supabase.from('job_stages').update({ sort_order: stage2.sort_order }).eq('id', stage1.id);
        await supabase.from('job_stages').update({ sort_order: stage1.sort_order }).eq('id', stage2.id);
        
        await loadData();
        renderStageList();
        renderPipeline();
        
      } catch (err) {
        console.error('Error reordering stages:', err);
      }
    }
    
    // View Toggle
    function setupViewToggle() {
      $$('.view-toggle button').forEach(btn => {
        btn.addEventListener('click', () => {
          $$('.view-toggle button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          const view = btn.dataset.view;
          $('#pipeline-view').style.display = view === 'pipeline' ? 'block' : 'none';
          $('#calendar-view').style.display = view === 'calendar' ? 'block' : 'none';
          $('#list-view').style.display = view === 'list' ? 'block' : 'none';
          
          if (view === 'list') renderListView();
          if (view === 'calendar') renderCalendar();
        });
      });
    }
    
    // Calendar
    let currentCalendarDate = new Date();
    
    function prevMonth() {
      currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() - 1, 1);
      renderCalendar();
    }
    
    function nextMonth() {
      currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 1);
      renderCalendar();
    }
    
    function goToToday() {
      currentCalendarDate = new Date();
      renderCalendar();
    }
    
    function renderCalendar() {
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
      const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      
      // Update title
      $('#calendar-title').textContent = `${monthNames[month]} ${year}`;
      
      // Get first day of month and days in month
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      
      // Get days from previous month to fill first week
      const prevMonthLastDay = new Date(year, month, 0).getDate();
      
      // Build events lookup
      const events = buildEventsLookup(year, month);
      
      // Today's date for comparison
      const today = new Date();
      const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
      
      // Build calendar HTML
      let html = '';
      
      // Day headers
      dayNames.forEach(day => {
        html += `<div class="calendar-day-header">${day}</div>`;
      });
      
      // Calendar days
      let dayCount = 1;
      let nextMonthDay = 1;
      
      // Calculate total cells needed (6 weeks max)
      const totalCells = Math.ceil((startDayOfWeek + daysInMonth) / 7) * 7;
      
      for (let i = 0; i < totalCells; i++) {
        let dayNum, isOtherMonth = false, dateStr;
        
        if (i < startDayOfWeek) {
          // Previous month
          dayNum = prevMonthLastDay - startDayOfWeek + i + 1;
          isOtherMonth = true;
          const prevMonth = month === 0 ? 11 : month - 1;
          const prevYear = month === 0 ? year - 1 : year;
          dateStr = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
        } else if (dayCount > daysInMonth) {
          // Next month
          dayNum = nextMonthDay++;
          isOtherMonth = true;
          const nextMonth = month === 11 ? 0 : month + 1;
          const nextYear = month === 11 ? year + 1 : year;
          dateStr = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
        } else {
          // Current month
          dayNum = dayCount++;
          dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
        }
        
        const isToday = isCurrentMonth && !isOtherMonth && dayNum === today.getDate();
        const dayEvents = events[dateStr] || [];
        
        html += `
          <div class="calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}">
            <span class="calendar-day-number">${dayNum}</span>
            <div class="calendar-events">
              ${renderDayEvents(dayEvents)}
            </div>
          </div>
        `;
      }
      
      $('#calendar-grid').innerHTML = html;
    }
    
    function buildEventsLookup(year, month) {
      const events = {};
      
      // Use job events from the jobEvents array
      jobEvents.forEach(event => {
        if (!event.event_date) return;
        
        const dateStr = event.event_date;
        const job = jobs.find(j => j.id === event.job_id);
        const eventType = event.job_event_types || eventTypes.find(et => et.id === event.event_type_id);
        
        if (!job || !eventType) return;
        
        if (!events[dateStr]) events[dateStr] = [];
        events[dateStr].push({
          eventType: eventType,
          job: job,
          event: event,
          label: `${eventType.icon} ${job.name}`
        });
      });
      
      return events;
    }
    
    function renderDayEvents(dayEvents) {
      if (dayEvents.length === 0) return '';
      
      const maxVisible = 3;
      let html = '';
      
      dayEvents.slice(0, maxVisible).forEach(event => {
        const bgColor = hexToRgba(event.eventType.color, 0.15);
        const textColor = darkenColor(event.eventType.color, 30);
        html += `
          <div class="calendar-event" 
               style="background: ${bgColor}; color: ${textColor}; border-left: 3px solid ${event.eventType.color};"
               onclick="openJobModal(jobs.find(j => j.id === '${event.job.id}'))" 
               title="${event.eventType.name}: ${event.job.name}${event.job.customers ? ' - ' + event.job.customers.name : ''}">
            ${event.label}
          </div>
        `;
      });
      
      if (dayEvents.length > maxVisible) {
        html += `<div class="calendar-more">+${dayEvents.length - maxVisible} more</div>`;
      }
      
      return html;
    }
    
    // Color helper functions
    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }
    
    function darkenColor(hex, percent) {
      const r = Math.max(0, parseInt(hex.slice(1, 3), 16) - percent);
      const g = Math.max(0, parseInt(hex.slice(3, 5), 16) - percent);
      const b = Math.max(0, parseInt(hex.slice(5, 7), 16) - percent);
      return `rgb(${r}, ${g}, ${b})`;
    }
    
    function renderListView() {
      const tbody = $('#jobs-table-body');
      tbody.innerHTML = '';
      
      jobs.forEach(job => {
        const stage = stages.find(s => s.stage_id === job.stage);
        // Get events for this job
        const thisJobEvents = jobEvents.filter(e => e.job_id === job.id);
        const nextEvent = thisJobEvents.sort((a, b) => new Date(a.event_date) - new Date(b.event_date))[0];
        
        const tr = createElement('tr');
        tr.innerHTML = `
          <td>
            <strong>${job.name}</strong>
            ${job.job_number ? `<br><span class="text-muted text-sm">${job.job_number}</span>` : ''}
          </td>
          <td>${job.customers?.name || '‚Äî'}</td>
          <td><span class="badge" style="background-color: ${stage?.color || '#666'}; color: white;">${stage?.label || job.stage}</span></td>
          <td>${nextEvent ? formatDate(nextEvent.event_date) : '‚Äî'}</td>
          <td>${thisJobEvents.length} event${thisJobEvents.length !== 1 ? 's' : ''}</td>
          <td>${job.estimated_value ? formatCurrency(job.estimated_value) : '‚Äî'}</td>
          <td><button class="btn btn-sm btn-secondary" onclick="openJobModal(jobs.find(j => j.id === '${job.id}'))">Edit</button></td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Initialize
    init();
  </script>
</body>
</html>
