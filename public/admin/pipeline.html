<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deals Pipeline | Admin | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css?v=33">
  <style>
    .pipeline-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: var(--space-md); width: 100%; }
    .pipeline-header h2 { margin: 0; white-space: nowrap; }
    .pipeline-actions { display: flex; gap: var(--space-sm); flex-wrap: wrap; align-items: center; flex-shrink: 0; }
    .pipeline-container { display: flex; gap: var(--space-md); overflow-x: auto; padding-bottom: var(--space-lg); min-height: calc(100vh - 200px); max-width: 100%; }
    .pipeline-column { flex: 0 0 260px; background: var(--color-bg-soft); border-radius: var(--radius-lg); display: flex; flex-direction: column; max-height: calc(100vh - 200px); }
    .column-header { padding: var(--space-md); border-bottom: 1px solid var(--color-border); display: flex; align-items: center; gap: var(--space-sm); position: sticky; top: 0; background: var(--color-bg-soft); border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
    .stage-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .column-title { font-weight: 600; font-size: 0.8rem; color: var(--color-text); flex: 1; }
    .column-count { background: var(--color-bg); color: var(--color-text-muted); font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
    .column-content { flex: 1; overflow-y: auto; padding: var(--space-sm); }
    .deal-card { background: white; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-sm); cursor: grab; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .deal-card:hover { border-color: var(--color-primary); box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15); }
    .deal-card.dragging { opacity: 0.5; cursor: grabbing; }
    .deal-card-title { font-weight: 600; font-size: 0.875rem; color: var(--color-text); margin-bottom: 4px; }
    .deal-card-customer { font-size: 0.8125rem; color: var(--color-text-muted); margin-bottom: var(--space-sm); }
    .deal-card-dates { font-size: 0.75rem; color: var(--color-text-muted); }
    .deal-card-date { margin-top: 2px; }
    .deal-card-value { font-size: 0.8125rem; font-weight: 600; color: var(--color-primary); margin-top: var(--space-sm); }
    .empty-column { text-align: center; padding: var(--space-xl); color: var(--color-text-muted); font-size: 0.8125rem; }
    .drop-zone { min-height: 100px; border: 2px dashed transparent; border-radius: var(--radius-md); transition: all 0.2s; }
    .drop-zone.drag-over { border-color: var(--color-primary); background: rgba(99, 102, 241, 0.05); }
    
    /* Dropdown */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-btn { display: flex; align-items: center; gap: var(--space-xs); }
    .dropdown-btn svg.chevron { width: 14px; height: 14px; transition: transform 0.2s; }
    .dropdown.open .dropdown-btn svg.chevron { transform: rotate(180deg); }
    .dropdown-menu { position: absolute; top: 100%; right: 0; margin-top: 4px; background: white; border: 1px solid var(--color-border); border-radius: var(--radius-md); box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 100; display: none; }
    .dropdown.open .dropdown-menu { display: block; }
    .dropdown-item { display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm) var(--space-md); cursor: pointer; font-size: 0.875rem; color: var(--color-text); transition: background 0.15s; }
    .dropdown-item:hover { background: var(--color-bg-soft); }
    .dropdown-item:first-child { border-radius: var(--radius-md) var(--radius-md) 0 0; }
    .dropdown-item:last-child { border-radius: 0 0 var(--radius-md) var(--radius-md); }
    .dropdown-icon { font-size: 1rem; }
    
    /* Calendar */
    .calendar-container { background: white; border-radius: var(--radius-lg); border: 1px solid var(--color-border); overflow: hidden; }
    .calendar-header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-lg); background: var(--color-bg-soft); border-bottom: 1px solid var(--color-border); }
    .calendar-nav { display: flex; align-items: center; gap: var(--space-md); }
    .calendar-nav-btn { width: 36px; height: 36px; border: 1px solid var(--color-border); background: white; border-radius: var(--radius-md); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: var(--color-text-muted); }
    .calendar-nav-btn:hover { background: var(--color-bg-soft); color: var(--color-primary); }
    .calendar-title { font-size: 1.25rem; font-weight: 600; color: var(--color-text); min-width: 200px; text-align: center; }
    .calendar-today-btn { padding: var(--space-sm) var(--space-md); border: 1px solid var(--color-border); background: white; border-radius: var(--radius-md); cursor: pointer; font-size: 0.875rem; }
    .calendar-today-btn:hover { background: var(--color-primary); color: white; border-color: var(--color-primary); }
    .calendar-legend { display: flex; gap: var(--space-lg); padding: var(--space-sm) var(--space-lg); background: var(--color-bg-soft); border-bottom: 1px solid var(--color-border); flex-wrap: wrap; }
    .calendar-legend-item { display: flex; align-items: center; gap: var(--space-xs); font-size: 0.75rem; color: var(--color-text-muted); }
    .calendar-legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
    .calendar-day-header { padding: var(--space-sm); text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--color-text-muted); text-transform: uppercase; background: var(--color-bg-soft); border-bottom: 1px solid var(--color-border); }
    .calendar-day { min-height: 100px; border-right: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border); padding: var(--space-xs); background: white; }
    .calendar-day:nth-child(7n) { border-right: none; }
    .calendar-day.other-month { background: var(--color-bg-soft); }
    .calendar-day.other-month .calendar-day-number { color: var(--color-text-muted); }
    .calendar-day.today { background: rgba(99, 102, 241, 0.05); }
    .calendar-day.today .calendar-day-number { background: var(--color-primary); color: white; }
    .calendar-day-number { display: inline-flex; align-items: center; justify-content: center; width: 26px; height: 26px; border-radius: 50%; font-size: 0.8rem; font-weight: 500; color: var(--color-text); margin-bottom: var(--space-xs); }
    .calendar-events { display: flex; flex-direction: column; gap: 2px; }
    .calendar-event { padding: 2px 5px; border-radius: 3px; font-size: 0.65rem; font-weight: 500; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .calendar-event:hover { transform: scale(1.02); }
    .calendar-more { font-size: 0.65rem; color: var(--color-text-muted); padding: 2px 5px; cursor: pointer; }
    
    /* View toggle */
    .view-toggle { display: flex; background: var(--color-bg-soft); border-radius: var(--radius-md); padding: 3px; }
    .view-toggle button { padding: var(--space-xs) var(--space-sm); border: none; background: transparent; color: var(--color-text-muted); cursor: pointer; border-radius: var(--radius-sm); font-size: 0.75rem; }
    .view-toggle button.active { background: white; color: var(--color-primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    
    /* Form sections */
    .form-section { margin-top: var(--space-lg); padding-top: var(--space-lg); border-top: 1px solid var(--color-border); }
    .form-section-title { font-weight: 600; font-size: 0.9rem; color: var(--color-text); margin-bottom: var(--space-md); display: flex; align-items: center; justify-content: space-between; }
    .event-row, .item-row { display: flex; gap: var(--space-sm); align-items: center; padding: var(--space-sm) 0; border-bottom: 1px solid var(--color-border-light); }
    .event-row:last-child, .item-row:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <script>
    // Permission check before page loads
    const user = JSON.parse(localStorage.getItem('app_user') || 'null');
    if (!user) {
      window.location.href = '/admin/login.html';
    } else if (!user.permissions?.can_view_pipeline) {
      window.location.href = '/admin/index.html';
    }
  </script>
  <div class="app-layout">
    <aside class="app-sidebar">
      <div class="sidebar-logo">
        <img src="/images/logo.gif" alt="Homestead Cabinet Design" style="height: 40px; filter: brightness(0) invert(1);">
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item"><a href="/admin/index.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard</a></li>
          <li class="sidebar-nav-item"><a href="/admin/pipeline.html" class="sidebar-nav-link active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Deals Pipeline</a></li>
          <li class="sidebar-nav-item"><a href="/admin/customers.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Customers</a></li>
          <li class="sidebar-nav-item"><a href="/admin/quotes.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>Quotes</a></li>
          <li class="sidebar-nav-item"><a href="/admin/invoices.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>Invoices</a></li>
        </ul>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Lead Capture</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/booking-forms.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>Booking Forms</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Catalog</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/catalog.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>Items Catalog</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/settings.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</a></li>
          </ul>
        </div>
      </nav>
    </aside>
    
    <main class="app-main">
      <header class="app-header" style="flex-wrap: wrap;">
        <div class="pipeline-header" style="flex: 1; min-width: 0;">
          <div class="pipeline-actions">
            <div class="view-toggle">
              <button class="active" data-view="pipeline">Pipeline</button>
              <button data-view="calendar">Calendar</button>
              <button data-view="list">List</button>
            </div>
            <button class="btn btn-primary btn-sm" onclick="openDealModal()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              New Deal
            </button>
            
            <!-- New Appointment Dropdown -->
            <div class="dropdown" id="appt-dropdown">
              <button class="btn btn-secondary btn-sm dropdown-btn" onclick="toggleDropdown('appt-dropdown')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                Appt
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
              <div class="dropdown-menu" id="appt-type-menu"></div>
            </div>
            
            <button class="btn btn-secondary btn-sm" onclick="openStageSettings()">Stages</button>
          </div>
          <div style="min-width: 0; text-align: right;">
            <h2 style="font-size: 1rem; margin: 0;">Deals Pipeline</h2>
            <p class="text-muted" id="pipeline-summary" style="font-size: 0.75rem; margin: 0;">Loading...</p>
          </div>
        </div>
      </header>
      
      <div class="app-content" style="padding: var(--space-md); overflow: hidden;">
        <div id="pipeline-view" style="overflow-x: auto; max-width: 100%;"><div class="pipeline-container" id="pipeline-container"></div></div>
        <div id="calendar-view" style="display:none;">
          <div class="calendar-container">
            <div class="calendar-header">
              <div class="calendar-nav">
                <button class="calendar-nav-btn" onclick="prevMonth()">‚Üê</button>
                <span class="calendar-title" id="calendar-title">January 2025</span>
                <button class="calendar-nav-btn" onclick="nextMonth()">‚Üí</button>
              </div>
              <button class="calendar-today-btn" onclick="goToToday()">Today</button>
            </div>
            <div class="calendar-legend" id="calendar-legend"></div>
            <div class="calendar-grid" id="calendar-grid"></div>
          </div>
        </div>
        <div id="list-view" style="display:none;">
          <div class="card"><div class="card-body">
            <table class="data-table"><thead><tr><th>Deal</th><th>Customer</th><th>Stage</th><th>Next Date</th><th>Value</th><th>Actions</th></tr></thead><tbody id="deals-table-body"></tbody></table>
          </div></div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Deal Modal -->
  <div id="deal-modal" class="modal-overlay">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 class="modal-title" id="deal-modal-title">New Deal</h3>
        <button class="modal-close" onclick="closeDealModal()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
      <div class="modal-body">
        <form id="deal-form">
          <input type="hidden" id="deal-id">
          <div class="grid grid-cols-2 gap-lg">
            <div class="form-group" style="grid-column:1/-1;"><label class="form-label">Deal Name *</label><input type="text" id="deal-name" class="form-input" required placeholder="e.g., Smith Kitchen Reface"></div>
            <div class="form-group"><label class="form-label">Customer</label><select id="deal-customer" class="form-input"><option value="">Select customer...</option></select></div>
            <div class="form-group"><label class="form-label">Stage</label><select id="deal-stage" class="form-input"></select></div>
            <div class="form-group"><label class="form-label">Estimated Value</label><input type="number" id="deal-value" class="form-input" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label class="form-label">Link to Quote</label><select id="deal-quote" class="form-input"><option value="">None</option></select></div>
          </div>
          <div class="form-section">
            <div class="form-section-title"><span>üìÖ Scheduled Dates</span><button type="button" class="btn btn-secondary btn-sm" onclick="addDealEvent()">+ Add Date</button></div>
            <div id="deal-events-container"><p class="text-muted text-sm">No dates scheduled.</p></div>
          </div>
          <div class="form-section">
            <div class="form-section-title"><span>üì¶ Deal Items</span><button type="button" class="btn btn-secondary btn-sm" onclick="addDealItem()">+ Add Item</button></div>
            <div id="deal-items-container"><p class="text-muted text-sm">No items added.</p></div>
          </div>
          <div class="form-section"><div class="form-group"><label class="form-label">Notes</label><textarea id="deal-notes" class="form-input" rows="3"></textarea></div></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeDealModal()">Cancel</button>
        <button type="button" class="btn btn-danger" id="delete-deal-btn" style="display:none;" onclick="deleteDeal()">Delete</button>
        <button type="button" class="btn btn-primary" onclick="saveDeal()">Save Deal</button>
      </div>
    </div>
  </div>
  
  <!-- Appointment Modal -->
  <div id="appt-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="appt-modal-title">New Appointment</h3>
        <button class="modal-close" onclick="closeApptModal()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
      <div class="modal-body">
        <form id="appt-form">
          <input type="hidden" id="appt-id">
          <div class="form-group"><label class="form-label">Appointment Type</label><select id="appt-type" class="form-input"></select></div>
          <div class="form-group"><label class="form-label">Title *</label><input type="text" id="appt-title" class="form-input" required placeholder="e.g., Measure for Smith Kitchen"></div>
          <div class="grid grid-cols-2 gap-lg">
            <div class="form-group"><label class="form-label">Date *</label><input type="date" id="appt-date" class="form-input" required></div>
            <div class="form-group"><label class="form-label">Time</label><input type="time" id="appt-time" class="form-input"></div>
          </div>
          <div class="form-group"><label class="form-label">Customer (optional)</label><select id="appt-customer" class="form-input"><option value="">No customer selected</option></select></div>
          <div class="form-group"><label class="form-label">Link to Deal (optional)</label><select id="appt-deal" class="form-input"><option value="">No deal linked</option></select></div>
          <div class="form-group"><label class="form-label">Location</label><input type="text" id="appt-location" class="form-input" placeholder="Address or location"></div>
          <div class="form-group"><label class="form-label">Notes</label><textarea id="appt-notes" class="form-input" rows="2"></textarea></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeApptModal()">Cancel</button>
        <button type="button" class="btn btn-danger" id="delete-appt-btn" style="display:none;" onclick="deleteAppt()">Delete</button>
        <button type="button" class="btn btn-primary" onclick="saveAppt()">Save Appointment</button>
      </div>
    </div>
  </div>
  
  <!-- Stage Settings Modal -->
  <div id="stage-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Pipeline Stages</h3><button class="modal-close" onclick="closeStageSettings()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
      <div class="modal-body">
        <p class="text-muted mb-lg">Customize your pipeline stages.</p>
        <div id="stage-list"></div>
        <div class="mt-lg" id="add-stage-form" style="display:none;">
          <div class="flex gap-sm">
            <input type="text" id="new-stage-label" class="form-input" placeholder="Stage name">
            <input type="color" id="new-stage-color" value="#6366f1" style="width:50px;height:38px;">
            <button class="btn btn-primary" onclick="saveNewStage()">Add</button>
            <button class="btn btn-secondary" onclick="$('#add-stage-form').style.display='none'">Cancel</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="$('#add-stage-form').style.display='block'">+ Add Stage</button>
        <button class="btn btn-primary" onclick="closeStageSettings()">Done</button>
      </div>
    </div>
  </div>
  
  <script src="/js/utils.js"></script>
  <script>
    let deals = [], stages = [], customers = [], quotes = [], appointments = [], appointmentTypes = [], eventTypes = [], dealEvents = [];
    let currentDealEvents = [], currentDealItems = [], draggedDeal = null;
    
    async function init() { await loadData(); renderPipeline(); setupViewToggle(); setupDropdownClose(); }
    
    async function loadData() {
      try {
        const supabase = await app.waitForSupabase();
        const [stagesRes, dealsRes, customersRes, quotesRes, apptTypesRes, apptsRes, eventTypesRes, dealEventsRes] = await Promise.all([
          supabase.from('job_stages').select('*').order('sort_order'),
          supabase.from('jobs').select('*, customers(name, email, phone)').order('created_at', { ascending: false }),
          supabase.from('customers').select('id, name, email').order('name'),
          supabase.from('quotes').select('id, quote_number, title, customer_id, total').in('status', ['sent', 'viewed', 'draft']).order('created_at', { ascending: false }),
          supabase.from('appointment_types').select('*').eq('is_active', true).order('sort_order'),
          supabase.from('appointments').select('*, appointment_types(*), customers(name)').order('appointment_date'),
          supabase.from('job_event_types').select('*').eq('is_active', true).order('sort_order'),
          supabase.from('job_events').select('*, job_event_types(*)').order('event_date')
        ]);
        stages = stagesRes.data || []; deals = dealsRes.data || []; customers = customersRes.data || []; quotes = quotesRes.data || [];
        appointmentTypes = apptTypesRes.data || []; appointments = apptsRes.data || []; eventTypes = eventTypesRes.data || []; dealEvents = dealEventsRes.data || [];
        const totalDeals = deals.length, totalValue = deals.reduce((s, d) => s + (parseFloat(d.estimated_value) || 0), 0);
        $('#pipeline-summary').textContent = `${totalDeals} deals ‚Ä¢ ${formatCurrency(totalValue)} total value`;
        populateDropdowns(); renderApptTypeMenu(); renderCalendarLegend();
      } catch (err) { console.error('Error loading data:', err); showToast('Failed to load data', 'error'); }
    }
    
    function populateDropdowns() {
      const custOpts = '<option value="">Select customer...</option>' + customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      $('#deal-customer').innerHTML = custOpts;
      $('#appt-customer').innerHTML = '<option value="">No customer selected</option>' + customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      $('#deal-stage').innerHTML = stages.map(s => `<option value="${s.stage_id}">${s.label}</option>`).join('');
      $('#deal-quote').innerHTML = '<option value="">None</option>' + quotes.map(q => `<option value="${q.id}">${q.quote_number} - ${q.title}</option>`).join('');
      $('#appt-type').innerHTML = appointmentTypes.map(t => `<option value="${t.id}">${t.icon} ${t.name}</option>`).join('');
      $('#appt-deal').innerHTML = '<option value="">No deal linked</option>' + deals.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
    }
    
    function renderApptTypeMenu() {
      $('#appt-type-menu').innerHTML = appointmentTypes.map(t => `<div class="dropdown-item" onclick="openApptModal('${t.id}')"><span class="dropdown-icon">${t.icon}</span><span>${t.name}</span></div>`).join('');
    }
    
    function renderCalendarLegend() {
      const items = [...appointmentTypes.map(t => ({ color: t.color, label: `${t.icon} ${t.name}` })), ...eventTypes.map(t => ({ color: t.color, label: `${t.icon} ${t.name} (Deal)` }))];
      $('#calendar-legend').innerHTML = items.map(i => `<div class="calendar-legend-item"><span class="calendar-legend-dot" style="background:${i.color};"></span><span>${i.label}</span></div>`).join('');
    }
    
    function toggleDropdown(id) { $('#' + id).classList.toggle('open'); }
    function setupDropdownClose() { document.addEventListener('click', e => { if (!e.target.closest('.dropdown')) $$('.dropdown.open').forEach(d => d.classList.remove('open')); }); }
    
    function renderPipeline() {
      const container = $('#pipeline-container'); container.innerHTML = '';
      stages.forEach(stage => {
        const stageDeals = deals.filter(d => d.stage === stage.stage_id);
        const column = createElement('div', { className: 'pipeline-column', dataset: { stage: stage.stage_id } });
        column.innerHTML = `<div class="column-header"><span class="stage-dot" style="background-color:${stage.color}"></span><span class="column-title">${stage.label}</span><span class="column-count">${stageDeals.length}</span></div>`;
        const content = createElement('div', { className: 'column-content drop-zone' });
        if (stageDeals.length === 0) content.innerHTML = '<div class="empty-column">No deals</div>';
        else stageDeals.forEach(deal => content.appendChild(createDealCard(deal)));
        content.addEventListener('dragover', e => { e.preventDefault(); content.classList.add('drag-over'); });
        content.addEventListener('dragleave', () => content.classList.remove('drag-over'));
        content.addEventListener('drop', async e => { e.preventDefault(); content.classList.remove('drag-over'); if (draggedDeal && draggedDeal.stage !== stage.stage_id) await updateDealStage(draggedDeal.id, stage.stage_id); });
        column.appendChild(content); container.appendChild(column);
      });
    }
    
    function createDealCard(deal) {
      const card = createElement('div', { className: 'deal-card', draggable: true, dataset: { id: deal.id } });
      const customer = deal.customers, thisEvents = dealEvents.filter(e => e.job_id === deal.id).slice(0, 2);
      let html = `<div class="deal-card-title">${deal.name || 'Untitled'}</div>`;
      if (customer) html += `<div class="deal-card-customer">${customer.name}</div>`;
      if (thisEvents.length > 0) { html += '<div class="deal-card-dates">'; thisEvents.forEach(e => { const et = e.job_event_types || eventTypes.find(t => t.id === e.event_type_id); if (et) html += `<div class="deal-card-date">${et.icon} ${formatDate(e.event_date)}</div>`; }); html += '</div>'; }
      if (deal.estimated_value) html += `<div class="deal-card-value">${formatCurrency(deal.estimated_value)}</div>`;
      card.innerHTML = html;
      card.addEventListener('dragstart', () => { draggedDeal = deal; card.classList.add('dragging'); });
      card.addEventListener('dragend', () => { draggedDeal = null; card.classList.remove('dragging'); });
      card.addEventListener('click', () => openDealModal(deal));
      return card;
    }
    
    async function updateDealStage(dealId, newStage) {
      try { const supabase = await app.waitForSupabase(); await supabase.from('jobs').update({ stage: newStage, updated_at: new Date().toISOString() }).eq('id', dealId); const deal = deals.find(d => d.id === dealId); if (deal) deal.stage = newStage; renderPipeline(); showToast('Deal moved', 'success'); }
      catch (err) { console.error(err); showToast('Failed to move deal', 'error'); }
    }
    
    function openDealModal(deal = null) {
      currentDealEvents = []; currentDealItems = [];
      if (deal) {
        $('#deal-modal-title').textContent = 'Edit Deal'; $('#delete-deal-btn').style.display = 'block'; $('#deal-id').value = deal.id;
        $('#deal-name').value = deal.name || ''; $('#deal-customer').value = deal.customer_id || ''; $('#deal-stage').value = deal.stage || stages[0]?.stage_id;
        $('#deal-value').value = deal.estimated_value || ''; $('#deal-quote').value = deal.quote_id || ''; $('#deal-notes').value = deal.notes || '';
        currentDealItems = deal.job_items || [];
        currentDealEvents = dealEvents.filter(e => e.job_id === deal.id).map(e => ({ id: e.id, event_type_id: e.event_type_id, event_date: e.event_date, notes: e.notes || '', isExisting: true }));
      } else { $('#deal-modal-title').textContent = 'New Deal'; $('#delete-deal-btn').style.display = 'none'; $('#deal-form').reset(); $('#deal-id').value = ''; $('#deal-stage').value = stages[0]?.stage_id || ''; }
      renderDealEvents(); renderDealItems(); $('#deal-modal').classList.add('active');
    }
    
    function closeDealModal() { $('#deal-modal').classList.remove('active'); }
    
    async function saveDeal() {
      const id = $('#deal-id').value;
      const data = { name: $('#deal-name').value, customer_id: $('#deal-customer').value || null, stage: $('#deal-stage').value, estimated_value: parseFloat($('#deal-value').value) || null, quote_id: $('#deal-quote').value || null, notes: $('#deal-notes').value, job_items: currentDealItems, updated_at: new Date().toISOString() };
      if (!data.name) { showToast('Deal name is required', 'error'); return; }
      try {
        const supabase = await app.waitForSupabase(); let dealId = id;
        if (id) await supabase.from('jobs').update(data).eq('id', id);
        else { const { data: numData } = await supabase.rpc('generate_job_number'); data.job_number = numData; const { data: newDeal } = await supabase.from('jobs').insert([data]).select().single(); dealId = newDeal.id; }
        await saveDealEvents(supabase, dealId); closeDealModal(); await loadData(); renderPipeline(); showToast(id ? 'Deal updated' : 'Deal created', 'success');
      } catch (err) { console.error(err); showToast('Failed to save deal', 'error'); }
    }
    
    async function saveDealEvents(supabase, dealId) {
      const existingIds = currentDealEvents.filter(e => e.isExisting).map(e => e.id);
      const { data: dbEvents } = await supabase.from('job_events').select('id').eq('job_id', dealId);
      const toDelete = (dbEvents || []).map(e => e.id).filter(id => !existingIds.includes(id));
      if (toDelete.length) await supabase.from('job_events').delete().in('id', toDelete);
      for (const event of currentDealEvents) {
        if (!event.event_type_id || !event.event_date) continue;
        const eventData = { job_id: dealId, event_type_id: event.event_type_id, event_date: event.event_date, notes: event.notes || null };
        if (event.isExisting) await supabase.from('job_events').update(eventData).eq('id', event.id);
        else await supabase.from('job_events').insert([eventData]);
      }
    }
    
    async function deleteDeal() {
      const id = $('#deal-id').value; if (!id || !confirm('Delete this deal?')) return;
      try { const supabase = await app.waitForSupabase(); await supabase.from('jobs').delete().eq('id', id); closeDealModal(); await loadData(); renderPipeline(); showToast('Deal deleted', 'success'); }
      catch (err) { showToast('Failed to delete', 'error'); }
    }
    
    function addDealEvent() { currentDealEvents.push({ id: crypto.randomUUID(), event_type_id: eventTypes[0]?.id || '', event_date: '', notes: '', isExisting: false }); renderDealEvents(); }
    function removeDealEvent(id) { currentDealEvents = currentDealEvents.filter(e => e.id !== id); renderDealEvents(); }
    function renderDealEvents() {
      const container = $('#deal-events-container');
      if (currentDealEvents.length === 0) { container.innerHTML = '<p class="text-muted text-sm">No dates scheduled.</p>'; return; }
      container.innerHTML = currentDealEvents.map(e => `<div class="event-row"><select class="form-input" style="flex:1;" onchange="updateDealEvent('${e.id}','event_type_id',this.value)">${eventTypes.map(t => `<option value="${t.id}" ${t.id === e.event_type_id ? 'selected' : ''}>${t.icon} ${t.name}</option>`).join('')}</select><input type="date" class="form-input" style="width:140px;" value="${e.event_date || ''}" onchange="updateDealEvent('${e.id}','event_date',this.value)"><button type="button" class="btn btn-sm" style="color:var(--color-danger);" onclick="removeDealEvent('${e.id}')">√ó</button></div>`).join('');
    }
    function updateDealEvent(id, field, value) { const e = currentDealEvents.find(x => x.id === id); if (e) e[field] = value; }
    
    function addDealItem() { currentDealItems.push({ id: crypto.randomUUID(), name: '', quantity: '' }); renderDealItems(); }
    function removeDealItem(id) { currentDealItems = currentDealItems.filter(i => i.id !== id); renderDealItems(); }
    function renderDealItems() {
      const container = $('#deal-items-container');
      if (currentDealItems.length === 0) { container.innerHTML = '<p class="text-muted text-sm">No items added.</p>'; return; }
      container.innerHTML = currentDealItems.map(i => `<div class="item-row"><input type="text" class="form-input" style="flex:2;" placeholder="Item name" value="${i.name || ''}" onchange="updateDealItem('${i.id}','name',this.value)"><input type="number" class="form-input" style="width:80px;" placeholder="Qty" value="${i.quantity || ''}" onchange="updateDealItem('${i.id}','quantity',this.value)"><button type="button" class="btn btn-sm" style="color:var(--color-danger);" onclick="removeDealItem('${i.id}')">√ó</button></div>`).join('');
    }
    function updateDealItem(id, field, value) { const i = currentDealItems.find(x => x.id === id); if (i) i[field] = value; }
    
    function openApptModal(typeId = null, appt = null) {
      $$('.dropdown.open').forEach(d => d.classList.remove('open'));
      if (appt) { $('#appt-modal-title').textContent = 'Edit Appointment'; $('#delete-appt-btn').style.display = 'block'; $('#appt-id').value = appt.id; $('#appt-type').value = appt.appointment_type_id || ''; $('#appt-title').value = appt.title || ''; $('#appt-date').value = appt.appointment_date || ''; $('#appt-time').value = appt.appointment_time || ''; $('#appt-customer').value = appt.customer_id || ''; $('#appt-deal').value = appt.deal_id || ''; $('#appt-location').value = appt.location || ''; $('#appt-notes').value = appt.notes || ''; }
      else { $('#appt-modal-title').textContent = 'New Appointment'; $('#delete-appt-btn').style.display = 'none'; $('#appt-form').reset(); $('#appt-id').value = ''; if (typeId) $('#appt-type').value = typeId; $('#appt-date').value = new Date().toISOString().split('T')[0]; }
      $('#appt-modal').classList.add('active');
    }
    
    function closeApptModal() { $('#appt-modal').classList.remove('active'); }
    
    async function saveAppt() {
      const id = $('#appt-id').value;
      const data = { appointment_type_id: $('#appt-type').value || null, title: $('#appt-title').value, appointment_date: $('#appt-date').value, appointment_time: $('#appt-time').value || null, customer_id: $('#appt-customer').value || null, deal_id: $('#appt-deal').value || null, location: $('#appt-location').value, notes: $('#appt-notes').value, updated_at: new Date().toISOString() };
      if (!data.title || !data.appointment_date) { showToast('Title and date are required', 'error'); return; }
      try { const supabase = await app.waitForSupabase(); if (id) await supabase.from('appointments').update(data).eq('id', id); else await supabase.from('appointments').insert([data]); closeApptModal(); await loadData(); renderCalendar(); showToast(id ? 'Appointment updated' : 'Appointment created', 'success'); }
      catch (err) { console.error(err); showToast('Failed to save appointment', 'error'); }
    }
    
    async function deleteAppt() {
      const id = $('#appt-id').value; if (!id || !confirm('Delete this appointment?')) return;
      try { const supabase = await app.waitForSupabase(); await supabase.from('appointments').delete().eq('id', id); closeApptModal(); await loadData(); renderCalendar(); showToast('Appointment deleted', 'success'); }
      catch (err) { showToast('Failed to delete', 'error'); }
    }
    
    function openStageSettings() { renderStageList(); $('#stage-modal').classList.add('active'); }
    function closeStageSettings() { $('#stage-modal').classList.remove('active'); $('#add-stage-form').style.display = 'none'; }
    function renderStageList() {
      $('#stage-list').innerHTML = stages.map((s, i) => `<div class="flex items-center gap-md mb-sm" style="padding:var(--space-sm);background:var(--color-bg-soft);border-radius:var(--radius-md);"><span class="stage-dot" style="background:${s.color}"></span><span style="flex:1;font-weight:500;">${s.label}</span><button class="btn btn-sm" onclick="moveStage('${s.id}','up')" ${i===0?'disabled':''}>‚Üë</button><button class="btn btn-sm" onclick="moveStage('${s.id}','down')" ${i===stages.length-1?'disabled':''}>‚Üì</button><button class="btn btn-sm" style="color:var(--color-danger);" onclick="deleteStage('${s.id}')">√ó</button></div>`).join('');
    }
    async function saveNewStage() {
      const label = $('#new-stage-label').value.trim(), color = $('#new-stage-color').value; if (!label) return;
      try { const supabase = await app.waitForSupabase(); await supabase.from('job_stages').insert([{ stage_id: label.toLowerCase().replace(/\s+/g, '-'), label, color, sort_order: Math.max(...stages.map(s => s.sort_order), -1) + 1 }]); await loadData(); renderStageList(); renderPipeline(); $('#add-stage-form').style.display = 'none'; showToast('Stage added', 'success'); }
      catch (err) { showToast('Failed to add stage', 'error'); }
    }
    async function deleteStage(id) { if (!confirm('Delete this stage?')) return; try { const supabase = await app.waitForSupabase(); await supabase.from('job_stages').delete().eq('id', id); await loadData(); renderStageList(); renderPipeline(); } catch (err) { showToast('Failed to delete', 'error'); } }
    async function moveStage(id, dir) {
      const idx = stages.findIndex(s => s.id === id), newIdx = dir === 'up' ? idx - 1 : idx + 1; if (newIdx < 0 || newIdx >= stages.length) return;
      try { const supabase = await app.waitForSupabase(); const s1 = stages[idx], s2 = stages[newIdx]; await supabase.from('job_stages').update({ sort_order: s2.sort_order }).eq('id', s1.id); await supabase.from('job_stages').update({ sort_order: s1.sort_order }).eq('id', s2.id); await loadData(); renderStageList(); renderPipeline(); } catch (err) { console.error(err); }
    }
    
    function setupViewToggle() {
      $$('.view-toggle button').forEach(btn => {
        btn.addEventListener('click', () => {
          $$('.view-toggle button').forEach(b => b.classList.remove('active')); btn.classList.add('active');
          const view = btn.dataset.view;
          $('#pipeline-view').style.display = view === 'pipeline' ? 'block' : 'none';
          $('#calendar-view').style.display = view === 'calendar' ? 'block' : 'none';
          $('#list-view').style.display = view === 'list' ? 'block' : 'none';
          if (view === 'calendar') renderCalendar(); if (view === 'list') renderListView();
        });
      });
    }
    
    let currentCalendarDate = new Date();
    function prevMonth() { currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() - 1, 1); renderCalendar(); }
    function nextMonth() { currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 1); renderCalendar(); }
    function goToToday() { currentCalendarDate = new Date(); renderCalendar(); }
    
    function renderCalendar() {
      const year = currentCalendarDate.getFullYear(), month = currentCalendarDate.getMonth();
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      $('#calendar-title').textContent = `${monthNames[month]} ${year}`;
      const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
      const startDayOfWeek = firstDay.getDay(), daysInMonth = lastDay.getDate(), prevMonthLastDay = new Date(year, month, 0).getDate();
      const events = buildEventsLookup(), today = new Date(), isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
      let html = dayNames.map(d => `<div class="calendar-day-header">${d}</div>`).join('');
      const totalCells = Math.ceil((startDayOfWeek + daysInMonth) / 7) * 7; let dayCount = 1, nextMonthDay = 1;
      for (let i = 0; i < totalCells; i++) {
        let dayNum, isOtherMonth = false, dateStr;
        if (i < startDayOfWeek) { dayNum = prevMonthLastDay - startDayOfWeek + i + 1; isOtherMonth = true; const pm = month === 0 ? 11 : month - 1, py = month === 0 ? year - 1 : year; dateStr = `${py}-${String(pm + 1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`; }
        else if (dayCount > daysInMonth) { dayNum = nextMonthDay++; isOtherMonth = true; const nm = month === 11 ? 0 : month + 1, ny = month === 11 ? year + 1 : year; dateStr = `${ny}-${String(nm + 1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`; }
        else { dayNum = dayCount++; dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`; }
        const isToday = isCurrentMonth && !isOtherMonth && dayNum === today.getDate(), dayEvents = events[dateStr] || [];
        html += `<div class="calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}"><span class="calendar-day-number">${dayNum}</span><div class="calendar-events">${renderDayEvents(dayEvents)}</div></div>`;
      }
      $('#calendar-grid').innerHTML = html;
    }
    
    function buildEventsLookup() {
      const events = {};
      appointments.forEach(appt => { const dateStr = appt.appointment_date, type = appt.appointment_types || appointmentTypes.find(t => t.id === appt.appointment_type_id); if (!events[dateStr]) events[dateStr] = []; events[dateStr].push({ type: 'appointment', data: appt, color: type?.color || '#6366f1', icon: type?.icon || 'üìÖ', label: appt.title }); });
      dealEvents.forEach(event => { const dateStr = event.event_date, deal = deals.find(d => d.id === event.job_id), type = event.job_event_types || eventTypes.find(t => t.id === event.event_type_id); if (!deal || !type) return; if (!events[dateStr]) events[dateStr] = []; events[dateStr].push({ type: 'deal_event', data: { event, deal }, color: type?.color || '#6366f1', icon: type?.icon || 'üìÖ', label: deal.name }); });
      return events;
    }
    
    function renderDayEvents(dayEvents) {
      if (!dayEvents.length) return '';
      const maxVisible = 3;
      let html = dayEvents.slice(0, maxVisible).map(e => {
        const bgColor = hexToRgba(e.color, 0.2);
        const onclick = e.type === 'appointment' ? `openApptModal(null, appointments.find(a => a.id === '${e.data.id}'))` : `openDealModal(deals.find(d => d.id === '${e.data.deal.id}'))`;
        return `<div class="calendar-event" style="background:${bgColor};color:${e.color};border-left:3px solid ${e.color};" onclick="${onclick}">${e.icon} ${e.label}</div>`;
      }).join('');
      if (dayEvents.length > maxVisible) html += `<div class="calendar-more">+${dayEvents.length - maxVisible} more</div>`;
      return html;
    }
    
    function hexToRgba(hex, alpha) { const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16); return `rgba(${r},${g},${b},${alpha})`; }
    
    function renderListView() {
      $('#deals-table-body').innerHTML = deals.map(d => {
        const stage = stages.find(s => s.stage_id === d.stage), thisEvents = dealEvents.filter(e => e.job_id === d.id);
        const nextEvent = thisEvents.sort((a,b) => new Date(a.event_date) - new Date(b.event_date))[0];
        return `<tr><td><strong>${d.name}</strong>${d.job_number ? `<br><span class="text-muted text-sm">${d.job_number}</span>` : ''}</td><td>${d.customers?.name || '‚Äî'}</td><td><span class="badge" style="background:${stage?.color || '#666'};color:white;">${stage?.label || d.stage}</span></td><td>${nextEvent ? formatDate(nextEvent.event_date) : '‚Äî'}</td><td>${d.estimated_value ? formatCurrency(d.estimated_value) : '‚Äî'}</td><td><button class="btn btn-sm btn-secondary" onclick="openDealModal(deals.find(x => x.id === '${d.id}'))">Edit</button></td></tr>`;
      }).join('');
    }
    
    init();
  </script>
</body>
</html>
