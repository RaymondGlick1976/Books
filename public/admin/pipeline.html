<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deals Pipeline | Admin | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css?v=33">
  <style>
    .pipeline-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: var(--space-md); width: 100%; }
    .pipeline-header h2 { margin: 0; white-space: nowrap; }
    .pipeline-actions { display: flex; gap: var(--space-sm); flex-wrap: wrap; align-items: center; flex-shrink: 0; }
    .pipeline-container { display: flex; gap: var(--space-md); overflow-x: auto; padding-bottom: var(--space-lg); min-height: calc(100vh - 200px); max-width: 100%; }
    .pipeline-column { flex: 0 0 260px; background: var(--color-bg-soft); border-radius: var(--radius-lg); display: flex; flex-direction: column; max-height: calc(100vh - 200px); }
    .column-header { padding: var(--space-md); border-bottom: 1px solid var(--color-border); display: flex; align-items: center; gap: var(--space-sm); position: sticky; top: 0; background: var(--color-bg-soft); border-radius: var(--radius-lg) var(--radius-lg) 0 0; }
    .stage-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
    .column-title { font-weight: 600; font-size: 0.8rem; color: var(--color-text); flex: 1; }
    .column-count { background: var(--color-bg); color: var(--color-text-muted); font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
    .column-content { flex: 1; overflow-y: auto; padding: var(--space-sm); }
    .deal-card { background: white; border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-md); margin-bottom: var(--space-sm); cursor: grab; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .deal-card:hover { border-color: var(--color-primary); box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15); }
    .deal-card.dragging { opacity: 0.5; cursor: grabbing; }
    .deal-card-title { font-weight: 600; font-size: 0.875rem; color: var(--color-text); margin-bottom: 4px; }
    .deal-card-customer { font-size: 0.8125rem; color: var(--color-text-muted); margin-bottom: var(--space-sm); }
    .deal-card-dates { font-size: 0.75rem; color: var(--color-text-muted); }
    .deal-card-date { margin-top: 4px; display: flex; flex-direction: column; }
    .deal-card-date-label { font-weight: 600; color: var(--color-text); font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.02em; }
    .deal-card-value { font-size: 0.8125rem; font-weight: 600; color: var(--color-primary); margin-top: var(--space-sm); }
    .empty-column { text-align: center; padding: var(--space-xl); color: var(--color-text-muted); font-size: 0.8125rem; }
    .drop-zone { min-height: 100px; border: 2px dashed transparent; border-radius: var(--radius-md); transition: all 0.2s; }
    .drop-zone.drag-over { border-color: var(--color-primary); background: rgba(99, 102, 241, 0.05); }
    
    /* Dropdown */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-btn { display: flex; align-items: center; gap: var(--space-xs); }
    .dropdown-btn svg.chevron { width: 14px; height: 14px; transition: transform 0.2s; }
    .dropdown.open .dropdown-btn svg.chevron { transform: rotate(180deg); }
    .dropdown-menu { background: white; border: 1px solid var(--color-border); border-radius: var(--radius-md); box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 9999; display: none; }
    .dropdown.open .dropdown-menu { display: block; }
    .dropdown.open .dropdown-menu { display: block; }
    .dropdown-item { display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm) var(--space-md); cursor: pointer; font-size: 0.875rem; color: var(--color-text); transition: background 0.15s; }
    .dropdown-item:hover { background: var(--color-bg-soft); }
    .dropdown-item:first-child { border-radius: var(--radius-md) var(--radius-md) 0 0; }
    .dropdown-item:last-child { border-radius: 0 0 var(--radius-md) var(--radius-md); }
    .dropdown-icon { font-size: 1rem; }
    
    /* Calendar */
    .calendar-container { background: white; border-radius: var(--radius-lg); border: 1px solid var(--color-border); overflow: hidden; }
    .calendar-header { display: flex; align-items: center; justify-content: space-between; padding: var(--space-lg); background: var(--color-bg-soft); border-bottom: 1px solid var(--color-border); }
    .calendar-nav { display: flex; align-items: center; gap: var(--space-md); }
    .calendar-nav-btn { width: 36px; height: 36px; border: 1px solid var(--color-border); background: white; border-radius: var(--radius-md); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: var(--color-text-muted); }
    .calendar-nav-btn:hover { background: var(--color-bg-soft); color: var(--color-primary); }
    .calendar-title { font-size: 1.25rem; font-weight: 600; color: var(--color-text); min-width: 200px; text-align: center; }
    .calendar-today-btn { padding: var(--space-sm) var(--space-md); border: 1px solid var(--color-border); background: white; border-radius: var(--radius-md); cursor: pointer; font-size: 0.875rem; }
    .calendar-today-btn:hover { background: var(--color-primary); color: white; border-color: var(--color-primary); }
    .calendar-legend { display: flex; gap: var(--space-lg); padding: var(--space-sm) var(--space-lg); background: var(--color-bg-soft); border-bottom: 1px solid var(--color-border); flex-wrap: wrap; }
    .calendar-legend-item { display: flex; align-items: center; gap: var(--space-xs); font-size: 0.75rem; color: var(--color-text-muted); }
    .calendar-legend-dot { width: 10px; height: 10px; border-radius: 50%; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
    .calendar-day-header { padding: var(--space-sm); text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--color-text-muted); text-transform: uppercase; background: var(--color-bg-soft); border-bottom: 1px solid var(--color-border); }
    .calendar-day { min-height: 100px; border-right: 1px solid var(--color-border); border-bottom: 1px solid var(--color-border); padding: var(--space-xs); background: white; }
    .calendar-day:nth-child(7n) { border-right: none; }
    .calendar-day.other-month { background: var(--color-bg-soft); }
    .calendar-day.other-month .calendar-day-number { color: var(--color-text-muted); }
    .calendar-day.today { background: rgba(99, 102, 241, 0.05); }
    .calendar-day.today .calendar-day-number { background: var(--color-primary); color: white; }
    .calendar-day-number { display: inline-flex; align-items: center; justify-content: center; width: 26px; height: 26px; border-radius: 50%; font-size: 0.8rem; font-weight: 500; color: var(--color-text); margin-bottom: var(--space-xs); }
    .calendar-events { display: flex; flex-direction: column; gap: 2px; }
    .calendar-event { padding: 2px 5px; border-radius: 3px; font-size: 0.65rem; font-weight: 500; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .calendar-event:hover { transform: scale(1.02); }
    .calendar-more { font-size: 0.65rem; color: var(--color-text-muted); padding: 2px 5px; cursor: pointer; }
    
    /* View toggle */
    .view-toggle { display: flex; background: var(--color-bg-soft); border-radius: var(--radius-md); padding: 3px; }
    .view-toggle button { padding: var(--space-xs) var(--space-sm); border: none; background: transparent; color: var(--color-text-muted); cursor: pointer; border-radius: var(--radius-sm); font-size: 0.75rem; }
    .view-toggle button.active { background: white; color: var(--color-primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    
    /* Form sections */
    .form-section { margin-top: var(--space-lg); padding-top: var(--space-lg); border-top: 1px solid var(--color-border); }
    .form-section-title { font-weight: 600; font-size: 0.9rem; color: var(--color-text); margin-bottom: var(--space-md); display: flex; align-items: center; justify-content: space-between; }
    .event-row, .item-row { display: flex; gap: var(--space-sm); align-items: center; padding: var(--space-sm) 0; border-bottom: 1px solid var(--color-border-light); }
    .event-row:last-child, .item-row:last-child { border-bottom: none; }
    
    /* Searchable Select */
    .search-select { position: relative; }
    .search-select-input { width: 100%; cursor: text; }
    .search-select-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--color-border); border-radius: var(--radius-md); box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 250px; overflow-y: auto; z-index: 9999; display: none; }
    .search-select.open .search-select-dropdown { display: block; }
    .search-select-option { padding: var(--space-sm) var(--space-md); cursor: pointer; font-size: 0.875rem; }
    .search-select-option:hover, .search-select-option.highlighted { background: var(--color-bg-soft); }
    .search-select-option.selected { background: var(--color-primary); color: white; }
    .search-select-empty { padding: var(--space-md); color: var(--color-text-muted); font-size: 0.875rem; text-align: center; }
    .search-select-clear { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--color-text-muted); padding: 4px; display: none; }
    .search-select.has-value .search-select-clear { display: block; }
  </style>
</head>
<body>
  <script>
    // Permission check before page loads
    const user = JSON.parse(localStorage.getItem('app_user') || 'null');
    if (!user) {
      window.location.href = '/admin/login.html';
    } else if (!user.permissions?.can_view_pipeline) {
      window.location.href = '/admin/index.html';
    }
  </script>
  <div class="app-layout">
    <aside class="app-sidebar">
      <div class="sidebar-logo">
        <img src="/images/logo.gif" alt="Homestead Cabinet Design" style="height: 40px; filter: brightness(0) invert(1);">
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item"><a href="/admin/index.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard</a></li>
          <li class="sidebar-nav-item"><a href="/admin/pipeline.html" class="sidebar-nav-link active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Deals Pipeline</a></li>
          <li class="sidebar-nav-item"><a href="/admin/customers.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Customers</a></li>
          <li class="sidebar-nav-item"><a href="/admin/quotes.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>Quotes</a></li>
          <li class="sidebar-nav-item"><a href="/admin/invoices.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>Invoices</a></li>
        </ul>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Lead Capture</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/booking-forms.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>Booking Forms</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Catalog</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/catalog.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>Items Catalog</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/email-templates.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Email Templates</a></li>
          </ul>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/settings.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</a></li>
          </ul>
        </div>
      </nav>
    </aside>
    
    <main class="app-main">
      <header class="app-header" style="flex-wrap: wrap;">
        <div class="pipeline-header" style="flex: 1; min-width: 0;">
          <div class="pipeline-actions">
            <div class="view-toggle">
              <button class="active" data-view="pipeline">Pipeline</button>
              <button data-view="calendar">Calendar</button>
              <button data-view="list">List</button>
            </div>
            <button class="btn btn-primary btn-sm" onclick="openDealModal()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              New Deal
            </button>
            
            <!-- New Appointment Dropdown -->
            <div class="dropdown" id="appt-dropdown">
              <button class="btn btn-secondary btn-sm dropdown-btn" onclick="toggleDropdown('appt-dropdown')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                Appt
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
              <div class="dropdown-menu" id="appt-type-menu"></div>
            </div>
            
            <button class="btn btn-secondary btn-sm" onclick="openStageSettings()">Stages</button>
            
            <!-- Stage Filter Dropdown -->
            <div class="dropdown" id="filter-dropdown">
              <button class="btn btn-secondary btn-sm dropdown-btn" onclick="toggleDropdown('filter-dropdown')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                Filter
                <span id="filter-count" class="badge badge-sm" style="display:none;margin-left:4px;"></span>
                <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
              </button>
              <div class="dropdown-menu" style="min-width:200px;max-height:300px;overflow-y:auto;" id="filter-menu">
                <div style="padding:var(--space-sm);border-bottom:1px solid var(--color-border);">
                  <button class="btn btn-sm btn-ghost" onclick="selectAllStages()">Select All</button>
                  <button class="btn btn-sm btn-ghost" onclick="clearAllStages()">Clear All</button>
                </div>
                <div id="filter-stages-list"></div>
              </div>
            </div>
          </div>
          <div style="min-width: 0; text-align: right;">
            <h2 style="font-size: 1rem; margin: 0;">Deals Pipeline</h2>
            <p class="text-muted" id="pipeline-summary" style="font-size: 0.75rem; margin: 0;">Loading...</p>
          </div>
        </div>
      </header>
      
      <div class="app-content" style="padding: var(--space-md);">
        <div id="pipeline-view" style="overflow-x: auto; max-width: 100%;"><div class="pipeline-container" id="pipeline-container"></div></div>
        <div id="calendar-view" style="display:none;">
          <div class="calendar-container">
            <div class="calendar-header">
              <div class="calendar-nav">
                <button class="calendar-nav-btn" onclick="prevMonth()">‚Üê</button>
                <span class="calendar-title" id="calendar-title">January 2025</span>
                <button class="calendar-nav-btn" onclick="nextMonth()">‚Üí</button>
              </div>
              <button class="calendar-today-btn" onclick="goToToday()">Today</button>
            </div>
            <div class="calendar-legend" id="calendar-legend"></div>
            <div class="calendar-grid" id="calendar-grid"></div>
          </div>
        </div>
        <div id="list-view" style="display:none;">
          <div class="card"><div class="card-body">
            <table class="data-table"><thead><tr><th>Deal</th><th>Customer</th><th>Stage</th><th>Next Date</th><th>Value</th><th>Actions</th></tr></thead><tbody id="deals-table-body"></tbody></table>
          </div></div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Deal Modal -->
  <div id="deal-modal" class="modal-overlay">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 class="modal-title" id="deal-modal-title">New Deal</h3>
        <button class="modal-close" onclick="closeDealModal()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
      <div class="modal-body">
        <form id="deal-form">
          <input type="hidden" id="deal-id">
          <div class="grid grid-cols-2 gap-lg">
            <div class="form-group" style="grid-column:1/-1;"><label class="form-label">Deal Name *</label><input type="text" id="deal-name" class="form-input" required placeholder="e.g., Smith Kitchen Reface"></div>
            <div class="form-group">
              <label class="form-label">Customer</label>
              <div class="search-select" id="customer-search-select">
                <input type="text" id="deal-customer-search" class="form-input search-select-input" placeholder="Type to search customers..." autocomplete="off">
                <input type="hidden" id="deal-customer">
                <button type="button" class="search-select-clear" onclick="clearCustomerSelect()">&times;</button>
                <div class="search-select-dropdown" id="customer-dropdown"></div>
              </div>
            </div>
            <div class="form-group"><label class="form-label">Stage</label><select id="deal-stage" class="form-input"></select></div>
            <div class="form-group"><label class="form-label">Estimated Value</label><input type="number" id="deal-value" class="form-input" step="0.01" placeholder="0.00"></div>
            <div class="form-group"><label class="form-label">Link to Quote</label><select id="deal-quote" class="form-input"><option value="">None</option></select></div>
          </div>
          <div class="form-section">
            <div class="form-section-title"><span>üìÖ Scheduled Dates</span><button type="button" class="btn btn-secondary btn-sm" onclick="addDealEvent()">+ Add Date</button></div>
            <div id="deal-events-container"><p class="text-muted text-sm">No dates scheduled.</p></div>
          </div>
          <div class="form-section">
            <div class="form-section-title"><span>üì¶ Deal Items</span><button type="button" class="btn btn-secondary btn-sm" onclick="addDealItem()">+ Add Item</button></div>
            <div id="deal-items-container"><p class="text-muted text-sm">No items added.</p></div>
          </div>
          <div class="form-section"><div class="form-group"><label class="form-label">Notes</label><textarea id="deal-notes" class="form-input" rows="3"></textarea></div></div>
        </form>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <div>
          <button type="button" class="btn btn-secondary" id="email-deal-btn" style="display:none;" onclick="openDealEmailModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            Send Email
          </button>
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-secondary" onclick="closeDealModal()">Cancel</button>
          <button type="button" class="btn btn-danger" id="delete-deal-btn" style="display:none;" onclick="deleteDeal()">Delete</button>
          <button type="button" class="btn btn-primary" onclick="saveDeal()">Save Deal</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Appointment Modal -->
  <div id="appt-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="appt-modal-title">New Appointment</h3>
        <button class="modal-close" onclick="closeApptModal()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
      <div class="modal-body">
        <form id="appt-form">
          <input type="hidden" id="appt-id">
          <div class="form-group"><label class="form-label">Appointment Type</label><select id="appt-type" class="form-input"></select></div>
          <div class="form-group"><label class="form-label">Title *</label><input type="text" id="appt-title" class="form-input" required placeholder="e.g., Measure for Smith Kitchen"></div>
          <div class="grid grid-cols-2 gap-lg">
            <div class="form-group"><label class="form-label">Date *</label><input type="date" id="appt-date" class="form-input" required></div>
            <div class="form-group"><label class="form-label">Time</label><input type="time" id="appt-time" class="form-input"></div>
          </div>
          <div class="form-group"><label class="form-label">Customer (optional)</label><select id="appt-customer" class="form-input"><option value="">No customer selected</option></select></div>
          <div class="form-group"><label class="form-label">Link to Deal (optional)</label><select id="appt-deal" class="form-input"><option value="">No deal linked</option></select></div>
          <div class="form-group"><label class="form-label">Location</label><input type="text" id="appt-location" class="form-input" placeholder="Address or location"></div>
          <div class="form-group"><label class="form-label">Notes</label><textarea id="appt-notes" class="form-input" rows="2"></textarea></div>
        </form>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <div>
          <button type="button" class="btn btn-secondary" id="email-appt-btn" style="display:none;" onclick="openApptEmailModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            Send Reminder
          </button>
        </div>
        <div class="btn-group">
          <button type="button" class="btn btn-secondary" onclick="closeApptModal()">Cancel</button>
          <button type="button" class="btn btn-danger" id="delete-appt-btn" style="display:none;" onclick="deleteAppt()">Delete</button>
          <button type="button" class="btn btn-primary" onclick="saveAppt()">Save Appointment</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Stage Settings Modal -->
  <div id="stage-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header"><h3 class="modal-title">Pipeline Stages</h3><button class="modal-close" onclick="closeStageSettings()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
      <div class="modal-body">
        <p class="text-muted mb-lg">Customize your pipeline stages.</p>
        <div id="stage-list"></div>
        <div class="mt-lg" id="add-stage-form" style="display:none;">
          <div class="flex gap-sm">
            <input type="text" id="new-stage-label" class="form-input" placeholder="Stage name">
            <input type="color" id="new-stage-color" value="#6366f1" style="width:50px;height:38px;">
            <button class="btn btn-primary" onclick="saveNewStage()">Add</button>
            <button class="btn btn-secondary" onclick="$('#add-stage-form').style.display='none'">Cancel</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="$('#add-stage-form').style.display='block'">+ Add Stage</button>
        <button class="btn btn-primary" onclick="closeStageSettings()">Done</button>
      </div>
    </div>
  </div>
  
  <script src="/js/utils.js"></script>
  <script>
    let deals = [], stages = [], customers = [], quotes = [], appointments = [], appointmentTypes = [], eventTypes = [], dealEvents = [], emailTemplates = [], dealItemTypes = [];
    let currentDealEvents = [], currentDealItems = [], draggedDeal = null;
    let selectedStages = new Set(); // For stage filtering
    
    async function init() { await loadData(); renderPipeline(); setupViewToggle(); setupDropdownClose(); }
    
    async function loadData() {
      try {
        const supabase = await app.waitForSupabase();
        const [stagesRes, dealsRes, customersRes, quotesRes, apptTypesRes, apptsRes, eventTypesRes, dealEventsRes, templatesRes, settingsRes] = await Promise.all([
          supabase.from('job_stages').select('*').order('sort_order'),
          supabase.from('jobs').select('*, customers(name, email, phone, first_name)').order('created_at', { ascending: false }),
          supabase.from('customers').select('id, name, first_name, email').order('name'),
          supabase.from('quotes').select('id, quote_number, title, customer_id, total').in('status', ['sent', 'viewed', 'draft']).order('created_at', { ascending: false }),
          supabase.from('appointment_types').select('*').eq('is_active', true).order('sort_order'),
          supabase.from('appointments').select('*, appointment_types(*), customers(name, email, first_name)').order('appointment_date'),
          supabase.from('job_event_types').select('*').eq('is_active', true).order('sort_order'),
          supabase.from('job_events').select('*, job_event_types(*)').order('event_date'),
          supabase.from('email_templates').select('*').eq('is_active', true),
          supabase.from('settings').select('*').eq('key', 'deal_item_types').single()
        ]);
        stages = stagesRes.data || []; deals = dealsRes.data || []; customers = customersRes.data || []; quotes = quotesRes.data || [];
        appointmentTypes = apptTypesRes.data || []; appointments = apptsRes.data || []; dealEvents = dealEventsRes.data || [];
        // Deduplicate event types by name (in case of duplicate entries)
        const seenEventTypes = new Set();
        eventTypes = (eventTypesRes.data || []).filter(t => {
          if (seenEventTypes.has(t.name)) return false;
          seenEventTypes.add(t.name);
          return true;
        });
        emailTemplates = templatesRes.data || [];
        dealItemTypes = (settingsRes.data?.value && Array.isArray(settingsRes.data.value)) ? settingsRes.data.value : [];
        
        // Initialize selected stages to all stages if empty
        if (selectedStages.size === 0) {
          stages.forEach(s => selectedStages.add(s.stage_id));
        }
        
        updatePipelineSummary();
        populateDropdowns(); renderApptTypeMenu(); renderCalendarLegend(); renderStageFilter();
      } catch (err) { console.error('Error loading data:', err); showToast('Failed to load data', 'error'); }
    }
    
    function updatePipelineSummary() {
      const filteredDeals = getFilteredDeals();
      const totalDeals = filteredDeals.length;
      const totalValue = filteredDeals.reduce((s, d) => s + (parseFloat(d.estimated_value) || 0), 0);
      const filterActive = selectedStages.size < stages.length;
      $('#pipeline-summary').textContent = `${totalDeals} deals ‚Ä¢ ${formatCurrency(totalValue)} total value${filterActive ? ' (filtered)' : ''}`;
    }
    
    function getFilteredDeals() {
      return deals.filter(d => selectedStages.has(d.stage));
    }
    
    function renderStageFilter() {
      const container = $('#filter-stages-list');
      container.innerHTML = stages.map(s => `
        <label class="dropdown-item" style="display:flex;align-items:center;gap:var(--space-sm);cursor:pointer;padding:var(--space-sm) var(--space-md);">
          <input type="checkbox" ${selectedStages.has(s.stage_id) ? 'checked' : ''} onchange="toggleStageFilter('${s.stage_id}')">
          <span class="stage-dot" style="background:${s.color}"></span>
          <span style="flex:1">${s.label}</span>
          <span class="text-muted text-sm">${deals.filter(d => d.stage === s.stage_id).length}</span>
        </label>
      `).join('');
      
      // Update filter count badge
      const filterCount = stages.length - selectedStages.size;
      const badge = $('#filter-count');
      if (filterCount > 0) {
        badge.textContent = filterCount;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function toggleStageFilter(stageId) {
      if (selectedStages.has(stageId)) {
        selectedStages.delete(stageId);
      } else {
        selectedStages.add(stageId);
      }
      renderStageFilter();
      updatePipelineSummary();
      renderCurrentView();
    }
    
    function selectAllStages() {
      stages.forEach(s => selectedStages.add(s.stage_id));
      renderStageFilter();
      updatePipelineSummary();
      renderCurrentView();
    }
    
    function clearAllStages() {
      selectedStages.clear();
      renderStageFilter();
      updatePipelineSummary();
      renderCurrentView();
    }
    
    function renderCurrentView() {
      const activeBtn = document.querySelector('.view-toggle button.active');
      const view = activeBtn?.dataset.view || 'pipeline';
      if (view === 'pipeline') renderPipeline();
      else if (view === 'calendar') renderCalendar();
      else if (view === 'list') renderListView();
    }
    
    function populateDropdowns() {
      // Customer search is handled separately
      $('#appt-customer').innerHTML = '<option value="">No customer selected</option>' + customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      $('#deal-stage').innerHTML = stages.map(s => `<option value="${s.stage_id}">${s.label}</option>`).join('');
      $('#deal-quote').innerHTML = '<option value="">None</option>' + quotes.map(q => `<option value="${q.id}">${q.quote_number} - ${q.title}</option>`).join('');
      $('#appt-type').innerHTML = appointmentTypes.map(t => `<option value="${t.id}">${t.icon} ${t.name}</option>`).join('');
      $('#appt-deal').innerHTML = '<option value="">No deal linked</option>' + deals.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
      setupCustomerSearch();
    }
    
    function setupCustomerSearch() {
      const container = $('#customer-search-select');
      const input = $('#deal-customer-search');
      const dropdown = $('#customer-dropdown');
      const hiddenInput = $('#deal-customer');
      let highlightedIndex = -1;
      
      function renderOptions(filter = '') {
        const filterLower = filter.toLowerCase();
        const filtered = filter ? customers.filter(c => 
          c.name.toLowerCase().includes(filterLower) || 
          (c.email && c.email.toLowerCase().includes(filterLower))
        ) : customers;
        
        if (filtered.length === 0) {
          dropdown.innerHTML = '<div class="search-select-empty">No customers found</div>';
        } else {
          dropdown.innerHTML = filtered.slice(0, 50).map((c, idx) => 
            `<div class="search-select-option" data-id="${c.id}" data-name="${c.name}" data-index="${idx}">${c.name}${c.email ? ` <span style="color:var(--color-text-muted);font-size:0.75rem;">(${c.email})</span>` : ''}</div>`
          ).join('');
        }
        highlightedIndex = -1;
      }
      
      function selectCustomer(id, name) {
        hiddenInput.value = id;
        input.value = name;
        container.classList.add('has-value');
        container.classList.remove('open');
      }
      
      function updateHighlight() {
        const options = dropdown.querySelectorAll('.search-select-option');
        options.forEach((opt, idx) => {
          opt.classList.toggle('highlighted', idx === highlightedIndex);
        });
        if (highlightedIndex >= 0 && options[highlightedIndex]) {
          options[highlightedIndex].scrollIntoView({ block: 'nearest' });
        }
      }
      
      input.addEventListener('focus', () => {
        renderOptions(input.value);
        container.classList.add('open');
      });
      
      input.addEventListener('input', () => {
        renderOptions(input.value);
        container.classList.add('open');
        // Clear selection if user types something different
        if (hiddenInput.value) {
          const selected = customers.find(c => c.id === hiddenInput.value);
          if (selected && input.value !== selected.name) {
            hiddenInput.value = '';
            container.classList.remove('has-value');
          }
        }
      });
      
      input.addEventListener('keydown', (e) => {
        const options = dropdown.querySelectorAll('.search-select-option');
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          highlightedIndex = Math.min(highlightedIndex + 1, options.length - 1);
          updateHighlight();
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          highlightedIndex = Math.max(highlightedIndex - 1, 0);
          updateHighlight();
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (highlightedIndex >= 0 && options[highlightedIndex]) {
            const opt = options[highlightedIndex];
            selectCustomer(opt.dataset.id, opt.dataset.name);
          }
        } else if (e.key === 'Escape') {
          container.classList.remove('open');
        }
      });
      
      dropdown.addEventListener('click', (e) => {
        const option = e.target.closest('.search-select-option');
        if (option) {
          selectCustomer(option.dataset.id, option.dataset.name);
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          container.classList.remove('open');
        }
      });
    }
    
    function clearCustomerSelect() {
      $('#deal-customer').value = '';
      $('#deal-customer-search').value = '';
      $('#customer-search-select').classList.remove('has-value');
      $('#deal-customer-search').focus();
    }
    
    function renderApptTypeMenu() {
      $('#appt-type-menu').innerHTML = appointmentTypes.map(t => `<div class="dropdown-item" onclick="openApptModal('${t.id}')"><span class="dropdown-icon">${t.icon}</span><span>${t.name}</span></div>`).join('');
    }
    
    function renderCalendarLegend() {
      const items = [...appointmentTypes.map(t => ({ color: t.color, label: `${t.icon} ${t.name}` })), ...eventTypes.map(t => ({ color: t.color, label: `${t.icon} ${t.name} (Deal)` }))];
      $('#calendar-legend').innerHTML = items.map(i => `<div class="calendar-legend-item"><span class="calendar-legend-dot" style="background:${i.color};"></span><span>${i.label}</span></div>`).join('');
    }
    
    function toggleDropdown(id) { 
      const dropdown = $('#' + id);
      const isOpening = !dropdown.classList.contains('open');
      dropdown.classList.toggle('open'); 
      
      if (isOpening) {
        const btn = dropdown.querySelector('.dropdown-btn');
        const menu = dropdown.querySelector('.dropdown-menu');
        const rect = btn.getBoundingClientRect();
        menu.style.position = 'fixed';
        menu.style.top = (rect.bottom + 4) + 'px';
        menu.style.left = rect.left + 'px';
        menu.style.right = 'auto';
      }
    }
    function setupDropdownClose() { document.addEventListener('click', e => { if (!e.target.closest('.dropdown')) $$('.dropdown.open').forEach(d => d.classList.remove('open')); }); }
    
    function renderPipeline() {
      const container = $('#pipeline-container'); container.innerHTML = '';
      const filteredStages = stages.filter(s => selectedStages.has(s.stage_id));
      filteredStages.forEach(stage => {
        const stageDeals = deals.filter(d => d.stage === stage.stage_id);
        const column = createElement('div', { className: 'pipeline-column', dataset: { stage: stage.stage_id } });
        column.innerHTML = `<div class="column-header"><span class="stage-dot" style="background-color:${stage.color}"></span><span class="column-title">${stage.label}</span><span class="column-count">${stageDeals.length}</span></div>`;
        const content = createElement('div', { className: 'column-content drop-zone' });
        if (stageDeals.length === 0) content.innerHTML = '<div class="empty-column">No deals</div>';
        else stageDeals.forEach(deal => content.appendChild(createDealCard(deal)));
        content.addEventListener('dragover', e => { e.preventDefault(); content.classList.add('drag-over'); });
        content.addEventListener('dragleave', () => content.classList.remove('drag-over'));
        content.addEventListener('drop', async e => { e.preventDefault(); content.classList.remove('drag-over'); if (draggedDeal && draggedDeal.stage !== stage.stage_id) await updateDealStage(draggedDeal.id, stage.stage_id); });
        column.appendChild(content); container.appendChild(column);
      });
    }
    
    function createDealCard(deal) {
      const card = createElement('div', { className: 'deal-card', draggable: true, dataset: { id: deal.id } });
      const customer = deal.customers, thisEvents = dealEvents.filter(e => e.job_id === deal.id).slice(0, 2);
      let html = `<div class="deal-card-title">${deal.name || 'Untitled'}</div>`;
      if (customer) html += `<div class="deal-card-customer">${customer.name}</div>`;
      if (thisEvents.length > 0) { 
        html += '<div class="deal-card-dates">'; 
        thisEvents.forEach(e => { 
          const et = e.job_event_types || eventTypes.find(t => t.id === e.event_type_id); 
          if (et) {
            const dateDisplay = e.event_end_date && e.event_end_date !== e.event_date 
              ? `${formatDate(e.event_date)} - ${formatDate(e.event_end_date)}`
              : formatDate(e.event_date);
            html += `<div class="deal-card-date"><span class="deal-card-date-label">${et.icon} ${et.name}</span>${dateDisplay}</div>`; 
          }
        }); 
        html += '</div>'; 
      }
      if (deal.estimated_value) html += `<div class="deal-card-value">${formatCurrency(deal.estimated_value)}</div>`;
      card.innerHTML = html;
      card.addEventListener('dragstart', () => { draggedDeal = deal; card.classList.add('dragging'); });
      card.addEventListener('dragend', () => { draggedDeal = null; card.classList.remove('dragging'); });
      card.addEventListener('click', () => openDealModal(deal));
      return card;
    }
    
    async function updateDealStage(dealId, newStage) {
      try { const supabase = await app.waitForSupabase(); await supabase.from('jobs').update({ stage: newStage, updated_at: new Date().toISOString() }).eq('id', dealId); const deal = deals.find(d => d.id === dealId); if (deal) deal.stage = newStage; renderPipeline(); showToast('Deal moved', 'success'); }
      catch (err) { console.error(err); showToast('Failed to move deal', 'error'); }
    }
    
    let currentDeal = null; // Track the current deal for email
    
    function openDealModal(deal = null) {
      currentDealEvents = []; currentDealItems = []; currentDeal = deal;
      if (deal) {
        $('#deal-modal-title').textContent = 'Edit Deal'; $('#delete-deal-btn').style.display = 'block'; $('#deal-id').value = deal.id;
        $('#deal-name').value = deal.name || ''; 
        // Set customer search field
        $('#deal-customer').value = deal.customer_id || '';
        const customer = customers.find(c => c.id === deal.customer_id);
        $('#deal-customer-search').value = customer?.name || '';
        if (customer) {
          $('#customer-search-select').classList.add('has-value');
        } else {
          $('#customer-search-select').classList.remove('has-value');
        }
        $('#deal-stage').value = deal.stage || stages[0]?.stage_id;
        $('#deal-value').value = deal.estimated_value || ''; $('#deal-quote').value = deal.quote_id || ''; $('#deal-notes').value = deal.notes || '';
        currentDealItems = deal.job_items || [];
        currentDealEvents = dealEvents.filter(e => e.job_id === deal.id).map(e => ({ id: e.id, event_type_id: e.event_type_id, event_date: e.event_date, event_end_date: e.event_end_date || '', notes: e.notes || '', isExisting: true }));
        // Show email button if deal has customer with email
        const hasEmail = deal.customers?.email;
        $('#email-deal-btn').style.display = hasEmail ? 'block' : 'none';
      } else { 
        $('#deal-modal-title').textContent = 'New Deal'; $('#delete-deal-btn').style.display = 'none'; $('#deal-form').reset(); $('#deal-id').value = ''; $('#deal-stage').value = stages[0]?.stage_id || ''; 
        // Clear customer search
        $('#deal-customer').value = '';
        $('#deal-customer-search').value = '';
        $('#customer-search-select').classList.remove('has-value');
        $('#email-deal-btn').style.display = 'none';
      }
      renderDealEvents(); renderDealItems(); $('#deal-modal').classList.add('active');
    }
    
    function closeDealModal() { $('#deal-modal').classList.remove('active'); }
    
    async function saveDeal() {
      const id = $('#deal-id').value;
      const data = { name: $('#deal-name').value, customer_id: $('#deal-customer').value || null, stage: $('#deal-stage').value, estimated_value: parseFloat($('#deal-value').value) || null, quote_id: $('#deal-quote').value || null, notes: $('#deal-notes').value, job_items: currentDealItems, updated_at: new Date().toISOString() };
      if (!data.name) { showToast('Deal name is required', 'error'); return; }
      try {
        const supabase = await app.waitForSupabase(); let dealId = id;
        if (id) await supabase.from('jobs').update(data).eq('id', id);
        else { const { data: numData } = await supabase.rpc('generate_job_number'); data.job_number = numData; const { data: newDeal } = await supabase.from('jobs').insert([data]).select().single(); dealId = newDeal.id; }
        await saveDealEvents(supabase, dealId); closeDealModal(); await loadData(); renderPipeline(); showToast(id ? 'Deal updated' : 'Deal created', 'success');
      } catch (err) { console.error(err); showToast('Failed to save deal', 'error'); }
    }
    
    async function saveDealEvents(supabase, dealId) {
      const existingIds = currentDealEvents.filter(e => e.isExisting).map(e => e.id);
      const { data: dbEvents } = await supabase.from('job_events').select('id').eq('job_id', dealId);
      const toDelete = (dbEvents || []).map(e => e.id).filter(id => !existingIds.includes(id));
      if (toDelete.length) await supabase.from('job_events').delete().in('id', toDelete);
      for (const event of currentDealEvents) {
        if (!event.event_type_id || !event.event_date) continue;
        const eventData = { job_id: dealId, event_type_id: event.event_type_id, event_date: event.event_date, event_end_date: event.event_end_date || null, notes: event.notes || null };
        if (event.isExisting) await supabase.from('job_events').update(eventData).eq('id', event.id);
        else await supabase.from('job_events').insert([eventData]);
      }
    }
    
    async function deleteDeal() {
      const id = $('#deal-id').value; if (!id || !confirm('Delete this deal?')) return;
      try { const supabase = await app.waitForSupabase(); await supabase.from('jobs').delete().eq('id', id); closeDealModal(); await loadData(); renderPipeline(); showToast('Deal deleted', 'success'); }
      catch (err) { showToast('Failed to delete', 'error'); }
    }
    
    function addDealEvent() { currentDealEvents.push({ id: crypto.randomUUID(), event_type_id: eventTypes[0]?.id || '', event_date: '', event_end_date: '', notes: '', isExisting: false }); renderDealEvents(); }
    function removeDealEvent(id) { currentDealEvents = currentDealEvents.filter(e => e.id !== id); renderDealEvents(); }
    function renderDealEvents() {
      const container = $('#deal-events-container');
      if (currentDealEvents.length === 0) { container.innerHTML = '<p class="text-muted text-sm">No dates scheduled.</p>'; return; }
      container.innerHTML = currentDealEvents.map(e => `
        <div class="event-row" style="flex-wrap:wrap;">
          <select class="form-select" style="flex:1;min-width:120px;" onchange="updateDealEvent('${e.id}','event_type_id',this.value)">
            ${eventTypes.map(t => `<option value="${t.id}" ${t.id === e.event_type_id ? 'selected' : ''}>${t.icon} ${t.name}</option>`).join('')}
          </select>
          <div style="display:flex;align-items:center;gap:var(--space-xs);">
            <input type="date" class="form-input" style="width:130px;" value="${e.event_date || ''}" onchange="updateDealEvent('${e.id}','event_date',this.value)" title="Start date">
            <span class="text-muted">to</span>
            <input type="date" class="form-input" style="width:130px;" value="${e.event_end_date || ''}" onchange="updateDealEvent('${e.id}','event_end_date',this.value)" title="End date (optional)">
          </div>
          <button type="button" class="btn btn-sm" style="color:var(--color-danger);" onclick="removeDealEvent('${e.id}')">√ó</button>
        </div>
      `).join('');
    }
    function updateDealEvent(id, field, value) { const e = currentDealEvents.find(x => x.id === id); if (e) e[field] = value; }
    
    function addDealItem() { currentDealItems.push({ id: crypto.randomUUID(), name: '', quantity: '' }); renderDealItems(); }
    function removeDealItem(id) { currentDealItems = currentDealItems.filter(i => i.id !== id); renderDealItems(); }
    function renderDealItems() {
      const container = $('#deal-items-container');
      if (currentDealItems.length === 0) { container.innerHTML = '<p class="text-muted text-sm">No items added.</p>'; return; }
      
      const options = dealItemTypes.length > 0 
        ? '<option value="">Select item...</option>' + dealItemTypes.map(t => `<option value="${t}">${t}</option>`).join('')
        : '<option value="">No item types - add in Settings</option>';
      
      container.innerHTML = currentDealItems.map(i => {
        const selectedOptions = options.replace(`value="${i.name}"`, `value="${i.name}" selected`);
        return `<div class="item-row">
          <select class="form-select" style="flex:2;" onchange="updateDealItem('${i.id}','name',this.value)">${selectedOptions}</select>
          <input type="number" class="form-input" style="width:80px;" placeholder="Qty" value="${i.quantity || ''}" onchange="updateDealItem('${i.id}','quantity',this.value)">
          <button type="button" class="btn btn-sm" style="color:var(--color-danger);" onclick="removeDealItem('${i.id}')">√ó</button>
        </div>`;
      }).join('');
    }
    function updateDealItem(id, field, value) { const i = currentDealItems.find(x => x.id === id); if (i) i[field] = value; }
    
    function openApptModal(typeId = null, appt = null) {
      $$('.dropdown.open').forEach(d => d.classList.remove('open'));
      currentAppt = appt;
      if (appt) { 
        $('#appt-modal-title').textContent = 'Edit Appointment'; 
        $('#delete-appt-btn').style.display = 'block'; 
        $('#appt-id').value = appt.id; 
        $('#appt-type').value = appt.appointment_type_id || ''; 
        $('#appt-title').value = appt.title || ''; 
        $('#appt-date').value = appt.appointment_date || ''; 
        $('#appt-time').value = appt.appointment_time || ''; 
        $('#appt-customer').value = appt.customer_id || ''; 
        $('#appt-deal').value = appt.deal_id || ''; 
        $('#appt-location').value = appt.location || ''; 
        $('#appt-notes').value = appt.notes || ''; 
        // Show email button if appointment has customer with email
        const hasEmail = appt.customers?.email;
        $('#email-appt-btn').style.display = hasEmail ? 'block' : 'none';
      }
      else { 
        $('#appt-modal-title').textContent = 'New Appointment'; 
        $('#delete-appt-btn').style.display = 'none'; 
        $('#email-appt-btn').style.display = 'none';
        $('#appt-form').reset(); 
        $('#appt-id').value = ''; 
        if (typeId) $('#appt-type').value = typeId; 
        $('#appt-date').value = new Date().toISOString().split('T')[0]; 
      }
      $('#appt-modal').classList.add('active');
    }
    
    function closeApptModal() { $('#appt-modal').classList.remove('active'); }
    
    async function saveAppt() {
      const id = $('#appt-id').value;
      const data = { appointment_type_id: $('#appt-type').value || null, title: $('#appt-title').value, appointment_date: $('#appt-date').value, appointment_time: $('#appt-time').value || null, customer_id: $('#appt-customer').value || null, deal_id: $('#appt-deal').value || null, location: $('#appt-location').value, notes: $('#appt-notes').value, updated_at: new Date().toISOString() };
      if (!data.title || !data.appointment_date) { showToast('Title and date are required', 'error'); return; }
      try { const supabase = await app.waitForSupabase(); if (id) await supabase.from('appointments').update(data).eq('id', id); else await supabase.from('appointments').insert([data]); closeApptModal(); await loadData(); renderCalendar(); showToast(id ? 'Appointment updated' : 'Appointment created', 'success'); }
      catch (err) { console.error(err); showToast('Failed to save appointment', 'error'); }
    }
    
    async function deleteAppt() {
      const id = $('#appt-id').value; if (!id || !confirm('Delete this appointment?')) return;
      try { const supabase = await app.waitForSupabase(); await supabase.from('appointments').delete().eq('id', id); closeApptModal(); await loadData(); renderCalendar(); showToast('Appointment deleted', 'success'); }
      catch (err) { showToast('Failed to delete', 'error'); }
    }
    
    function openStageSettings() { renderStageList(); $('#stage-modal').classList.add('active'); }
    function closeStageSettings() { $('#stage-modal').classList.remove('active'); $('#add-stage-form').style.display = 'none'; }
    
    let draggedStageId = null;
    
    function renderStageList() {
      const container = $('#stage-list');
      container.innerHTML = stages.map((s, i) => `
        <div class="stage-item" draggable="true" data-id="${s.id}" data-index="${i}"
             ondragstart="handleStageDragStart(event)" ondragover="handleStageDragOver(event)" 
             ondrop="handleStageDrop(event)" ondragend="handleStageDragEnd(event)"
             style="display:flex;align-items:center;gap:var(--space-md);padding:var(--space-sm) var(--space-md);background:var(--color-bg-soft);border-radius:var(--radius-md);margin-bottom:var(--space-sm);cursor:grab;">
          <span class="drag-handle" style="color:var(--color-text-muted);cursor:grab;">‚ãÆ‚ãÆ</span>
          <input type="color" value="${s.color}" onchange="updateStageColor('${s.id}', this.value)" 
                 style="width:28px;height:28px;border:none;border-radius:var(--radius-sm);cursor:pointer;padding:0;">
          <input type="text" class="form-input" value="${s.label}" 
                 onchange="updateStageName('${s.id}', this.value)" 
                 style="flex:1;font-weight:500;background:transparent;border:1px solid transparent;"
                 onfocus="this.style.borderColor='var(--color-primary)';this.style.background='white'"
                 onblur="this.style.borderColor='transparent';this.style.background='transparent'">
          <button class="btn btn-ghost btn-sm" style="color:var(--color-danger);" onclick="deleteStage('${s.id}')" title="Delete stage">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
          </button>
        </div>
      `).join('');
    }
    
    function handleStageDragStart(e) {
      draggedStageId = e.target.closest('.stage-item').dataset.id;
      e.target.closest('.stage-item').style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleStageDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const item = e.target.closest('.stage-item');
      if (item) {
        item.style.borderTop = '2px solid var(--color-primary)';
      }
    }
    
    function handleStageDragEnd(e) {
      e.target.closest('.stage-item')?.style && (e.target.closest('.stage-item').style.opacity = '1');
      $$('.stage-item').forEach(el => el.style.borderTop = '');
      draggedStageId = null;
    }
    
    async function handleStageDrop(e) {
      e.preventDefault();
      const targetItem = e.target.closest('.stage-item');
      if (!targetItem || !draggedStageId) return;
      
      const targetId = targetItem.dataset.id;
      if (targetId === draggedStageId) return;
      
      const draggedIdx = stages.findIndex(s => s.id === draggedStageId);
      const targetIdx = stages.findIndex(s => s.id === targetId);
      
      if (draggedIdx === -1 || targetIdx === -1) return;
      
      // Reorder stages array
      const [draggedStage] = stages.splice(draggedIdx, 1);
      stages.splice(targetIdx, 0, draggedStage);
      
      // Update sort_order for all stages
      try {
        const supabase = await app.waitForSupabase();
        const updates = stages.map((s, i) => 
          supabase.from('job_stages').update({ sort_order: i }).eq('id', s.id)
        );
        await Promise.all(updates);
        await loadData();
        renderStageList();
        renderPipeline();
      } catch (err) {
        console.error('Reorder failed:', err);
        showToast('Failed to reorder stages', 'error');
        await loadData();
        renderStageList();
      }
    }
    
    async function updateStageName(id, newName) {
      if (!newName.trim()) {
        showToast('Stage name cannot be empty', 'error');
        renderStageList();
        return;
      }
      try {
        const supabase = await app.waitForSupabase();
        await supabase.from('job_stages').update({ label: newName.trim() }).eq('id', id);
        await loadData();
        renderPipeline();
        showToast('Stage renamed', 'success');
      } catch (err) {
        showToast('Failed to rename: ' + err.message, 'error');
      }
    }
    
    async function updateStageColor(id, newColor) {
      try {
        const supabase = await app.waitForSupabase();
        await supabase.from('job_stages').update({ color: newColor }).eq('id', id);
        await loadData();
        renderPipeline();
      } catch (err) {
        showToast('Failed to update color', 'error');
      }
    }
    
    async function saveNewStage() {
      const label = $('#new-stage-label').value.trim(), color = $('#new-stage-color').value; if (!label) return;
      try { const supabase = await app.waitForSupabase(); await supabase.from('job_stages').insert([{ stage_id: label.toLowerCase().replace(/\s+/g, '-'), label, color, sort_order: Math.max(...stages.map(s => s.sort_order), -1) + 1 }]); await loadData(); renderStageList(); renderPipeline(); $('#add-stage-form').style.display = 'none'; $('#new-stage-label').value = ''; showToast('Stage added', 'success'); }
      catch (err) { showToast('Failed to add stage', 'error'); }
    }
    async function deleteStage(id) { 
      const stage = stages.find(s => s.id === id);
      const dealsInStage = deals.filter(d => d.stage_id === stage?.stage_id).length;
      if (dealsInStage > 0) {
        if (!confirm(`This stage has ${dealsInStage} deal(s). Delete anyway? The deals will need to be moved to another stage.`)) return;
      } else {
        if (!confirm('Delete this stage?')) return;
      }
      try { const supabase = await app.waitForSupabase(); await supabase.from('job_stages').delete().eq('id', id); await loadData(); renderStageList(); renderPipeline(); showToast('Stage deleted', 'success'); } catch (err) { showToast('Failed to delete', 'error'); } 
    }
    
    function setupViewToggle() {
      $$('.view-toggle button').forEach(btn => {
        btn.addEventListener('click', () => {
          $$('.view-toggle button').forEach(b => b.classList.remove('active')); btn.classList.add('active');
          const view = btn.dataset.view;
          $('#pipeline-view').style.display = view === 'pipeline' ? 'block' : 'none';
          $('#calendar-view').style.display = view === 'calendar' ? 'block' : 'none';
          $('#list-view').style.display = view === 'list' ? 'block' : 'none';
          if (view === 'calendar') renderCalendar(); if (view === 'list') renderListView();
        });
      });
    }
    
    let currentCalendarDate = new Date();
    function prevMonth() { currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() - 1, 1); renderCalendar(); }
    function nextMonth() { currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 1); renderCalendar(); }
    function goToToday() { currentCalendarDate = new Date(); renderCalendar(); }
    
    function renderCalendar() {
      const year = currentCalendarDate.getFullYear(), month = currentCalendarDate.getMonth();
      const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      $('#calendar-title').textContent = `${monthNames[month]} ${year}`;
      const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
      const startDayOfWeek = firstDay.getDay(), daysInMonth = lastDay.getDate(), prevMonthLastDay = new Date(year, month, 0).getDate();
      const events = buildEventsLookup(), today = new Date(), isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
      let html = dayNames.map(d => `<div class="calendar-day-header">${d}</div>`).join('');
      const totalCells = Math.ceil((startDayOfWeek + daysInMonth) / 7) * 7; let dayCount = 1, nextMonthDay = 1;
      for (let i = 0; i < totalCells; i++) {
        let dayNum, isOtherMonth = false, dateStr;
        if (i < startDayOfWeek) { dayNum = prevMonthLastDay - startDayOfWeek + i + 1; isOtherMonth = true; const pm = month === 0 ? 11 : month - 1, py = month === 0 ? year - 1 : year; dateStr = `${py}-${String(pm + 1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`; }
        else if (dayCount > daysInMonth) { dayNum = nextMonthDay++; isOtherMonth = true; const nm = month === 11 ? 0 : month + 1, ny = month === 11 ? year + 1 : year; dateStr = `${ny}-${String(nm + 1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`; }
        else { dayNum = dayCount++; dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`; }
        const isToday = isCurrentMonth && !isOtherMonth && dayNum === today.getDate(), dayEvents = events[dateStr] || [];
        html += `<div class="calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}"><span class="calendar-day-number">${dayNum}</span><div class="calendar-events">${renderDayEvents(dayEvents)}</div></div>`;
      }
      $('#calendar-grid').innerHTML = html;
    }
    
    function buildEventsLookup() {
      const events = {};
      appointments.forEach(appt => { const dateStr = appt.appointment_date, type = appt.appointment_types || appointmentTypes.find(t => t.id === appt.appointment_type_id); if (!events[dateStr]) events[dateStr] = []; events[dateStr].push({ type: 'appointment', data: appt, color: type?.color || '#6366f1', icon: type?.icon || 'üìÖ', label: appt.title }); });
      
      // Deal events - support date ranges and show customer last name + event type
      // Filter by selected stages
      const filteredDeals = getFilteredDeals();
      const filteredDealIds = new Set(filteredDeals.map(d => d.id));
      
      dealEvents.forEach(event => { 
        const deal = deals.find(d => d.id === event.job_id);
        const type = event.job_event_types || eventTypes.find(t => t.id === event.event_type_id); 
        if (!deal || !type) return;
        
        // Skip if deal is filtered out
        if (!filteredDealIds.has(deal.id)) return;
        
        // Get customer last name and event type name
        const customerName = deal.customers?.name || '';
        const lastName = customerName.split(' ').pop() || customerName;
        const label = `${lastName} - ${type.name}`;
        
        // Get start and end dates
        const startDate = event.event_date;
        const endDate = event.event_end_date || startDate;
        
        // Add event to each day in the range
        let currentDate = new Date(startDate);
        const lastDate = new Date(endDate);
        
        while (currentDate <= lastDate) {
          const dateStr = currentDate.toISOString().split('T')[0];
          if (!events[dateStr]) events[dateStr] = [];
          events[dateStr].push({ 
            type: 'deal_event', 
            data: { event, deal }, 
            color: type?.color || '#6366f1', 
            icon: type?.icon || 'üìÖ', 
            label: label,
            isRange: startDate !== endDate,
            isStart: dateStr === startDate,
            isEnd: dateStr === endDate
          });
          currentDate.setDate(currentDate.getDate() + 1);
        }
      });
      return events;
    }
    
    function renderDayEvents(dayEvents) {
      if (!dayEvents.length) return '';
      const maxVisible = 3;
      let html = dayEvents.slice(0, maxVisible).map(e => {
        const bgColor = hexToRgba(e.color, 0.2);
        const onclick = e.type === 'appointment' ? `openApptModal(null, appointments.find(a => a.id === '${e.data.id}'))` : `openDealModal(deals.find(d => d.id === '${e.data.deal.id}'))`;
        // For range events, show icon on start, just label on middle/end
        const showIcon = !e.isRange || e.isStart;
        const displayLabel = showIcon ? `${e.icon} ${e.label}` : e.label;
        return `<div class="calendar-event" style="background:${bgColor};color:${e.color};border-left:3px solid ${e.color};" onclick="${onclick}">${displayLabel}</div>`;
      }).join('');
      if (dayEvents.length > maxVisible) html += `<div class="calendar-more">+${dayEvents.length - maxVisible} more</div>`;
      return html;
    }
    
    function hexToRgba(hex, alpha) { const r = parseInt(hex.slice(1,3), 16), g = parseInt(hex.slice(3,5), 16), b = parseInt(hex.slice(5,7), 16); return `rgba(${r},${g},${b},${alpha})`; }
    
    function renderListView() {
      const filteredDeals = getFilteredDeals();
      $('#deals-table-body').innerHTML = filteredDeals.map(d => {
        const stage = stages.find(s => s.stage_id === d.stage), thisEvents = dealEvents.filter(e => e.job_id === d.id);
        const nextEvent = thisEvents.sort((a,b) => new Date(a.event_date) - new Date(b.event_date))[0];
        return `<tr><td><strong>${d.name}</strong>${d.job_number ? `<br><span class="text-muted text-sm">${d.job_number}</span>` : ''}</td><td>${d.customers?.name || '‚Äî'}</td><td><span class="badge" style="background:${stage?.color || '#666'};color:white;">${stage?.label || d.stage}</span></td><td>${nextEvent ? formatDate(nextEvent.event_date) : '‚Äî'}</td><td>${d.estimated_value ? formatCurrency(d.estimated_value) : '‚Äî'}</td><td><button class="btn btn-sm btn-secondary" onclick="openDealModal(deals.find(x => x.id === '${d.id}'))">Edit</button></td></tr>`;
      }).join('');
    }
    
    // ==========================================
    // EMAIL FUNCTIONALITY
    // ==========================================
    
    function replaceEmailVariables(text, data) {
      return text
        .replace(/\{\{first_name\}\}/g, data.firstName || data.customerName?.split(' ')[0] || 'there')
        .replace(/\{\{customer_name\}\}/g, data.customerName || '')
        .replace(/\{\{customer_email\}\}/g, data.customerEmail || '')
        .replace(/\{\{deal_name\}\}/g, data.dealName || '')
        .replace(/\{\{company_name\}\}/g, 'Homestead Cabinet Design')
        .replace(/\{\{appointment_type\}\}/g, data.appointmentType || '')
        .replace(/\{\{appointment_date\}\}/g, data.appointmentDate ? formatDate(data.appointmentDate) : '')
        .replace(/\{\{appointment_time\}\}/g, data.appointmentTime || '')
        .replace(/\{\{appointment_location\}\}/g, data.appointmentLocation || '')
        .replace(/\{\{location\}\}/g, data.appointmentLocation || '')
        .replace(/\{\{installation_date\}\}/g, data.installationDate ? formatDate(data.installationDate) : '')
        .replace(/\{\{shop_date\}\}/g, data.shopDate ? formatDate(data.shopDate) : '')
        .replace(/\{\{#if [^}]+\}\}[\s\S]*?\{\{\/if\}\}/g, (match) => {
          // Simple conditional handling - check if variable has value
          const varMatch = match.match(/\{\{#if ([^}]+)\}\}/);
          if (varMatch) {
            const varName = varMatch[1].trim();
            const value = data[varName] || data[varName.replace(/_([a-z])/g, (g) => g[1].toUpperCase())];
            if (value) {
              return match.replace(/\{\{#if [^}]+\}\}/g, '').replace(/\{\{\/if\}\}/g, '');
            }
          }
          return '';
        });
    }
    
    function openDealEmailModal() {
      if (!currentDeal) return;
      
      const stage = $('#deal-stage').value;
      const template = emailTemplates.find(t => t.template_type === 'deal_stage' && t.stage_id === stage);
      
      if (!template) {
        showToast('No email template found for this stage. Create one in Email Templates settings.', 'error');
        return;
      }
      
      const customer = currentDeal.customers;
      if (!customer?.email) {
        showToast('Customer does not have an email address', 'error');
        return;
      }
      
      // Get deal events for dates
      const events = dealEvents.filter(e => e.job_id === currentDeal.id);
      const installEvent = events.find(e => {
        const eventType = eventTypes.find(t => t.id === e.event_type_id);
        return eventType?.name?.toLowerCase().includes('install');
      });
      const shopEvent = events.find(e => {
        const eventType = eventTypes.find(t => t.id === e.event_type_id);
        return eventType?.name?.toLowerCase().includes('shop');
      });
      
      const data = {
        firstName: customer.first_name || customer.name?.split(' ')[0] || '',
        customerName: customer.name,
        customerEmail: customer.email,
        dealName: currentDeal.name,
        installationDate: installEvent?.event_date,
        shopDate: shopEvent?.event_date
      };
      
      const subject = replaceEmailVariables(template.subject, data);
      const body = replaceEmailVariables(template.body, data);
      
      showEmailPreviewModal({
        to: customer.email,
        subject,
        body,
        templateId: template.id,
        customerId: currentDeal.customer_id,
        dealId: currentDeal.id
      });
    }
    
    let currentAppt = null;
    
    function openApptEmailModal() {
      if (!currentAppt) return;
      
      const template = emailTemplates.find(t => t.template_type === 'appointment');
      
      if (!template) {
        showToast('No appointment email template found. Create one in Email Templates settings.', 'error');
        return;
      }
      
      const customer = currentAppt.customers;
      if (!customer?.email) {
        showToast('No customer email for this appointment', 'error');
        return;
      }
      
      const apptType = appointmentTypes.find(t => t.id === currentAppt.appointment_type_id);
      
      const data = {
        firstName: customer.first_name || customer.name?.split(' ')[0] || '',
        customerName: customer.name,
        customerEmail: customer.email,
        appointmentType: apptType ? `${apptType.icon} ${apptType.name}` : 'Appointment',
        appointmentDate: currentAppt.appointment_date,
        appointmentTime: currentAppt.appointment_time,
        appointmentLocation: currentAppt.location || ''
      };
      
      const subject = replaceEmailVariables(template.subject, data);
      const body = replaceEmailVariables(template.body, data);
      
      showEmailPreviewModal({
        to: customer.email,
        subject,
        body,
        templateId: template.id,
        customerId: currentAppt.customer_id,
        appointmentId: currentAppt.id
      });
    }
    
    function showEmailPreviewModal(emailData) {
      const content = createElement('form', { id: 'email-preview-form' });
      content.innerHTML = `
        <div class="form-group">
          <label class="form-label">To</label>
          <input type="email" id="email-to" class="form-input" value="${emailData.to}" readonly style="background: var(--color-bg-soft);">
        </div>
        <div class="form-group">
          <label class="form-label">Subject</label>
          <input type="text" id="email-subject" class="form-input" value="${emailData.subject.replace(/"/g, '&quot;')}" required>
        </div>
        <div class="form-group">
          <label class="form-label">Message</label>
          <textarea id="email-body" class="form-textarea" rows="15" required>${emailData.body}</textarea>
          <p class="form-help">Edit the message as needed before sending.</p>
        </div>
      `;
      
      const footer = createElement('div', { className: 'btn-group' });
      const cancelBtn = createElement('button', { type: 'button', className: 'btn btn-secondary', textContent: 'Cancel' });
      const sendBtn = createElement('button', { type: 'button', className: 'btn btn-primary', innerHTML: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Send Email' });
      footer.appendChild(cancelBtn);
      footer.appendChild(sendBtn);
      
      const modal = createModal({
        title: 'üìß Send Email',
        content,
        footer,
        size: 'lg'
      });
      
      cancelBtn.onclick = () => closeModal(modal);
      sendBtn.onclick = async () => {
        const to = $('#email-to').value;
        const subject = $('#email-subject').value;
        const body = $('#email-body').value;
        
        if (!subject || !body) {
          showToast('Subject and message are required', 'error');
          return;
        }
        
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;margin-right:6px;"></span> Sending...';
        
        try {
          const response = await fetch('/.netlify/functions/send-template-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              to_email: to,
              subject,
              body,
              template_id: emailData.templateId,
              customer_id: emailData.customerId,
              deal_id: emailData.dealId,
              appointment_id: emailData.appointmentId
            })
          });
          
          const result = await response.json();
          
          if (!response.ok) {
            throw new Error(result.error || 'Failed to send email');
          }
          
          showToast('Email sent successfully!', 'success');
          closeModal(modal);
        } catch (err) {
          console.error('Email error:', err);
          showToast('Failed to send email: ' + err.message, 'error');
          sendBtn.disabled = false;
          sendBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Send Email';
        }
      };
    }
    
    init();
  </script>
</body>
</html>
