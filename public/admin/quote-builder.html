<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quote Builder | Admin | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css?v=50">
  <style>
    .builder-layout {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: var(--space-xl);
    }
    
    .line-items-list {
      min-height: 200px;
    }
    
    .line-item-row {
      display: grid;
      grid-template-columns: 60px 1fr 120px 120px 100px auto;
      gap: var(--space-md);
      padding: var(--space-md);
      background: var(--color-bg-card);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-sm);
      align-items: start;
    }
    
    .line-item-row.optional {
      background: rgba(201, 166, 107, 0.05);
      border-color: var(--color-accent);
    }
    
    /* Package styles */
    .packages-section {
      margin-top: var(--space-lg);
    }
    
    .packages-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-md);
    }
    
    .packages-header h4 {
      margin: 0;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .package-card {
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-lg);
      background: var(--color-bg-card);
    }
    
    .package-card.recommended {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 1px var(--color-primary);
    }
    
    .package-card.selected {
      border-color: var(--color-success);
      box-shadow: 0 0 0 2px var(--color-success);
    }
    
    .package-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      padding: var(--space-md) var(--space-lg);
      background: var(--color-bg-soft);
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      cursor: grab;
    }
    
    .package-header:active {
      cursor: grabbing;
    }
    
    .package-drag-handle {
      color: var(--color-text-muted);
      cursor: grab;
      padding: var(--space-xs);
    }
    
    .package-info {
      flex: 1;
      margin-left: var(--space-sm);
    }
    
    .package-title {
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .package-description {
      font-size: 0.875rem;
      color: var(--color-text-muted);
      margin-top: var(--space-xs);
    }
    
    .package-price {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-text);
    }
    
    .package-actions {
      position: relative;
    }
    
    .package-menu {
      position: absolute;
      right: 0;
      top: 100%;
      background: white;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 100;
      min-width: 180px;
      display: none;
    }
    
    .package-menu.show {
      display: block;
    }
    
    .package-menu-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      cursor: pointer;
      font-size: 0.875rem;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    
    .package-menu-item:hover {
      background: var(--color-bg-soft);
    }
    
    .package-menu-item.danger {
      color: var(--color-danger);
    }
    
    .package-menu-divider {
      height: 1px;
      background: var(--color-border);
      margin: var(--space-xs) 0;
    }
    
    .package-items {
      padding: var(--space-md) var(--space-lg);
    }
    
    .package-items-header {
      display: grid;
      grid-template-columns: 24px 1fr 80px 100px 40px;
      gap: var(--space-sm);
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--color-border);
      font-size: 0.75rem;
      color: var(--color-text-muted);
      text-transform: uppercase;
    }
    
    .package-item-row {
      display: grid;
      grid-template-columns: 24px 1fr 80px 100px 40px;
      gap: var(--space-sm);
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--color-border-light);
      align-items: center;
      font-size: 0.875rem;
    }
    
    .package-item-row.excluded {
      opacity: 0.5;
      text-decoration: line-through;
    }
    
    .package-item-drag {
      color: var(--color-text-muted);
      cursor: grab;
    }
    
    .package-item-name {
      font-weight: 500;
    }
    
    .package-total-row {
      display: grid;
      grid-template-columns: 24px 1fr 80px 100px 40px;
      gap: var(--space-sm);
      padding: var(--space-md) 0;
      font-weight: 600;
      background: var(--color-text);
      color: white;
      margin: var(--space-md) calc(-1 * var(--space-lg));
      padding-left: var(--space-lg);
      padding-right: var(--space-lg);
    }
    
    .package-add-item {
      padding: var(--space-md) var(--space-lg);
      padding-top: 0;
    }
    
    .badge-recommended {
      background: var(--color-primary);
      color: white;
      font-size: 0.65rem;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .badge-selected {
      background: var(--color-success);
      color: white;
      font-size: 0.65rem;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      background: var(--color-bg-soft);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-md);
    }
    
    .toggle-label {
      font-weight: 500;
    }
    
    .toggle-description {
      font-size: 0.875rem;
      color: var(--color-text-muted);
    }
    
    .line-item-photo-upload {
      width: 60px;
      height: 60px;
      background: var(--color-bg-alt);
      border: 1px dashed var(--color-border);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      overflow: hidden;
    }
    
    .line-item-photo-upload img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .line-item-photo-upload:hover {
      border-color: var(--color-accent);
    }
    
    .catalog-modal-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-md);
      max-height: 400px;
      overflow-y: auto;
    }
    
    .catalog-item-card {
      background: var(--color-bg-card);
      border: 2px solid var(--color-border-light);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .catalog-item-card:hover {
      border-color: var(--color-accent);
    }
    
    .catalog-item-card.selected {
      border-color: var(--color-primary);
      background: rgba(30, 58, 95, 0.05);
    }
    
    .summary-card {
      position: sticky;
      top: calc(var(--header-height) + var(--space-xl));
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: var(--space-sm) 0;
    }
    
    .summary-row.total {
      font-weight: 700;
      font-size: 1.25rem;
      border-top: 2px solid var(--color-border);
      margin-top: var(--space-sm);
      padding-top: var(--space-md);
    }
  </style>
</head>
<body>
  <script>
    // Permission check before page loads
    const user = JSON.parse(localStorage.getItem('app_user') || 'null');
    if (!user) {
      window.location.href = '/admin/login.html';
    } else if (!user.permissions?.can_view_quotes) {
      window.location.href = user.permissions?.can_view_pipeline ? '/admin/pipeline.html' : '/admin/index.html';
    }
  </script>
  <div class="app-layout">
    <aside class="app-sidebar">
      <div class="sidebar-logo">
        <img src="/images/logo.gif" alt="Homestead Cabinet Design" style="height: 40px; filter: brightness(0) invert(1);">
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item">
            <a href="/admin/index.html" class="sidebar-nav-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
                <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
              </svg>
              Dashboard
            </a>
          </li>
          <li class="sidebar-nav-item">
            <a href="/admin/pipeline.html" class="sidebar-nav-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="21" y2="6"/>
                <line x1="8" y1="12" x2="21" y2="12"/>
                <line x1="8" y1="18" x2="21" y2="18"/>
                <line x1="3" y1="6" x2="3.01" y2="6"/>
                <line x1="3" y1="12" x2="3.01" y2="12"/>
                <line x1="3" y1="18" x2="3.01" y2="18"/>
              </svg>
              Deals Pipeline
            </a>
          </li>

          <li class="sidebar-nav-item">
            <a href="/admin/customers.html" class="sidebar-nav-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/>
              </svg>
              Customers
            </a>
          </li>
          <li class="sidebar-nav-item">
            <a href="/admin/quotes.html" class="sidebar-nav-link active">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/>
              </svg>
              Quotes
            </a>
          </li>
          <li class="sidebar-nav-item">
            <a href="/admin/invoices.html" class="sidebar-nav-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
              </svg>
              Invoices
            </a>
          </li>
        </ul>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Lead Capture</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/booking-forms.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>Booking Forms</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Catalog</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/catalog.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>Items Catalog</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/settings.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</a></li>
          </ul>
        </div>
      </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="app-main">
      <header class="app-header">
        <div class="flex items-center gap-md">
          <a href="/admin/quotes.html" class="btn btn-ghost btn-sm">← Back</a>
          <h2 id="page-title">New Quote</h2>
        </div>
        <div class="flex items-center gap-sm">
          <button class="btn btn-secondary" id="save-draft-btn">Save Draft</button>
          <button class="btn btn-primary" id="send-quote-btn">Send to Customer</button>
        </div>
      </header>
      
      <div class="app-content">
        <div class="builder-layout">
          <!-- Left Column - Quote Details -->
          <div>
            <!-- Customer & Basic Info -->
            <div class="card mb-xl">
              <div class="card-header">
                <h3 class="card-title">Quote Details</h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Customer *</label>
                    <select id="customer-select" class="form-select" required>
                      <option value="">Select customer...</option>
                    </select>
                    <div class="mt-sm">
                      <button type="button" class="btn btn-link btn-sm" id="new-customer-btn">+ Add New Customer</button>
                    </div>
                  </div>
                
                <div class="form-group">
                  <label class="form-label">Project Title *</label>
                  <input type="text" id="quote-title" class="form-input" placeholder="e.g., Kitchen Cabinet Refacing" required>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Description <span class="form-label-optional">(optional)</span></label>
                  <textarea id="quote-description" class="form-textarea" rows="2" placeholder="Brief project description..."></textarea>
                </div>
                
                <div class="grid grid-cols-3 gap-lg">
                  <div class="form-group">
                    <label class="form-label">Valid For (Days)</label>
                    <input type="number" id="valid-days" class="form-input" value="30" min="1">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Deposit Type</label>
                    <select id="deposit-type" class="form-select">
                      <option value="percentage">Percentage</option>
                      <option value="fixed">Fixed Amount</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Deposit Amount</label>
                    <div class="input-group">
                      <input type="number" id="deposit-value" class="form-input" value="50" min="0">
                      <span class="input-group-append" id="deposit-suffix">%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Bundles Section -->
            <div class="card mb-xl">
              <div class="card-header">
                <h3 class="card-title">Bundles</h3>
                <div class="btn-group">
                  <button class="btn btn-secondary btn-sm" onclick="addPackage()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Add Bundle
                  </button>
                  <button class="btn btn-ghost btn-sm" onclick="showPackagesHelp()" title="How Bundles Work">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="toggle-row">
                  <div>
                    <div class="toggle-label">Enable Bundle Selection</div>
                    <div class="toggle-description">When enabled, customers must select a bundle instead of seeing individual line items.</div>
                  </div>
                  <label class="toggle">
                    <input type="checkbox" id="packages-enabled" onchange="togglePackagesEnabled()">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div id="packages-disabled-notice" class="text-center text-muted p-lg" style="display: none;">
                  <p>Bundle selection is disabled. Enable it above to let customers choose a bundle.</p>
                </div>
                
                <div id="empty-packages" class="text-center text-muted p-xl">
                  No bundles yet. Create bundles to offer your customers different pricing tiers.
                </div>
                
                <div id="packages-container"></div>
              </div>
            </div>
            
            <!-- Line Items -->
            <div class="card mb-xl">
              <div class="card-header">
                <h3 class="card-title">Additional Line Items</h3>
                <div class="btn-group">
                  <button class="btn btn-secondary btn-sm" id="add-from-catalog-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/>
                    </svg>
                    From Catalog
                  </button>
                  <button class="btn btn-secondary btn-sm" id="add-custom-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                    Custom Item
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div class="text-center text-muted p-xl" id="empty-items">
                  No line items yet. Add items from the catalog or create custom items.
                </div>
                <div class="line-items-list" id="line-items-container">
                </div>
              </div>
            </div>
            
            <!-- Video & Notes -->
            <div class="card mb-xl">
              <div class="card-header">
                <h3 class="card-title">Additional Information</h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <label class="form-label">Video URL <span class="form-label-optional">(YouTube)</span></label>
                  <input type="url" id="video-url" class="form-input" placeholder="https://youtube.com/watch?v=...">
                  <div class="form-help">Add a video explaining the project or process</div>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Notes for Customer <span class="form-label-optional">(visible on quote)</span></label>
                  <textarea id="customer-notes" class="form-textarea" rows="3" placeholder="Any notes or terms to include on the quote..."></textarea>
                </div>
                
                <div class="form-group">
                  <label class="form-label">Internal Notes <span class="form-label-optional">(not visible to customer)</span></label>
                  <textarea id="internal-notes" class="form-textarea" rows="2" placeholder="Notes for your reference only..."></textarea>
                </div>
              </div>
            </div>
            
            <!-- Attachments -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Attachments</h3>
              </div>
              <div class="card-body">
                <div class="upload-zone" id="attachments-zone">
                  <div class="upload-zone-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                      <polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                  </div>
                  <div class="upload-zone-text">Drag files here or click to browse</div>
                  <div class="upload-zone-hint">PDF, images (max 10MB each)</div>
                  <input type="file" id="attachments-input" multiple accept=".pdf,image/*" style="display: none;">
                </div>
                <div class="file-grid mt-lg" id="attachments-list"></div>
              </div>
            </div>
          </div>
          
          <!-- Right Column - Summary -->
          <div>
            <div class="card summary-card">
              <div class="card-header">
                <h3 class="card-title">Quote Summary</h3>
              </div>
              <div class="card-body">
                <div id="summary-items">
                  <p class="text-muted text-center">Add items to see summary</p>
                </div>
                
                <div id="summary-totals" style="display: none;">
                  <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="summary-subtotal">$0.00</span>
                  </div>
                  <div class="summary-row" id="summary-tax-row">
                    <span>Tax (<span id="summary-tax-rate">6.25</span>%)</span>
                    <span id="summary-tax">$0.00</span>
                  </div>
                  <div class="summary-row total">
                    <span>Total</span>
                    <span id="summary-total">$0.00</span>
                  </div>
                </div>
                
                <div class="mt-lg p-md" style="background: var(--color-bg-alt); border-radius: var(--radius-md);">
                  <div class="flex justify-between text-sm mb-xs">
                    <span>Deposit Required</span>
                    <span id="summary-deposit">$0.00</span>
                  </div>
                  <div class="flex justify-between text-sm text-muted">
                    <span>Balance After Deposit</span>
                    <span id="summary-balance">$0.00</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script src="/js/utils.js"></script>
  <script>
    
    let customers = [];
    let catalogItems = [];
    let lineItems = [];
    let attachments = [];
    let quoteId = null;
    let pricingAttributes = [];
    let catalogItemAttributes = {}; // Map: item_id -> [attributes with options]
    
    const TAX_RATE = 0.0625;
    
    // Get quote ID from URL if editing
    const params = new URLSearchParams(window.location.search);
    quoteId = params.get('id');
    console.log('URL:', window.location.href);
    console.log('Parsed quoteId:', quoteId);
    
    async function init() {
      console.log('Quote Builder starting init...');
      
      // Always set up event listeners first, even before data loads
      setupEventListeners();
      console.log('Event listeners set up');
      
      try {
        const supabase = await app.waitForSupabase();
        console.log('Supabase ready');
        
        console.log('Quote Builder init, quoteId:', quoteId);
        
        // Load customers
        try {
          const { data: customerData, error: custError } = await supabase
            .from('customers')
            .select('id, name, email')
            .order('name');
          
          if (custError) {
            console.error('Customer load error:', custError);
          } else {
            customers = customerData || [];
            console.log('Loaded', customers.length, 'customers');
            
            const customerSelect = $('#customer-select');
            customers.forEach(c => {
              const option = document.createElement('option');
              option.value = c.id;
              option.textContent = `${c.name} (${c.email})`;
              customerSelect.appendChild(option);
            });
          }
        } catch (custErr) {
          console.error('Customer fetch exception:', custErr);
        }
        
        // Load catalog items
        try {
          const { data: catalogData, error: catError } = await supabase
            .from('items_catalog')
            .select('*')
            .eq('is_active', true)
            .order('category, name');
          
          if (catError) {
            console.error('Catalog load error:', catError);
          } else {
            catalogItems = catalogData || [];
            console.log('Loaded', catalogItems.length, 'catalog items');
          }
        } catch (catErr) {
          console.error('Catalog fetch exception:', catErr);
        }
        
        // Load pricing attributes with their options (gracefully handle if tables don't exist)
        try {
          const { data: attrsData } = await supabase
            .from('pricing_attributes')
            .select('*, options:pricing_attribute_options(*)')
            .eq('is_active', true)
            .order('sort_order, name');
          pricingAttributes = attrsData || [];
          
          // Load catalog item -> attribute mappings
          const { data: mappingsData } = await supabase
            .from('catalog_item_attributes')
            .select('item_id, attribute_id, sort_order')
            .order('sort_order');
          
          // Build catalogItemAttributes map
          catalogItemAttributes = {};
          (mappingsData || []).forEach(m => {
            if (!catalogItemAttributes[m.item_id]) {
              catalogItemAttributes[m.item_id] = [];
            }
            const attr = pricingAttributes.find(a => a.id === m.attribute_id);
            if (attr) {
              catalogItemAttributes[m.item_id].push(attr);
            }
          });
        } catch (attrErr) {
          console.log('Pricing attributes not available (migration may not be run yet):', attrErr.message);
          pricingAttributes = [];
          catalogItemAttributes = {};
        }
        
        
        // If editing, load quote
        if (quoteId) {
          console.log('Loading existing quote:', quoteId);
          await loadQuote(supabase);
        }
        
        updateSummary();
        console.log('Quote Builder init complete');
      } catch (err) {
        console.error('Init error:', err);
        showToast('Failed to initialize: ' + err.message, 'error');
      }
    }
    
    // Helper to reverse-calculate base price from unit price and attribute selections
    function calculateBasePrice(item) {
      if (!item.attribute_selections || item.attribute_selections.length === 0) {
        return item.unit_price;
      }
      
      // Reverse the calculation: final = (base + flat_adjustments) * multipliers
      // So: base = final / multipliers - flat_adjustments
      let totalMultiplier = 1;
      let totalFlat = 0;
      
      item.attribute_selections.forEach(sel => {
        totalFlat += sel.flat_adjustment || 0;
        totalMultiplier *= sel.multiplier || 1;
      });
      
      if (totalMultiplier === 0) return item.unit_price;
      
      return Math.round(((item.unit_price / totalMultiplier) - totalFlat) * 100) / 100;
    }
    
    async function loadQuote(supabase) {
      try {
        // First load the quote with line items and attachments
        const { data: quote, error: quoteError } = await supabase
          .from('quotes')
          .select('*, quote_line_items(*), quote_attachments(*)')
          .eq('id', quoteId)
          .single();
        
        if (quoteError) {
          console.error('Quote load error:', quoteError);
          showToast('Failed to load quote: ' + quoteError.message, 'error');
          return;
        }
        
        if (!quote) {
          showToast('Quote not found', 'error');
          return;
        }
        
        console.log('Loaded quote:', quote);
        
        $('#page-title').textContent = `Edit Quote: ${quote.quote_number}`;
        $('#customer-select').value = quote.customer_id;
        $('#quote-title').value = quote.title;
        $('#quote-description').value = quote.description || '';
        $('#valid-days').value = quote.valid_days;
        $('#deposit-type').value = quote.deposit_type;
        $('#deposit-value').value = quote.deposit_value;
        $('#video-url').value = quote.video_url || '';
        $('#customer-notes').value = quote.notes || '';
        $('#internal-notes').value = quote.internal_notes || '';
        
        lineItems = (quote.quote_line_items || []).map(item => ({
          id: item.id,
          catalogItemId: item.catalog_item_id,
          description: item.description,
          details: item.details,
          quantity: item.quantity,
          unitPrice: item.unit_price,
          priceRangeLow: item.price_range_low,
          priceRangeHigh: item.price_range_high,
          isRangePricing: item.is_range_pricing,
          photoUrl: item.photo_url,
          isOptional: item.is_optional,
          isTaxable: item.is_taxable,
          sortOrder: item.sort_order,
          attributeSelections: item.attribute_selections || [],
          basePrice: item.attribute_selections?.length > 0 ? calculateBasePrice(item) : null
        }));
        
        attachments = quote.quote_attachments || [];
        
        // Load packages separately (in case table doesn't exist)
        packagesEnabled = quote.packages_enabled || false;
        $('#packages-enabled').checked = packagesEnabled;
        
        try {
          const { data: pkgData } = await supabase
            .from('quote_packages')
            .select('*, quote_package_items(*)')
            .eq('quote_id', quoteId)
            .order('sort_order');
          
          packages = (pkgData || []).map(pkg => ({
            id: pkg.id,
            name: pkg.name,
            description: pkg.description,
            price: pkg.price,
            is_recommended: pkg.is_recommended,
            is_selected: pkg.is_selected || pkg.id === quote.selected_package_id,
            apply_tax: pkg.apply_tax,
            tax_rate: pkg.tax_rate,
            hide_non_included: pkg.hide_non_included,
            items: (pkg.quote_package_items || []).map(item => ({
              id: item.id,
              name: item.name,
              description: item.description,
              quantity: item.quantity,
              price: item.price,
              is_included: item.is_included,
              show_price: item.show_price
            }))
          }));
        } catch (pkgErr) {
          console.log('Packages table may not exist:', pkgErr);
          packages = [];
        }
        
        renderLineItems();
        renderAttachments();
        updatePackagesUI();
        updateSummary();
        
      } catch (err) {
        console.error('Load quote error:', err);
        showToast('Failed to load quote', 'error');
      }
    }
    
    function setupEventListeners() {
      // Deposit type change
      $('#deposit-type').addEventListener('change', (e) => {
        $('#deposit-suffix').textContent = e.target.value === 'percentage' ? '%' : '$';
        updateSummary();
      });
      
      // Deposit value change
      $('#deposit-value').addEventListener('input', updateSummary);
      
      // Add from catalog
      $('#add-from-catalog-btn').addEventListener('click', showCatalogModal);
      
      // Add custom item
      $('#add-custom-btn').addEventListener('click', () => addLineItem());
      
      // Attachments
      const attachZone = $('#attachments-zone');
      const attachInput = $('#attachments-input');
      
      attachZone.addEventListener('click', () => attachInput.click());
      attachZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        attachZone.classList.add('dragover');
      });
      attachZone.addEventListener('dragleave', () => attachZone.classList.remove('dragover'));
      attachZone.addEventListener('drop', (e) => {
        e.preventDefault();
        attachZone.classList.remove('dragover');
        handleAttachmentFiles(e.dataTransfer.files);
      });
      attachInput.addEventListener('change', (e) => {
        handleAttachmentFiles(e.target.files);
        attachInput.value = '';
      });
      
      // Save buttons
      $('#save-draft-btn').addEventListener('click', () => saveQuote('draft'));
      $('#send-quote-btn').addEventListener('click', () => saveQuote('sent'));
      
      // New customer button
      $('#new-customer-btn').addEventListener('click', showNewCustomerModal);
    }
    
    function showCatalogModal() {
      const content = createElement('div');
      
      // Group by category
      const byCategory = {};
      catalogItems.forEach(item => {
        const cat = item.category || 'Uncategorized';
        if (!byCategory[cat]) byCategory[cat] = [];
        byCategory[cat].push(item);
      });
      
      Object.entries(byCategory).forEach(([category, items]) => {
        content.appendChild(createElement('h4', { 
          className: 'mb-md mt-lg',
          textContent: category
        }));
        
        const grid = createElement('div', { className: 'catalog-modal-grid' });
        items.forEach(item => {
          const card = createElement('div', {
            className: 'catalog-item-card',
            dataset: { id: item.id },
            onClick: () => {
              card.classList.toggle('selected');
            }
          });
          
          if (item.photo_url) {
            card.appendChild(createElement('img', {
              src: item.photo_url,
              style: 'width: 100%; height: 80px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;'
            }));
          }
          
          card.appendChild(createElement('div', { className: 'font-bold', textContent: item.name }));
          card.appendChild(createElement('div', { 
            className: 'text-sm text-muted',
            textContent: formatCurrency(item.default_price || 0)
          }));
          
          grid.appendChild(card);
        });
        content.appendChild(grid);
      });
      
      const footer = createElement('div', { className: 'btn-group' }, [
        createElement('button', {
          className: 'btn btn-secondary',
          textContent: 'Cancel',
          onClick: () => closeModal(modal)
        }),
        createElement('button', {
          className: 'btn btn-primary',
          textContent: 'Add Selected',
          onClick: () => {
            const selected = $$('.catalog-item-card.selected', modal);
            selected.forEach(card => {
              const item = catalogItems.find(i => i.id === card.dataset.id);
              if (item) addLineItem(item);
            });
            closeModal(modal);
          }
        })
      ]);
      
      const modal = createModal({
        title: 'Add from Catalog',
        content,
        footer,
        size: 'xl'
      });
    }
    
    function addLineItem(catalogItem = null) {
      // Check if catalog item has pricing attributes
      const itemAttrs = catalogItem ? (catalogItemAttributes[catalogItem.id] || []) : [];
      
      if (itemAttrs.length > 0) {
        // Show attribute configuration modal
        showAttributeConfigModal(catalogItem, itemAttrs);
      } else {
        // No attributes, add directly
        addLineItemDirect(catalogItem, []);
      }
    }
    
    function addLineItemDirect(catalogItem, attributeSelections) {
      // Calculate price based on base price + attribute adjustments
      let basePrice = catalogItem?.default_price || 0;
      let finalPrice = basePrice;
      
      // Apply attribute adjustments
      attributeSelections.forEach(sel => {
        finalPrice += sel.flat_adjustment || 0;
      });
      // Apply multipliers after all flat adjustments
      attributeSelections.forEach(sel => {
        if (sel.multiplier && sel.multiplier !== 1) {
          finalPrice *= sel.multiplier;
        }
      });
      
      const item = {
        id: 'new-' + Date.now(),
        catalogItemId: catalogItem?.id || null,
        description: catalogItem?.name || '',
        details: catalogItem?.description || '',
        quantity: 1,
        unitPrice: Math.round(finalPrice * 100) / 100,
        basePrice: basePrice,
        attributeSelections: attributeSelections,
        priceRangeLow: null,
        priceRangeHigh: null,
        isRangePricing: false,
        photoUrl: catalogItem?.photo_url || null,
        isOptional: false,
        isTaxable: catalogItem?.is_taxable !== false,
        sortOrder: lineItems.length
      };
      
      lineItems.push(item);
      renderLineItems();
      updateSummary();
    }
    
    function showAttributeConfigModal(catalogItem, itemAttrs) {
      const basePrice = catalogItem?.default_price || 0;
      
      const content = createElement('div');
      content.innerHTML = `
        <div class="mb-lg">
          <h4 style="margin: 0 0 var(--space-xs);">${catalogItem.name}</h4>
          <p class="text-muted text-sm" style="margin: 0;">Base price: ${formatCurrency(basePrice)}</p>
        </div>
        <div id="attr-selectors">
          ${itemAttrs.map((attr, idx) => {
            const defaultOpt = attr.options?.find(o => o.is_default);
            return `
              <div class="form-group">
                <label class="form-label">${attr.name}</label>
                <select class="form-select attr-select" data-attr-id="${attr.id}" data-attr-name="${attr.name}">
                  <option value="">-- Select ${attr.name} --</option>
                  ${(attr.options || []).sort((a,b) => a.sort_order - b.sort_order).map(opt => `
                    <option value="${opt.id}" 
                      data-flat="${opt.flat_adjustment || 0}"
                      data-mult="${opt.multiplier || 1}"
                      data-name="${opt.name}"
                      ${defaultOpt?.id === opt.id ? 'selected' : ''}>
                      ${opt.name}
                      ${opt.flat_adjustment ? (opt.flat_adjustment > 0 ? ` (+$${opt.flat_adjustment})` : ` (-$${Math.abs(opt.flat_adjustment)})`) : ''}
                      ${opt.multiplier && opt.multiplier !== 1 ? ` (×${opt.multiplier})` : ''}
                    </option>
                  `).join('')}
                </select>
              </div>
            `;
          }).join('')}
        </div>
        <div class="price-preview" style="padding: var(--space-md); background: var(--color-bg); border-radius: var(--radius-md); margin-top: var(--space-lg);">
          <div class="flex justify-between items-center">
            <span class="text-muted">Calculated Price:</span>
            <span id="preview-price" style="font-size: 1.5rem; font-weight: 600; color: var(--color-primary);">${formatCurrency(basePrice)}</span>
          </div>
        </div>
      `;
      
      // Update price preview when selections change
      const updatePreview = () => {
        const selects = content.querySelectorAll('.attr-select');
        let price = basePrice;
        
        // Apply flat adjustments first
        selects.forEach(sel => {
          const opt = sel.selectedOptions[0];
          if (opt && opt.value) {
            price += parseFloat(opt.dataset.flat) || 0;
          }
        });
        
        // Then apply multipliers
        selects.forEach(sel => {
          const opt = sel.selectedOptions[0];
          if (opt && opt.value) {
            const mult = parseFloat(opt.dataset.mult) || 1;
            if (mult !== 1) price *= mult;
          }
        });
        
        content.querySelector('#preview-price').textContent = formatCurrency(price);
      };
      
      content.querySelectorAll('.attr-select').forEach(sel => {
        sel.addEventListener('change', updatePreview);
      });
      
      // Initial preview with defaults
      setTimeout(updatePreview, 0);
      
      createModal({
        title: 'Configure Item Options',
        content,
        footer: `
          <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
          <button class="btn btn-primary" id="add-configured-item">Add to Quote</button>
        `,
        size: 'md'
      });
      
      document.getElementById('add-configured-item').addEventListener('click', () => {
        // Gather selections
        const selects = content.querySelectorAll('.attr-select');
        const selections = [];
        
        selects.forEach(sel => {
          const opt = sel.selectedOptions[0];
          if (opt && opt.value) {
            selections.push({
              attribute_id: sel.dataset.attrId,
              attribute_name: sel.dataset.attrName,
              option_id: opt.value,
              option_name: opt.dataset.name,
              flat_adjustment: parseFloat(opt.dataset.flat) || 0,
              multiplier: parseFloat(opt.dataset.mult) || 1
            });
          }
        });
        
        closeModal();
        addLineItemDirect(catalogItem, selections);
      });
    }
    
    function renderLineItems() {
      const container = $('#line-items-container');
      const emptyState = $('#empty-items');
      
      clearElement(container);
      
      if (lineItems.length === 0) {
        emptyState.style.display = 'block';
        return;
      }
      
      emptyState.style.display = 'none';
      
      lineItems.forEach((item, index) => {
        const row = createElement('div', {
          className: `line-item-row ${item.isOptional ? 'optional' : ''}`,
          dataset: { index }
        });
        
        // Photo
        const photoCell = createElement('div', { className: 'line-item-photo-upload' });
        if (item.photoUrl) {
          photoCell.appendChild(createElement('img', { src: item.photoUrl }));
        } else {
          photoCell.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>';
        }
        row.appendChild(photoCell);
        
        // Description
        const descCell = createElement('div');
        descCell.appendChild(createElement('input', {
          type: 'text',
          className: 'form-input mb-sm',
          value: item.description,
          placeholder: 'Item description',
          onInput: (e) => {
            lineItems[index].description = e.target.value;
          }
        }));
        descCell.appendChild(createElement('input', {
          type: 'text',
          className: 'form-input',
          value: item.details || '',
          placeholder: 'Details (optional)',
          style: 'font-size: 0.875rem;',
          onInput: (e) => {
            lineItems[index].details = e.target.value;
          }
        }));
        
        // Show attribute selections if present (admin view only)
        if (item.attributeSelections && item.attributeSelections.length > 0) {
          const attrDisplay = createElement('div', {
            style: 'margin-top: 6px; font-size: 0.75rem; color: var(--color-primary);'
          });
          const attrText = item.attributeSelections.map(sel => 
            `${sel.attribute_name}: ${sel.option_name}`
          ).join(' • ');
          attrDisplay.innerHTML = `⚙ ${attrText}`;
          if (item.basePrice) {
            attrDisplay.innerHTML += ` <span style="color: var(--color-text-muted);">(base: ${formatCurrency(item.basePrice)})</span>`;
          }
          descCell.appendChild(attrDisplay);
        }
        
        row.appendChild(descCell);
        
        // Quantity
        const qtyCell = createElement('div');
        qtyCell.appendChild(createElement('label', { className: 'form-label', textContent: 'Qty' }));
        qtyCell.appendChild(createElement('input', {
          type: 'number',
          className: 'form-input',
          value: item.quantity,
          min: 1,
          onInput: (e) => {
            lineItems[index].quantity = parseFloat(e.target.value) || 1;
            updateSummary();
          }
        }));
        row.appendChild(qtyCell);
        
        // Price
        const priceCell = createElement('div');
        priceCell.appendChild(createElement('label', { className: 'form-label', textContent: 'Price' }));
        priceCell.appendChild(createElement('input', {
          type: 'number',
          className: 'form-input',
          value: item.unitPrice,
          step: '0.01',
          onInput: (e) => {
            lineItems[index].unitPrice = parseFloat(e.target.value) || 0;
            updateSummary();
          }
        }));
        row.appendChild(priceCell);
        
        // Options
        const optionsCell = createElement('div');
        const optCheckbox = createElement('input', {
          type: 'checkbox',
          className: 'form-check-input',
          checked: item.isOptional
        });
        const itemId = item.id; // Capture item id in closure
        optCheckbox.addEventListener('change', (e) => {
          const targetItem = lineItems.find(i => i.id === itemId);
          if (targetItem) {
            targetItem.isOptional = e.target.checked;
            console.log('Set isOptional to', e.target.checked, 'for item', itemId);
          }
          row.classList.toggle('optional', e.target.checked);
          updateSummary();
        });
        const optLabel = createElement('label', { className: 'form-check' });
        optLabel.appendChild(optCheckbox);
        optLabel.appendChild(createElement('span', { className: 'form-check-label text-sm', textContent: 'Optional' }));
        optionsCell.appendChild(optLabel);
        row.appendChild(optionsCell);
        
        // Delete
        const deleteCell = createElement('div');
        deleteCell.appendChild(createElement('button', {
          className: 'btn btn-ghost btn-sm',
          innerHTML: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>',
          onClick: async () => {
            if (await confirm('Remove this item?', { danger: true })) {
              lineItems.splice(index, 1);
              renderLineItems();
              updateSummary();
            }
          }
        }));
        row.appendChild(deleteCell);
        
        container.appendChild(row);
      });
    }
    
    function updateSummary() {
      const summaryItems = $('#summary-items');
      const summaryTotals = $('#summary-totals');
      
      if (lineItems.length === 0) {
        summaryItems.innerHTML = '<p class="text-muted text-center">Add items to see summary</p>';
        summaryTotals.style.display = 'none';
        return;
      }
      
      // Calculate totals - separate taxable and non-taxable
      let subtotal = 0;
      let taxableSubtotal = 0;
      
      lineItems.forEach(item => {
        if (!item.isOptional) {
          const qty = item.quantity || 1;
          const lineTotal = (item.unitPrice || 0) * qty;
          subtotal += lineTotal;
          if (item.isTaxable) {
            taxableSubtotal += lineTotal;
          }
        }
      });
      
      // Only tax the taxable portion
      const tax = taxableSubtotal * TAX_RATE;
      const total = subtotal + tax;
      
      // Deposit
      const depositType = $('#deposit-type').value;
      const depositValue = parseFloat($('#deposit-value').value) || 0;
      let deposit;
      if (depositType === 'percentage') {
        deposit = total * (depositValue / 100);
      } else {
        deposit = depositValue;
      }
      
      // Update display
      $('#summary-subtotal').textContent = formatCurrency(subtotal);
      $('#summary-tax').textContent = formatCurrency(tax);
      $('#summary-total').textContent = formatCurrency(total);
      
      $('#summary-tax-rate').textContent = (TAX_RATE * 100).toFixed(2);
      $('#summary-deposit').textContent = formatCurrency(deposit);
      $('#summary-balance').textContent = formatCurrency(total - deposit);
      
      summaryItems.innerHTML = '';
      summaryTotals.style.display = 'block';
    }
    
    function handleAttachmentFiles(fileList) {
      Array.from(fileList).forEach(file => {
        if (file.size > 10 * 1024 * 1024) {
          showToast(`${file.name} is too large (max 10MB)`, 'error');
          return;
        }
        
        // For now, just show locally - actual upload happens on save
        const url = URL.createObjectURL(file);
        attachments.push({
          id: 'new-' + Date.now(),
          file_name: file.name,
          file_type: file.type,
          file_url: url,
          file: file
        });
      });
      
      renderAttachments();
    }
    
    function renderAttachments() {
      const container = $('#attachments-list');
      clearElement(container);
      
      attachments.forEach((att, index) => {
        const card = createElement('div', { className: 'file-card' });
        
        const preview = createElement('div', { className: 'file-card-preview' });
        if (att.file_type?.includes('image')) {
          preview.appendChild(createElement('img', { src: att.file_url }));
        } else {
          preview.innerHTML = '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/></svg>';
        }
        card.appendChild(preview);
        
        const info = createElement('div', { className: 'file-card-info' });
        info.appendChild(createElement('div', { className: 'file-card-name', textContent: att.file_name }));
        info.appendChild(createElement('button', {
          className: 'btn btn-ghost btn-sm',
          textContent: 'Remove',
          onClick: () => {
            attachments.splice(index, 1);
            renderAttachments();
          }
        }));
        card.appendChild(info);
        
        container.appendChild(card);
      });
    }
    
    function showNewCustomerModal() {
      const content = createElement('form', { id: 'new-customer-form' });
      content.innerHTML = `
        <div class="form-group">
          <label class="form-label">Name *</label>
          <input type="text" name="name" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Email *</label>
          <input type="email" name="email" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="tel" name="phone" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Address</label>
          <textarea name="address" class="form-textarea" rows="2"></textarea>
        </div>
      `;
      
      const footer = createElement('div', { className: 'btn-group' });
      const cancelBtn = createElement('button', {
        type: 'button',
        className: 'btn btn-secondary',
        textContent: 'Cancel'
      });
      const submitBtn = createElement('button', {
        type: 'button',
        className: 'btn btn-primary',
        textContent: 'Add Customer'
      });
      footer.appendChild(cancelBtn);
      footer.appendChild(submitBtn);
      
      const modal = createModal({
        title: 'Add New Customer',
        content,
        footer
      });
      
      // Add event listeners AFTER modal is created
      cancelBtn.addEventListener('click', () => closeModal(modal));
      submitBtn.addEventListener('click', async () => {
        if (!content.checkValidity()) {
          content.reportValidity();
          return;
        }
        const formData = new FormData(content);
        
        try {
          const supabase = await app.waitForSupabase();
          const { data: customer, error } = await supabase
            .from('customers')
            .insert({
              name: formData.get('name'),
              email: formData.get('email').toLowerCase(),
              phone: formData.get('phone'),
              address: formData.get('address')
            })
            .select()
            .single();
          
          if (error) throw error;
          
          // Add to dropdown and select
          customers.push(customer);
          const option = document.createElement('option');
          option.value = customer.id;
          option.textContent = `${customer.name} (${customer.email})`;
          $('#customer-select').appendChild(option);
          $('#customer-select').value = customer.id;
          
          closeModal(modal);
          showToast('Customer added', 'success');
        } catch (err) {
          showToast('Failed to add customer: ' + err.message, 'error');
        }
      });
    }
    
    async function saveQuote(status) {
      const customerId = $('#customer-select').value;
      const title = $('#quote-title').value.trim();
      
      if (!customerId) {
        showToast('Please select a customer', 'error');
        return;
      }
      
      if (!title) {
        showToast('Please enter a project title', 'error');
        return;
      }
      
      // Must have either line items OR packages
      if (lineItems.length === 0 && packages.length === 0) {
        showToast('Please add line items or bundles', 'error');
        return;
      }
      
      // If packages enabled, must have at least one package
      if (packagesEnabled && packages.length === 0) {
        showToast('Please add at least one bundle', 'error');
        return;
      }
      
      const btn = status === 'draft' ? $('#save-draft-btn') : $('#send-quote-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';
      
      try {
        const supabase = await app.waitForSupabase();
        
        // Calculate totals - separate taxable and non-taxable
        let subtotal = 0;
        let taxableSubtotal = 0;
        
        lineItems.forEach(item => {
          if (!item.isOptional) {
            const qty = item.quantity || 1;
            const lineTotal = (item.unitPrice || 0) * qty;
            subtotal += lineTotal;
            if (item.isTaxable) {
              taxableSubtotal += lineTotal;
            }
          }
        });
        
        // Only tax the taxable portion
        const taxAmount = taxableSubtotal * TAX_RATE;
        
        const validDays = parseInt($('#valid-days').value) || 30;
        const expiresAt = new Date(Date.now() + validDays * 24 * 60 * 60 * 1000);
        
        const quoteData = {
          customer_id: customerId,
          title,
          description: $('#quote-description').value.trim() || null,
          quote_type: 'final',
          status,
          valid_days: validDays,
          expires_at: expiresAt.toISOString(),
          deposit_type: $('#deposit-type').value,
          deposit_value: parseFloat($('#deposit-value').value) || 50,
          video_url: $('#video-url').value.trim() || null,
          notes: $('#customer-notes').value.trim() || null,
          internal_notes: $('#internal-notes').value.trim() || null,
          tax_rate: TAX_RATE,
          subtotal,
          subtotal_low: subtotal,
          subtotal_high: subtotal,
          tax_amount: taxAmount,
          total: subtotal + taxAmount,
          total_low: subtotal + taxAmount,
          total_high: subtotal + taxAmount,
          packages_enabled: packagesEnabled
        };
        
        if (status === 'sent') {
          quoteData.sent_at = new Date().toISOString();
        }
        
        let savedQuote;
        if (quoteId) {
          // Update existing
          const { data, error } = await supabase
            .from('quotes')
            .update(quoteData)
            .eq('id', quoteId)
            .select()
            .single();
          if (error) throw error;
          savedQuote = data;
        } else {
          // Generate quote number and insert
          const { data: numData } = await supabase.rpc('generate_quote_number');
          quoteData.quote_number = numData;
          
          const { data, error } = await supabase
            .from('quotes')
            .insert(quoteData)
            .select()
            .single();
          if (error) throw error;
          savedQuote = data;
          quoteId = savedQuote.id;
        }
        
        // Delete existing line items and re-insert
        await supabase.from('quote_line_items').delete().eq('quote_id', quoteId);
        
        const lineItemsToInsert = lineItems.map((item, index) => {
          console.log('Saving item:', item.description, 'isOptional:', item.isOptional);
          const lineTotal = (item.unitPrice || 0) * (item.quantity || 1);
          return {
            quote_id: quoteId,
            catalog_item_id: item.catalogItemId,
            description: item.description,
            details: item.details,
            quantity: item.quantity,
            unit_price: item.unitPrice,
            price_range_low: null,
            price_range_high: null,
            is_range_pricing: false,
            line_total: lineTotal,
            line_total_low: lineTotal,
            line_total_high: lineTotal,
            photo_url: item.photoUrl,
            is_optional: item.isOptional,
            is_taxable: item.isTaxable,
            sort_order: index,
            attribute_selections: item.attributeSelections || []
          };
        });
        
        await supabase.from('quote_line_items').insert(lineItemsToInsert);
        
        // Save packages
        await supabase.from('quote_package_items').delete().match({ package_id: packages.filter(p => p.id).map(p => p.id) });
        await supabase.from('quote_packages').delete().eq('quote_id', quoteId);
        
        let selectedPackageId = null;
        
        for (let i = 0; i < packages.length; i++) {
          const pkg = packages[i];
          const { data: savedPkg, error: pkgError } = await supabase
            .from('quote_packages')
            .insert({
              quote_id: quoteId,
              name: pkg.name,
              description: pkg.description,
              price: pkg.price,
              is_recommended: pkg.is_recommended,
              is_selected: pkg.is_selected,
              apply_tax: pkg.apply_tax,
              tax_rate: pkg.tax_rate,
              hide_non_included: pkg.hide_non_included,
              sort_order: i
            })
            .select()
            .single();
          
          if (pkgError) throw pkgError;
          
          if (pkg.is_selected) {
            selectedPackageId = savedPkg.id;
          }
          
          // Save package items
          if (pkg.items && pkg.items.length > 0) {
            const pkgItemsToInsert = pkg.items.map((item, idx) => ({
              package_id: savedPkg.id,
              name: item.name,
              description: item.description,
              quantity: item.quantity,
              price: item.price,
              is_included: item.is_included,
              show_price: item.show_price !== false,
              sort_order: idx
            }));
            
            await supabase.from('quote_package_items').insert(pkgItemsToInsert);
          }
        }
        
        // Update selected package ID
        if (selectedPackageId) {
          await supabase.from('quotes').update({ selected_package_id: selectedPackageId }).eq('id', quoteId);
        }
        
        // TODO: Handle attachment uploads to Supabase Storage
        
        // Send email if status is 'sent'
        if (status === 'sent') {
          try {
            const emailResponse = await fetch('/.netlify/functions/send-quote-email', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ quoteId: savedQuote.id })
            });
            
            if (!emailResponse.ok) {
              const emailError = await emailResponse.json();
              console.error('Email error:', emailError);
              showToast('Quote saved but email failed to send', 'error');
            } else {
              showToast('Quote sent to customer!', 'success');
            }
          } catch (emailErr) {
            console.error('Email error:', emailErr);
            showToast('Quote saved but email failed to send', 'error');
          }
        } else {
          showToast('Quote saved as draft', 'success');
        }
        
        // Redirect to quote view
        setTimeout(() => {
          window.location.href = `/admin/quotes.html`;
        }, 1000);
        
      } catch (err) {
        console.error('Save error:', err);
        showToast('Failed to save: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = status === 'draft' ? 'Save Draft' : 'Send to Customer';
      }
    }
    
    // Initialize
    init();
    
    // ==========================================
    // PACKAGES FUNCTIONALITY
    // ==========================================
    
    let packages = [];
    let packagesEnabled = false;
    
    function togglePackagesEnabled() {
      packagesEnabled = $('#packages-enabled').checked;
      updatePackagesUI();
    }
    
    function updatePackagesUI() {
      const emptyNotice = $('#empty-packages');
      const disabledNotice = $('#packages-disabled-notice');
      const container = $('#packages-container');
      
      if (packages.length === 0) {
        emptyNotice.style.display = 'block';
        disabledNotice.style.display = 'none';
      } else {
        emptyNotice.style.display = 'none';
        disabledNotice.style.display = packagesEnabled ? 'none' : 'block';
      }
      
      renderPackages();
    }
    
    function renderPackages() {
      const container = $('#packages-container');
      
      if (packages.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = packages.map((pkg, index) => {
        const total = pkg.price || pkg.items.filter(i => i.is_included).reduce((sum, item) => sum + (item.quantity * item.price), 0);
        
        return `
          <div class="package-card ${pkg.is_recommended ? 'recommended' : ''} ${pkg.is_selected ? 'selected' : ''}" data-package-index="${index}">
            <div class="package-header">
              <div class="package-drag-handle">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="8" y1="6" x2="8" y2="6.01"/><line x1="8" y1="12" x2="8" y2="12.01"/><line x1="8" y1="18" x2="8" y2="18.01"/>
                  <line x1="16" y1="6" x2="16" y2="6.01"/><line x1="16" y1="12" x2="16" y2="12.01"/><line x1="16" y1="18" x2="16" y2="18.01"/>
                </svg>
              </div>
              <div class="package-info">
                <div class="package-title">
                  ${pkg.name}
                  ${pkg.is_recommended ? '<span class="badge-recommended">Recommended</span>' : ''}
                  ${pkg.is_selected ? '<span class="badge-selected">Selected</span>' : ''}
                </div>
                ${pkg.description ? `<div class="package-description">${pkg.description}</div>` : ''}
              </div>
              <div class="package-price">${formatCurrency(total)}</div>
              <div class="package-actions">
                <button class="btn btn-ghost btn-sm" onclick="togglePackageMenu(${index})">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
                  </svg>
                </button>
                <div class="package-menu" id="package-menu-${index}">
                  <button class="package-menu-item" onclick="editPackage(${index})">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Edit Bundle
                  </button>
                  <button class="package-menu-item" onclick="duplicatePackage(${index})">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                    Duplicate Bundle
                  </button>
                  <div class="package-menu-divider"></div>
                  <button class="package-menu-item" onclick="toggleRecommended(${index})">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                    ${pkg.is_recommended ? 'Remove Recommended' : 'Mark as Recommended'}
                  </button>
                  <button class="package-menu-item" onclick="toggleSelected(${index})">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                    ${pkg.is_selected ? 'Deselect Bundle' : 'Select Bundle'}
                  </button>
                  <div class="package-menu-divider"></div>
                  <button class="package-menu-item danger" onclick="deletePackage(${index})">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                    Delete Bundle
                  </button>
                </div>
              </div>
            </div>
            <div class="package-items">
              <div class="package-items-header">
                <div></div>
                <div>Product / Service</div>
                <div>Qty</div>
                <div style="text-align: right;">Price</div>
                <div></div>
              </div>
              ${pkg.items.map((item, itemIndex) => `
                <div class="package-item-row ${!item.is_included ? 'excluded' : ''}" data-item-index="${itemIndex}">
                  <div class="package-item-drag">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="8" y1="6" x2="8" y2="6.01"/><line x1="8" y1="12" x2="8" y2="12.01"/><line x1="8" y1="18" x2="8" y2="18.01"/>
                      <line x1="16" y1="6" x2="16" y2="6.01"/><line x1="16" y1="12" x2="16" y2="12.01"/><line x1="16" y1="18" x2="16" y2="18.01"/>
                    </svg>
                  </div>
                  <div class="package-item-name">${item.name}</div>
                  <div>${item.quantity}</div>
                  <div style="text-align: right;">${item.is_included ? formatCurrency(item.price) : ''}</div>
                  <div>
                    <button class="btn btn-ghost btn-xs" onclick="editPackageItem(${index}, ${itemIndex})" title="Edit">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </button>
                  </div>
                </div>
              `).join('')}
              <div class="package-total-row">
                <div></div>
                <div>Bundle Total</div>
                <div></div>
                <div style="text-align: right;">${formatCurrency(total)}</div>
                <div></div>
              </div>
            </div>
            <div class="package-add-item">
              <button class="btn btn-outline btn-sm" onclick="addPackageItem(${index})">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                Add Item
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function togglePackageMenu(index) {
      // Close all other menus
      $$('.package-menu').forEach(m => m.classList.remove('show'));
      const menu = $(`#package-menu-${index}`);
      menu.classList.toggle('show');
      
      // Close on outside click
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!e.target.closest('.package-actions')) {
            menu.classList.remove('show');
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 0);
    }
    
    function addPackage() {
      showPackageModal();
    }
    
    function editPackage(index) {
      showPackageModal(packages[index], index);
    }
    
    function showPackageModal(pkg = null, index = null) {
      const isEdit = pkg !== null;
      
      const content = createElement('div');
      content.innerHTML = `
        <div class="form-group">
          <label class="form-label">Bundle Name *</label>
          <input type="text" id="pkg-name" class="form-input" value="${pkg?.name || ''}" placeholder="e.g., Basic, Standard, Premium">
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea id="pkg-description" class="form-textarea" rows="3" placeholder="Describe what's included in this package...">${pkg?.description || ''}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Package Price <span class="form-label-optional">(optional override)</span></label>
          <div class="input-group">
            <span class="input-group-prepend">$</span>
            <input type="number" id="pkg-price" class="form-input" value="${pkg?.price || ''}" placeholder="Leave blank to calculate from items" step="0.01">
          </div>
          <div class="form-help">Set a manual price or leave empty to auto-calculate from line items</div>
        </div>
        <div class="form-group">
          <label class="form-label">Tax Settings</label>
          <div class="toggle-row">
            <div>
              <div class="toggle-label">Apply Tax</div>
              <div class="toggle-description">Calculate tax on this package</div>
            </div>
            <div style="display: flex; align-items: center; gap: var(--space-sm);">
              <label class="toggle">
                <input type="checkbox" id="pkg-apply-tax" ${pkg?.apply_tax ? 'checked' : ''}>
                <span class="toggle-slider"></span>
              </label>
              <input type="number" id="pkg-tax-rate" class="form-input" style="width: 80px;" value="${pkg?.tax_rate || 0}" step="0.001" placeholder="0">
              <span>%</span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Display Settings</label>
          <div class="toggle-row">
            <div>
              <div class="toggle-label">Hide Non-Included Items</div>
              <div class="toggle-description">Hides excluded items from customer view</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="pkg-hide-excluded" ${pkg?.hide_non_included ? 'checked' : ''}>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
      `;
      
      const footer = createElement('div', { className: 'flex justify-end gap-md' });
      const cancelBtn = createElement('button', { className: 'btn btn-secondary', textContent: 'Cancel' });
      const saveBtn = createElement('button', { className: 'btn btn-primary', textContent: isEdit ? 'Save Changes' : 'Create Package' });
      footer.appendChild(cancelBtn);
      footer.appendChild(saveBtn);
      
      const modal = createModal({
        title: isEdit ? 'Edit Bundle' : 'Create Bundle',
        content,
        footer,
        size: 'md'
      });
      
      cancelBtn.onclick = () => closeModal(modal);
      saveBtn.onclick = () => {
        const name = $('#pkg-name').value.trim();
        if (!name) {
          showToast('Package name is required', 'error');
          return;
        }
        
        const newPkg = {
          name,
          description: $('#pkg-description').value.trim(),
          price: $('#pkg-price').value ? parseFloat($('#pkg-price').value) : null,
          apply_tax: $('#pkg-apply-tax').checked,
          tax_rate: parseFloat($('#pkg-tax-rate').value) || 0,
          hide_non_included: $('#pkg-hide-excluded').checked,
          is_recommended: pkg?.is_recommended || false,
          is_selected: pkg?.is_selected || false,
          items: pkg?.items || []
        };
        
        if (isEdit) {
          packages[index] = newPkg;
        } else {
          packages.push(newPkg);
        }
        
        updatePackagesUI();
        closeModal(modal);
        showToast(isEdit ? 'Package updated' : 'Package created', 'success');
      };
    }
    
    function duplicatePackage(index) {
      const pkg = packages[index];
      const newPkg = {
        ...JSON.parse(JSON.stringify(pkg)),
        name: pkg.name + ' (Copy)',
        is_recommended: false,
        is_selected: false
      };
      packages.push(newPkg);
      updatePackagesUI();
      showToast('Package duplicated', 'success');
    }
    
    function toggleRecommended(index) {
      // Only one can be recommended
      packages.forEach((p, i) => {
        p.is_recommended = i === index ? !p.is_recommended : false;
      });
      updatePackagesUI();
    }
    
    function toggleSelected(index) {
      // Only one can be selected
      packages.forEach((p, i) => {
        p.is_selected = i === index ? !p.is_selected : false;
      });
      updatePackagesUI();
    }
    
    function deletePackage(index) {
      if (!confirm('Delete this bundle?')) return;
      packages.splice(index, 1);
      updatePackagesUI();
      showToast('Package deleted', 'success');
    }
    
    function addPackageItem(packageIndex) {
      showPackageCatalogModal(packageIndex);
    }
    
    function showPackageCatalogModal(packageIndex) {
      const content = createElement('div');
      
      // Group by category
      const byCategory = {};
      catalogItems.forEach(item => {
        const cat = item.category || 'Uncategorized';
        if (!byCategory[cat]) byCategory[cat] = [];
        byCategory[cat].push(item);
      });
      
      Object.entries(byCategory).forEach(([category, items]) => {
        content.appendChild(createElement('h4', { 
          className: 'mb-md mt-lg',
          textContent: category
        }));
        
        const grid = createElement('div', { className: 'catalog-modal-grid' });
        items.forEach(item => {
          const card = createElement('div', {
            className: 'catalog-item-card',
            dataset: { id: item.id },
            onClick: () => {
              card.classList.toggle('selected');
            }
          });
          
          if (item.photo_url) {
            card.appendChild(createElement('img', {
              src: item.photo_url,
              style: 'width: 100%; height: 80px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;'
            }));
          }
          
          card.appendChild(createElement('div', { className: 'font-bold', textContent: item.name }));
          card.appendChild(createElement('div', { 
            className: 'text-sm text-muted',
            textContent: formatCurrency(item.default_price || 0)
          }));
          
          grid.appendChild(card);
        });
        content.appendChild(grid);
      });
      
      // Add custom item option
      content.appendChild(createElement('div', {
        className: 'mt-lg pt-lg',
        style: 'border-top: 1px solid var(--color-border);',
        innerHTML: '<button class="btn btn-link" id="add-custom-pkg-item">+ Add Custom Item</button>'
      }));
      
      const footer = createElement('div', { className: 'btn-group' }, [
        createElement('button', {
          className: 'btn btn-secondary',
          textContent: 'Cancel',
          onClick: () => closeModal(modal)
        }),
        createElement('button', {
          className: 'btn btn-primary',
          textContent: 'Add Selected',
          onClick: () => {
            const selected = $$('.catalog-item-card.selected', modal);
            selected.forEach(card => {
              const item = catalogItems.find(i => i.id === card.dataset.id);
              if (item) {
                packages[packageIndex].items.push({
                  name: item.name,
                  description: item.description || '',
                  quantity: 1,
                  price: item.default_price || 0,
                  is_included: true
                });
              }
            });
            updatePackagesUI();
            closeModal(modal);
          }
        })
      ]);
      
      const modal = createModal({
        title: 'Add Items to Bundle',
        content,
        footer,
        size: 'xl'
      });
      
      // Handle custom item button
      $('#add-custom-pkg-item', modal).onclick = () => {
        closeModal(modal);
        showPackageItemModal(packageIndex);
      };
    }
    
    function editPackageItem(packageIndex, itemIndex) {
      showPackageItemModal(packageIndex, packages[packageIndex].items[itemIndex], itemIndex);
    }
    
    function showPackageItemModal(packageIndex, item = null, itemIndex = null) {
      const isEdit = item !== null;
      
      const content = createElement('div');
      content.innerHTML = `
        <div class="form-group">
          <label class="form-label">Item Name *</label>
          <input type="text" id="item-name" class="form-input" value="${item?.name || ''}" placeholder="e.g., Cabinet Refacing">
        </div>
        <div class="form-group">
          <label class="form-label">Description <span class="form-label-optional">(optional)</span></label>
          <textarea id="item-description" class="form-textarea" rows="2" placeholder="Item description...">${item?.description || ''}</textarea>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-md);">
          <div class="form-group">
            <label class="form-label">Quantity</label>
            <input type="number" id="item-qty" class="form-input" value="${item?.quantity || 1}" min="0" step="0.01">
          </div>
          <div class="form-group">
            <label class="form-label">Price</label>
            <div class="input-group">
              <span class="input-group-prepend">$</span>
              <input type="number" id="item-price" class="form-input" value="${item?.price || 0}" min="0" step="0.01">
            </div>
          </div>
        </div>
        <div class="form-group">
          <div class="toggle-row">
            <div>
              <div class="toggle-label">Included in Package</div>
              <div class="toggle-description">Uncheck to show as excluded (crossed out)</div>
            </div>
            <label class="toggle">
              <input type="checkbox" id="item-included" ${item?.is_included !== false ? 'checked' : ''}>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
      `;
      
      const footer = createElement('div', { className: 'flex justify-between' });
      const leftBtns = createElement('div');
      const rightBtns = createElement('div', { className: 'flex gap-md' });
      
      if (isEdit) {
        const deleteBtn = createElement('button', { className: 'btn btn-danger', textContent: 'Delete' });
        deleteBtn.onclick = () => {
          packages[packageIndex].items.splice(itemIndex, 1);
          updatePackagesUI();
          closeModal(modal);
          showToast('Item removed', 'success');
        };
        leftBtns.appendChild(deleteBtn);
      }
      
      const cancelBtn = createElement('button', { className: 'btn btn-secondary', textContent: 'Cancel' });
      const saveBtn = createElement('button', { className: 'btn btn-primary', textContent: isEdit ? 'Save' : 'Add Item' });
      rightBtns.appendChild(cancelBtn);
      rightBtns.appendChild(saveBtn);
      
      footer.appendChild(leftBtns);
      footer.appendChild(rightBtns);
      
      const modal = createModal({
        title: isEdit ? 'Edit Item' : 'Add Item to Bundle',
        content,
        footer
      });
      
      cancelBtn.onclick = () => closeModal(modal);
      saveBtn.onclick = () => {
        const name = $('#item-name').value.trim();
        if (!name) {
          showToast('Item name is required', 'error');
          return;
        }
        
        const newItem = {
          name,
          description: $('#item-description').value.trim(),
          quantity: parseFloat($('#item-qty').value) || 1,
          price: parseFloat($('#item-price').value) || 0,
          is_included: $('#item-included').checked
        };
        
        if (isEdit) {
          packages[packageIndex].items[itemIndex] = newItem;
        } else {
          packages[packageIndex].items.push(newItem);
        }
        
        updatePackagesUI();
        closeModal(modal);
      };
    }
    
    function showPackagesHelp() {
      const content = createElement('div');
      content.innerHTML = `
        <div style="line-height: 1.6;">
          <h4 style="margin-top: 0;">How Bundles Work</h4>
          <p>Bundles let you offer customers different pricing tiers (e.g., Basic, Standard, Premium) instead of a single quote.</p>
          
          <h4>Creating Bundles</h4>
          <ol>
            <li>Click <strong>"Add Bundle"</strong> to create a new bundle</li>
            <li>Give it a name and optional description</li>
            <li>Add line items to the bundle using the <strong>"Add Item"</strong> button</li>
            <li>Items can be marked as "included" or "excluded" (shown crossed out)</li>
          </ol>
          
          <h4>Bundle Options</h4>
          <ul>
            <li><strong>Mark as Recommended:</strong> Highlights this bundle for customers</li>
            <li><strong>Override Price:</strong> Set a flat price instead of calculating from items</li>
            <li><strong>Hide Excluded Items:</strong> Don't show crossed-out items to customers</li>
          </ul>
          
          <h4>Customer Experience</h4>
          <p>When "Enable Bundle Selection" is on, customers will see bundle cards side-by-side and must select one before they can approve the quote.</p>
        </div>
      `;
      
      createModal({
        title: 'How Bundles Work',
        content,
        size: 'md'
      });
    }
  </script>
</body>
</html>
