<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings | Admin | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css?v=30">
</head>
<body>
  <div class="app-layout">
    <aside class="app-sidebar">
      <div class="sidebar-logo">
        <img src="/images/logo.gif" alt="Homestead Cabinet Design" style="height: 40px; filter: brightness(0) invert(1);">
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item"><a href="/admin/index.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard</a></li>
          <li class="sidebar-nav-item"><a href="/admin/pipeline.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Deals Pipeline</a></li>
          <li class="sidebar-nav-item"><a href="/admin/customers.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Customers</a></li>
          <li class="sidebar-nav-item"><a href="/admin/quotes.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>Quotes</a></li>
          <li class="sidebar-nav-item"><a href="/admin/invoices.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>Invoices</a></li>
        </ul>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Catalog</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/catalog.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>Items Catalog</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/settings.html" class="sidebar-nav-link active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</a></li>
          </ul>
        </div>
      </nav>
    </aside>
    
    <main class="app-main">
      <header class="app-header">
        <h2>Settings</h2>
      </header>
      
      <div class="app-content">
        <!-- Logo & Branding -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Logo & Branding</h3>
          </div>
          <div class="card-body">
            <div class="grid grid-cols-2 gap-xl">
              <div>
                <div class="form-group">
                  <label class="form-label">Company Logo</label>
                  <div style="background: var(--color-bg-soft); border: 2px dashed var(--color-border); border-radius: var(--radius-lg); padding: var(--space-xl); text-align: center;">
                    <img id="logo-preview" src="/images/logo.gif" alt="Logo" style="max-width: 200px; max-height: 80px; margin-bottom: var(--space-md);">
                    <div>
                      <input type="file" id="logo-upload" accept="image/*" style="display: none;">
                      <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('logo-upload').click()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Upload New Logo
                      </button>
                    </div>
                    <p class="form-help" style="margin-top: var(--space-sm);">Recommended: PNG or GIF, max 500KB</p>
                  </div>
                </div>
              </div>
              <div>
                <div class="form-group">
                  <label class="form-label">Tagline</label>
                  <input type="text" id="company-tagline" class="form-input" value="Love your kitchen again">
                  <div class="form-help">Shown in emails and portal header</div>
                </div>
                <div class="form-group">
                  <label class="form-label">Primary Brand Color</label>
                  <div style="display: flex; gap: var(--space-sm); align-items: center;">
                    <input type="color" id="brand-color" value="#6366f1" style="width: 50px; height: 38px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); cursor: pointer;">
                    <input type="text" id="brand-color-hex" class="form-input" value="#6366f1" style="width: 100px;">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Customer Portal Link -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Customer Portal Access</h3>
          </div>
          <div class="card-body">
            <p style="color: var(--color-text-light); margin-bottom: var(--space-md);">Share this link with customers so they can access their quotes, invoices, and make payments:</p>
            <div style="display: flex; gap: var(--space-sm); align-items: center;">
              <input type="text" id="portal-link" class="form-input" readonly style="flex: 1; background: var(--color-bg-soft);">
              <button type="button" class="btn btn-secondary" onclick="copyPortalLink()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                Copy Link
              </button>
            </div>
            <p class="form-help" style="margin-top: var(--space-sm);">Customers will enter their email to receive a secure login link.</p>
          </div>
        </div>
        
        <!-- Company Information -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Company Information</h3>
          </div>
          <div class="card-body">
            <form id="company-form">
              <div class="grid grid-cols-2 gap-lg">
                <div class="form-group">
                  <label class="form-label">Company Name</label>
                  <input type="text" name="name" id="company-name" class="form-input" value="Homestead Cabinet Design">
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input type="email" name="email" id="company-email" class="form-input">
                </div>
              </div>
              <div class="grid grid-cols-2 gap-lg">
                <div class="form-group">
                  <label class="form-label">Phone</label>
                  <input type="tel" name="phone" id="company-phone" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Website</label>
                  <input type="url" name="website" id="company-website" class="form-input" value="https://homesteadcabinetdesign.com">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Address</label>
                <input type="text" name="address" id="company-address" class="form-input">
              </div>
              <div class="grid grid-cols-3 gap-lg">
                <div class="form-group">
                  <label class="form-label">City</label>
                  <input type="text" name="city" id="company-city" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">State</label>
                  <input type="text" name="state" id="company-state" class="form-input" value="MA">
                </div>
                <div class="form-group">
                  <label class="form-label">ZIP</label>
                  <input type="text" name="zip" id="company-zip" class="form-input">
                </div>
              </div>
              <button type="submit" class="btn btn-primary">Save Company Info</button>
            </form>
          </div>
        </div>
        
        <!-- Quote Settings -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Quote Settings</h3>
          </div>
          <div class="card-body">
            <form id="quote-settings-form">
              <div class="grid grid-cols-3 gap-lg">
                <div class="form-group">
                  <label class="form-label">Default Valid Days</label>
                  <input type="number" name="default_valid_days" id="default-valid-days" class="form-input" value="30" min="1">
                  <div class="form-help">How many days quotes are valid by default</div>
                </div>
                <div class="form-group">
                  <label class="form-label">Default Tax Rate (%)</label>
                  <input type="number" name="default_tax_rate" id="default-tax-rate" class="form-input" value="6.25" step="0.01" min="0">
                </div>
                <div class="form-group">
                  <label class="form-label">Default Deposit (%)</label>
                  <input type="number" name="default_deposit" id="default-deposit" class="form-input" value="50" min="0" max="100">
                </div>
              </div>
              <button type="submit" class="btn btn-primary">Save Quote Settings</button>
            </form>
          </div>
        </div>
        
        <!-- Invoice Settings -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Invoice Settings</h3>
          </div>
          <div class="card-body">
            <form id="invoice-settings-form">
              <div class="grid grid-cols-2 gap-lg">
                <div class="form-group">
                  <label class="form-label">Default Payment Terms (Days)</label>
                  <input type="number" name="default_payment_terms" id="default-payment-terms" class="form-input" value="30" min="0">
                  <div class="form-help">Days until invoice is due (0 = due on receipt)</div>
                </div>
                <div class="form-group">
                  <label class="form-label">Late Fee (%)</label>
                  <input type="number" name="late_fee_percent" id="late-fee-percent" class="form-input" value="0" step="0.1" min="0">
                  <div class="form-help">Optional late fee percentage for overdue invoices</div>
                </div>
              </div>
              <button type="submit" class="btn btn-primary">Save Invoice Settings</button>
            </form>
          </div>
        </div>
        
        <!-- Notification Settings -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Notification Settings</h3>
          </div>
          <div class="card-body">
            <p style="color: var(--color-text-light); margin-bottom: var(--space-lg);">
              Choose which notifications you'd like to receive via email.
            </p>
            <form id="notification-form">
              <div class="notification-grid">
                <div class="notification-row">
                  <span class="notification-label">New Appointment</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_new_appointment" id="notify-new-appointment" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Quote Accepted</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_quote_accepted" id="notify-quote-accepted" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Quote Declined</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_quote_declined" id="notify-quote-declined" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Quote Viewed</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_quote_viewed" id="notify-quote-viewed" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Invoice Viewed</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_invoice_viewed" id="notify-invoice-viewed" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Payment Received</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_payment_received" id="notify-payment-received" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Customer Photo Upload</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_customer_upload" id="notify-customer-upload" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Job Stage Changed</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_job_stage_changed" id="notify-job-stage-changed">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
              
              <div style="margin-top: var(--space-xl); padding-top: var(--space-lg); border-top: 1px solid var(--color-border);">
                <button type="submit" class="btn btn-primary">Save Notification Settings</button>
              </div>
            </form>
          </div>
        </div>
        
        <style>
          .notification-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            max-width: 400px;
          }
          
          .notification-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
          }
          
          .notification-label {
            font-size: 0.9375rem;
            color: var(--color-text);
          }
          
          /* Toggle Switch */
          .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
            flex-shrink: 0;
          }
          
          .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
          }
          
          .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: 0.3s;
            border-radius: 26px;
          }
          
          .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
          }
          
          .toggle-switch input:checked + .toggle-slider {
            background-color: var(--color-primary);
          }
          
          .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
          }
          
          .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
          }
        </style>
        
        <!-- Terms and Conditions -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Terms and Conditions</h3>
          </div>
          <div class="card-body">
            <p style="color: var(--color-text-light); margin-bottom: var(--space-lg);">
              These terms will appear at the bottom of your quotes and invoices. You can customize them for each document type.
            </p>
            
            <div class="form-group">
              <label class="form-label">Quote Terms & Conditions</label>
              <textarea id="quote-terms" class="form-input" rows="6" placeholder="Enter your quote terms and conditions...">• This quote is valid for 30 days from the date issued.
• A 50% deposit is required to schedule your project.
• Final payment is due upon completion of work.
• Any changes to the scope of work may result in additional charges.
• Customer is responsible for clearing work areas before project start.
• Homestead Cabinet Design is fully insured.</textarea>
              <div class="form-help">Displayed on all quotes sent to customers.</div>
            </div>
            
            <div class="form-group" style="margin-top: var(--space-xl);">
              <label class="form-label">Invoice Terms & Conditions</label>
              <textarea id="invoice-terms" class="form-input" rows="6" placeholder="Enter your invoice terms and conditions...">• Payment is due within 30 days of invoice date unless otherwise specified.
• We accept check, credit card, and bank transfer.
• A late fee of 1.5% per month may be applied to overdue balances.
• Please reference invoice number with your payment.
• Questions? Contact us at raymond@homesteadcabinetdesign.com</textarea>
              <div class="form-help">Displayed on all invoices sent to customers.</div>
            </div>
            
            <button type="button" class="btn btn-primary" onclick="saveTerms()">Save Terms & Conditions</button>
          </div>
        </div>
        
        <!-- Email Templates -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Email Templates</h3>
          </div>
          <div class="card-body">
            <div class="form-help" style="margin-bottom: var(--space-lg); padding: var(--space-md); background: var(--color-bg-soft); border-radius: var(--radius-md);">
              <strong>Available Variables:</strong><br>
              <code>{{customer_name}}</code> - Customer's full name<br>
              <code>{{customer_first_name}}</code> - Customer's first name<br>
              <code>{{quote_number}}</code> / <code>{{invoice_number}}</code> - Document number<br>
              <code>{{quote_title}}</code> / <code>{{invoice_title}}</code> - Document title<br>
              <code>{{total}}</code> - Total amount<br>
              <code>{{amount_due}}</code> - Balance due<br>
              <code>{{due_date}}</code> - Due date<br>
              <code>{{company_name}}</code> - Your company name
            </div>
            
            <!-- Quote Email -->
            <div class="form-group">
              <label class="form-label">Quote Email Subject</label>
              <input type="text" id="quote-email-subject" class="form-input" value="Quote #{{quote_number}}: {{quote_title}}">
            </div>
            <div class="form-group">
              <label class="form-label">Quote Email Message</label>
              <textarea id="quote-email-body" class="form-input" rows="4">Hi {{customer_first_name}},

Thank you for your interest in our services! We've prepared a quote for your project.

Click the button below to view the full details and accept your quote.</textarea>
              <div class="form-help">The quote details and view button are added automatically after this message.</div>
            </div>
            
            <!-- Invoice Email -->
            <div class="form-group" style="margin-top: var(--space-xl);">
              <label class="form-label">Invoice Email Subject</label>
              <input type="text" id="invoice-email-subject" class="form-input" value="Invoice #{{invoice_number}}: {{invoice_title}}">
            </div>
            <div class="form-group">
              <label class="form-label">Invoice Email Message</label>
              <textarea id="invoice-email-body" class="form-input" rows="4">Hi {{customer_first_name}},

Here is your invoice for recent services. The total amount due is {{amount_due}}.

Click the button below to view the full invoice and make a payment.</textarea>
            </div>
            
            <!-- Payment Thank You -->
            <div class="form-group" style="margin-top: var(--space-xl);">
              <label class="form-label">Payment Confirmation Message</label>
              <textarea id="payment-thank-you" class="form-input" rows="4">Thank you for your payment! We truly appreciate your business.

Your payment has been received and a confirmation has been sent to your email address.

If you have any questions about your project, please don't hesitate to reach out.</textarea>
              <div class="form-help">Shown on the thank you page after a customer makes a payment.</div>
            </div>
            
            <button type="button" class="btn btn-primary" onclick="saveEmailTemplates()">Save Email Templates</button>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script src="/js/utils.js"></script>
  <script>
    
    let settings = {};
    
    // Set portal link
    const siteUrl = window.location.origin;
    document.getElementById('portal-link').value = siteUrl + '/portal/login.html';
    
    function copyPortalLink() {
      const link = document.getElementById('portal-link');
      link.select();
      document.execCommand('copy');
      showToast('Portal link copied to clipboard', 'success');
    }
    
    // Logo upload handling
    document.getElementById('logo-upload').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (file.size > 500000) {
        showToast('Logo file must be under 500KB', 'error');
        return;
      }
      
      // Preview
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('logo-preview').src = e.target.result;
      };
      reader.readAsDataURL(file);
      
      // For now, show a message about manual upload
      showToast('Logo preview updated. Full logo upload coming soon!', 'success');
    });
    
    // Brand color sync
    document.getElementById('brand-color').addEventListener('input', function(e) {
      document.getElementById('brand-color-hex').value = e.target.value;
    });
    
    document.getElementById('brand-color-hex').addEventListener('input', function(e) {
      if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
        document.getElementById('brand-color').value = e.target.value;
      }
    });
    
    async function loadSettings() {
      try {
        const supabase = await app.waitForSupabase();
        
        const { data, error } = await supabase
          .from('settings')
          .select('*');
        
        if (error) throw error;
        
        // Convert to key-value object
        settings = {};
        (data || []).forEach(row => {
          settings[row.key] = row.value;
        });
        
        // Populate forms
        if (settings.company) {
          const company = settings.company;
          $('#company-name').value = company.name || '';
          $('#company-email').value = company.email || '';
          $('#company-phone').value = company.phone || '';
          $('#company-website').value = company.website || '';
          $('#company-address').value = company.address || '';
          $('#company-city').value = company.city || '';
          $('#company-state').value = company.state || 'MA';
          $('#company-zip').value = company.zip || '';
        }
        
        if (settings.branding) {
          const branding = settings.branding;
          $('#company-tagline').value = branding.tagline || 'Love your kitchen again';
          $('#brand-color').value = branding.color || '#6366f1';
          $('#brand-color-hex').value = branding.color || '#6366f1';
        }
        
        if (settings.quotes) {
          const quotes = settings.quotes;
          $('#default-valid-days').value = quotes.default_valid_days || 30;
          $('#default-tax-rate').value = quotes.default_tax_rate || 6.25;
          $('#default-deposit').value = quotes.default_deposit || 50;
        }
        
        if (settings.invoices) {
          const invoices = settings.invoices;
          $('#default-payment-terms').value = invoices.default_payment_terms || 30;
          $('#late-fee-percent').value = invoices.late_fee_percent || 0;
        }
        
        if (settings.notifications) {
          const notifs = settings.notifications;
          $('#notify-new-appointment').checked = notifs.new_appointment !== false;
          $('#notify-quote-accepted').checked = notifs.quote_accepted !== false;
          $('#notify-quote-declined').checked = notifs.quote_declined !== false;
          $('#notify-quote-viewed').checked = notifs.quote_viewed !== false;
          $('#notify-invoice-viewed').checked = notifs.invoice_viewed !== false;
          $('#notify-payment-received').checked = notifs.payment_received !== false;
          $('#notify-customer-upload').checked = notifs.customer_upload !== false;
          $('#notify-job-stage-changed').checked = notifs.job_stage_changed === true;
        }
        
        if (settings.email_templates) {
          const templates = settings.email_templates;
          if (templates.quote_subject) $('#quote-email-subject').value = templates.quote_subject;
          if (templates.quote_body) $('#quote-email-body').value = templates.quote_body;
          if (templates.invoice_subject) $('#invoice-email-subject').value = templates.invoice_subject;
          if (templates.invoice_body) $('#invoice-email-body').value = templates.invoice_body;
          if (templates.payment_thank_you) $('#payment-thank-you').value = templates.payment_thank_you;
        }
        
        if (settings.terms_and_conditions) {
          const terms = settings.terms_and_conditions;
          if (terms.quote) $('#quote-terms').value = terms.quote;
          if (terms.invoice) $('#invoice-terms').value = terms.invoice;
        }
        
      } catch (err) {
        console.error('Load settings error:', err);
        showToast('Failed to load settings', 'error');
      }
    }
    
    async function saveSetting(key, value) {
      try {
        const supabase = await app.waitForSupabase();
        
        const { error } = await supabase
          .from('settings')
          .upsert({ key, value }, { onConflict: 'key' });
        
        if (error) throw error;
        showToast('Settings saved', 'success');
      } catch (err) {
        console.error('Save error:', err);
        showToast('Failed to save: ' + err.message, 'error');
      }
    }
    
    async function saveEmailTemplates() {
      const value = {
        quote_subject: $('#quote-email-subject').value,
        quote_body: $('#quote-email-body').value,
        invoice_subject: $('#invoice-email-subject').value,
        invoice_body: $('#invoice-email-body').value,
        payment_thank_you: $('#payment-thank-you').value
      };
      await saveSetting('email_templates', value);
    }
    
    async function saveTerms() {
      const value = {
        quote: $('#quote-terms').value,
        invoice: $('#invoice-terms').value
      };
      await saveSetting('terms_and_conditions', value);
    }
    
    // Company form
    $('#company-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const value = {
        name: $('#company-name').value,
        email: $('#company-email').value,
        phone: $('#company-phone').value,
        website: $('#company-website').value,
        address: $('#company-address').value,
        city: $('#company-city').value,
        state: $('#company-state').value,
        zip: $('#company-zip').value
      };
      await saveSetting('company', value);
      
      // Also save branding
      const branding = {
        tagline: $('#company-tagline').value,
        color: $('#brand-color').value
      };
      await saveSetting('branding', branding);
    });
    
    // Quote settings form
    $('#quote-settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const value = {
        default_valid_days: parseInt($('#default-valid-days').value) || 30,
        default_tax_rate: parseFloat($('#default-tax-rate').value) || 6.25,
        default_deposit: parseInt($('#default-deposit').value) || 50
      };
      await saveSetting('quotes', value);
    });
    
    // Invoice settings form
    $('#invoice-settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const value = {
        default_payment_terms: parseInt($('#default-payment-terms').value) || 30,
        late_fee_percent: parseFloat($('#late-fee-percent').value) || 0
      };
      await saveSetting('invoices', value);
    });
    
    // Notification form
    $('#notification-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const value = {
        new_appointment: $('#notify-new-appointment').checked,
        quote_accepted: $('#notify-quote-accepted').checked,
        quote_declined: $('#notify-quote-declined').checked,
        quote_viewed: $('#notify-quote-viewed').checked,
        invoice_viewed: $('#notify-invoice-viewed').checked,
        payment_received: $('#notify-payment-received').checked,
        customer_upload: $('#notify-customer-upload').checked,
        job_stage_changed: $('#notify-job-stage-changed').checked
      };
      await saveSetting('notifications', value);
    });
    
    // Initialize
    loadSettings();
  </script>
</body>
</html>
