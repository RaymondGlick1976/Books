<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings | Admin | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css?v=39">
</head>
<body>
  <script>
    // Admin-only page check (before content loads)
    const user = JSON.parse(localStorage.getItem('app_user') || 'null');
    if (!user) {
      window.location.href = '/admin/login.html';
    } else if (!user.permissions?.can_access_settings) {
      window.location.href = '/admin/index.html';
    }
  </script>
  <div class="app-layout">
    <aside class="app-sidebar">
      <div class="sidebar-logo">
        <img src="/images/logo.gif" alt="Homestead Cabinet Design" style="height: 40px; filter: brightness(0) invert(1);">
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item"><a href="/admin/index.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard</a></li>
          <li class="sidebar-nav-item"><a href="/admin/pipeline.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Deals Pipeline</a></li>
          <li class="sidebar-nav-item"><a href="/admin/customers.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Customers</a></li>
          <li class="sidebar-nav-item"><a href="/admin/quotes.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>Quotes</a></li>
          <li class="sidebar-nav-item"><a href="/admin/invoices.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>Invoices</a></li>
        </ul>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Lead Capture</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/booking-forms.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>Booking Forms</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Catalog</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/catalog.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>Items Catalog</a></li>
            <li class="sidebar-nav-item"><a href="/admin/pricing-attributes.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/><line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/><line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/><line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/><line x1="17" y1="16" x2="23" y2="16"/></svg>Pricing Attributes</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/email-templates.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Email Templates</a></li>
          </ul>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/settings.html" class="sidebar-nav-link active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</a></li>
          </ul>
        </div>
      </nav>
    </aside>
    
    <main class="app-main">
      <header class="app-header">
        <h2>Settings</h2>
      </header>
      
      <div class="app-content">
        <!-- Logo & Branding -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Logo & Branding</h3>
          </div>
          <div class="card-body">
            <div class="grid grid-cols-2 gap-xl">
              <div>
                <div class="form-group">
                  <label class="form-label">Company Logo</label>
                  <div style="background: var(--color-bg-soft); border: 2px dashed var(--color-border); border-radius: var(--radius-lg); padding: var(--space-xl); text-align: center;">
                    <img id="logo-preview" src="/images/logo.gif" alt="Logo" style="max-width: 200px; max-height: 80px; margin-bottom: var(--space-md);">
                    <div>
                      <input type="file" id="logo-upload" accept="image/*" style="display: none;">
                      <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('logo-upload').click()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        Upload New Logo
                      </button>
                    </div>
                    <p class="form-help" style="margin-top: var(--space-sm);">Recommended: PNG or GIF, max 500KB</p>
                  </div>
                </div>
              </div>
              <div>
                <div class="form-group">
                  <label class="form-label">Tagline</label>
                  <input type="text" id="company-tagline" class="form-input" value="Love your kitchen again">
                  <div class="form-help">Shown in emails and portal header</div>
                </div>
                <div class="form-group">
                  <label class="form-label">Primary Brand Color</label>
                  <div style="display: flex; gap: var(--space-sm); align-items: center;">
                    <input type="color" id="brand-color" value="#6366f1" style="width: 50px; height: 38px; border: 1px solid var(--color-border); border-radius: var(--radius-sm); cursor: pointer;">
                    <input type="text" id="brand-color-hex" class="form-input" value="#6366f1" style="width: 100px;">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Customer Portal Link -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Customer Portal Access</h3>
          </div>
          <div class="card-body">
            <p style="color: var(--color-text-light); margin-bottom: var(--space-md);">Share this link with customers so they can access their quotes, invoices, and make payments:</p>
            <div style="display: flex; gap: var(--space-sm); align-items: center;">
              <input type="text" id="portal-link" class="form-input" readonly style="flex: 1; background: var(--color-bg-soft);">
              <button type="button" class="btn btn-secondary" onclick="copyPortalLink()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                Copy Link
              </button>
            </div>
            <p class="form-help" style="margin-top: var(--space-sm);">Customers will enter their email to receive a secure login link.</p>
          </div>
        </div>
        
        <!-- Company Information -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Company Information</h3>
          </div>
          <div class="card-body">
            <form id="company-form">
              <div class="grid grid-cols-2 gap-lg">
                <div class="form-group">
                  <label class="form-label">Company Name</label>
                  <input type="text" name="name" id="company-name" class="form-input" value="Homestead Cabinet Design">
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input type="email" name="email" id="company-email" class="form-input">
                </div>
              </div>
              <div class="grid grid-cols-2 gap-lg">
                <div class="form-group">
                  <label class="form-label">Phone</label>
                  <input type="tel" name="phone" id="company-phone" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">Website</label>
                  <input type="url" name="website" id="company-website" class="form-input" value="https://homesteadcabinetdesign.com">
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">Address</label>
                <input type="text" name="address" id="company-address" class="form-input">
              </div>
              <div class="grid grid-cols-3 gap-lg">
                <div class="form-group">
                  <label class="form-label">City</label>
                  <input type="text" name="city" id="company-city" class="form-input">
                </div>
                <div class="form-group">
                  <label class="form-label">State</label>
                  <input type="text" name="state" id="company-state" class="form-input" value="MA">
                </div>
                <div class="form-group">
                  <label class="form-label">ZIP</label>
                  <input type="text" name="zip" id="company-zip" class="form-input">
                </div>
              </div>
              <button type="submit" class="btn btn-primary">Save Company Info</button>
            </form>
          </div>
        </div>
        
        <!-- Quote Settings -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Quote Settings</h3>
          </div>
          <div class="card-body">
            <form id="quote-settings-form">
              <div class="grid grid-cols-3 gap-lg">
                <div class="form-group">
                  <label class="form-label">Default Valid Days</label>
                  <input type="number" name="default_valid_days" id="default-valid-days" class="form-input" value="30" min="1">
                  <div class="form-help">How many days quotes are valid by default</div>
                </div>
                <div class="form-group">
                  <label class="form-label">Default Tax Rate (%)</label>
                  <input type="number" name="default_tax_rate" id="default-tax-rate" class="form-input" value="6.25" step="0.01" min="0">
                </div>
                <div class="form-group">
                  <label class="form-label">Default Deposit (%)</label>
                  <input type="number" name="default_deposit" id="default-deposit" class="form-input" value="50" min="0" max="100">
                </div>
              </div>
              <button type="submit" class="btn btn-primary">Save Quote Settings</button>
            </form>
          </div>
        </div>
        
        <!-- Invoice Settings -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Invoice Settings</h3>
          </div>
          <div class="card-body">
            <form id="invoice-settings-form">
              <div class="grid grid-cols-2 gap-lg">
                <div class="form-group">
                  <label class="form-label">Default Payment Terms (Days)</label>
                  <input type="number" name="default_payment_terms" id="default-payment-terms" class="form-input" value="30" min="0">
                  <div class="form-help">Days until invoice is due (0 = due on receipt)</div>
                </div>
                <div class="form-group">
                  <label class="form-label">Late Fee (%)</label>
                  <input type="number" name="late_fee_percent" id="late-fee-percent" class="form-input" value="0" step="0.1" min="0">
                  <div class="form-help">Optional late fee percentage for overdue invoices</div>
                </div>
              </div>
              <button type="submit" class="btn btn-primary">Save Invoice Settings</button>
            </form>
          </div>
        </div>
        
        <!-- Lead Sources -->
        <div class="card mb-xl">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">Lead Sources</h3>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addLeadSource()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add Source
            </button>
          </div>
          <div class="card-body">
            <p style="color: var(--color-text-light); margin-bottom: var(--space-lg);">
              Manage the list of lead sources for tracking where customers come from.
            </p>
            <div id="lead-sources-list">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>
        
        <!-- Appointment Types -->
        <div class="card mb-xl">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">Appointment Types</h3>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addAppointmentType()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add Type
            </button>
          </div>
          <div class="card-body">
            <p style="color: var(--color-text-light); margin-bottom: var(--space-lg);">
              Customize appointment types shown in the "New Appointment" dropdown on the Deals Pipeline.
            </p>
            <div id="appointment-types-list">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>
        
        <!-- User Management -->
        <div class="card mb-xl">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">User Management</h3>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addUser()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add User
            </button>
          </div>
          <div class="card-body">
            <p style="color: var(--color-text-light); margin-bottom: var(--space-lg);">
              Manage users who can access the admin panel. Assign roles to control their permissions.
            </p>
            <div id="users-list">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>
        
        <!-- Roles Management -->
        <div class="card mb-xl">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 class="card-title">Roles & Permissions</h3>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addRole()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Add Role
            </button>
          </div>
          <div class="card-body">
            <p style="color: var(--color-text-light); margin-bottom: var(--space-lg);">
              Define roles with specific permissions. Users inherit permissions from their assigned role.
            </p>
            <div id="roles-list">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>
        
        <!-- Notification Settings -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Notification Settings</h3>
          </div>
          <div class="card-body">
            <p style="color: var(--color-text-light); margin-bottom: var(--space-lg);">
              Choose which notifications you'd like to receive via email.
            </p>
            <form id="notification-form">
              <div class="notification-grid">
                <div class="notification-row">
                  <span class="notification-label">New Appointment</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_new_appointment" id="notify-new-appointment" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Quote Accepted</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_quote_accepted" id="notify-quote-accepted" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Quote Declined</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_quote_declined" id="notify-quote-declined" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Quote Viewed</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_quote_viewed" id="notify-quote-viewed" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Invoice Viewed</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_invoice_viewed" id="notify-invoice-viewed" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Payment Received</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_payment_received" id="notify-payment-received" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Customer Photo Upload</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_customer_upload" id="notify-customer-upload" checked>
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                
                <div class="notification-row">
                  <span class="notification-label">Job Stage Changed</span>
                  <label class="toggle-switch">
                    <input type="checkbox" name="notify_job_stage_changed" id="notify-job-stage-changed">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>
              
              <div style="margin-top: var(--space-xl); padding-top: var(--space-lg); border-top: 1px solid var(--color-border);">
                <button type="submit" class="btn btn-primary">Save Notification Settings</button>
              </div>
            </form>
          </div>
        </div>
        
        <style>
          .notification-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
            max-width: 400px;
          }
          
          .notification-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
          }
          
          .notification-label {
            font-size: 0.9375rem;
            color: var(--color-text);
          }
          
          /* Toggle Switch */
          .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
            flex-shrink: 0;
          }
          
          .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
          }
          
          .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: 0.3s;
            border-radius: 26px;
          }
          
          .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
          }
          
          .toggle-switch input:checked + .toggle-slider {
            background-color: var(--color-primary);
          }
          
          .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
          }
          
          .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
          }
        </style>
        
        <!-- Terms and Conditions -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Terms and Conditions</h3>
          </div>
          <div class="card-body">
            <p style="color: var(--color-text-light); margin-bottom: var(--space-lg);">
              These terms will appear at the bottom of your quotes and invoices. You can customize them for each document type.
            </p>
            
            <div class="form-group">
              <label class="form-label">Quote Terms & Conditions</label>
              <textarea id="quote-terms" class="form-input" rows="6" placeholder="Enter your quote terms and conditions...">‚Ä¢ This quote is valid for 30 days from the date issued.
‚Ä¢ A 50% deposit is required to schedule your project.
‚Ä¢ Final payment is due upon completion of work.
‚Ä¢ Any changes to the scope of work may result in additional charges.
‚Ä¢ Customer is responsible for clearing work areas before project start.
‚Ä¢ Homestead Cabinet Design is fully insured.</textarea>
              <div class="form-help">Displayed on all quotes sent to customers.</div>
            </div>
            
            <div class="form-group" style="margin-top: var(--space-xl);">
              <label class="form-label">Invoice Terms & Conditions</label>
              <textarea id="invoice-terms" class="form-input" rows="6" placeholder="Enter your invoice terms and conditions...">‚Ä¢ Payment is due within 30 days of invoice date unless otherwise specified.
‚Ä¢ We accept check, credit card, and bank transfer.
‚Ä¢ A late fee of 1.5% per month may be applied to overdue balances.
‚Ä¢ Please reference invoice number with your payment.
‚Ä¢ Questions? Contact us at raymond@homesteadcabinetdesign.com</textarea>
              <div class="form-help">Displayed on all invoices sent to customers.</div>
            </div>
            
            <button type="button" class="btn btn-primary" onclick="saveTerms()">Save Terms & Conditions</button>
          </div>
        </div>
        
        <!-- Email Templates Link -->
        <div class="card mb-xl">
          <div class="card-header">
            <h3 class="card-title">Email Templates</h3>
          </div>
          <div class="card-body">
            <p class="text-muted mb-md">Manage all your email templates including quotes, invoices, payment confirmations, and deal stage notifications.</p>
            <a href="/admin/email-templates.html" class="btn btn-primary">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
              </svg>
              Manage Email Templates
            </a>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script src="/js/utils.js"></script>
  <script>
    
    let settings = {};
    
    // Set portal link
    const siteUrl = window.location.origin;
    document.getElementById('portal-link').value = siteUrl + '/portal/login.html';
    
    function copyPortalLink() {
      const link = document.getElementById('portal-link');
      link.select();
      document.execCommand('copy');
      showToast('Portal link copied to clipboard', 'success');
    }
    
    // Logo upload handling
    document.getElementById('logo-upload').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (file.size > 500000) {
        showToast('Logo file must be under 500KB', 'error');
        return;
      }
      
      // Preview
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('logo-preview').src = e.target.result;
      };
      reader.readAsDataURL(file);
      
      // For now, show a message about manual upload
      showToast('Logo preview updated. Full logo upload coming soon!', 'success');
    });
    
    // Brand color sync
    document.getElementById('brand-color').addEventListener('input', function(e) {
      document.getElementById('brand-color-hex').value = e.target.value;
      // Preview the color change immediately
      if (window.applyBrandColor) {
        applyBrandColor(e.target.value);
      }
    });
    
    document.getElementById('brand-color-hex').addEventListener('input', function(e) {
      if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
        document.getElementById('brand-color').value = e.target.value;
        // Preview the color change immediately
        if (window.applyBrandColor) {
          applyBrandColor(e.target.value);
        }
      }
    });
    
    async function loadSettings() {
      try {
        const supabase = await app.waitForSupabase();
        
        const { data, error } = await supabase
          .from('settings')
          .select('*');
        
        if (error) throw error;
        
        // Convert to key-value object
        settings = {};
        (data || []).forEach(row => {
          settings[row.key] = row.value;
        });
        
        // Populate forms
        if (settings.company) {
          const company = settings.company;
          $('#company-name').value = company.name || '';
          $('#company-email').value = company.email || '';
          $('#company-phone').value = company.phone || '';
          $('#company-website').value = company.website || '';
          $('#company-address').value = company.address || '';
          $('#company-city').value = company.city || '';
          $('#company-state').value = company.state || 'MA';
          $('#company-zip').value = company.zip || '';
        }
        
        if (settings.branding) {
          const branding = settings.branding;
          $('#company-tagline').value = branding.tagline || 'Love your kitchen again';
          $('#brand-color').value = branding.color || '#6366f1';
          $('#brand-color-hex').value = branding.color || '#6366f1';
        }
        
        if (settings.quotes) {
          const quotes = settings.quotes;
          $('#default-valid-days').value = quotes.default_valid_days || 30;
          $('#default-tax-rate').value = quotes.default_tax_rate || 6.25;
          $('#default-deposit').value = quotes.default_deposit || 50;
        }
        
        if (settings.invoices) {
          const invoices = settings.invoices;
          $('#default-payment-terms').value = invoices.default_payment_terms || 30;
          $('#late-fee-percent').value = invoices.late_fee_percent || 0;
        }
        
        if (settings.notifications) {
          const notifs = settings.notifications;
          $('#notify-new-appointment').checked = notifs.new_appointment !== false;
          $('#notify-quote-accepted').checked = notifs.quote_accepted !== false;
          $('#notify-quote-declined').checked = notifs.quote_declined !== false;
          $('#notify-quote-viewed').checked = notifs.quote_viewed !== false;
          $('#notify-invoice-viewed').checked = notifs.invoice_viewed !== false;
          $('#notify-payment-received').checked = notifs.payment_received !== false;
          $('#notify-customer-upload').checked = notifs.customer_upload !== false;
          $('#notify-job-stage-changed').checked = notifs.job_stage_changed === true;
        }
        
        if (settings.terms_and_conditions) {
          const terms = settings.terms_and_conditions;
          if (terms.quote) $('#quote-terms').value = terms.quote;
          if (terms.invoice) $('#invoice-terms').value = terms.invoice;
        }
        
      } catch (err) {
        console.error('Load settings error:', err);
        showToast('Failed to load settings', 'error');
      }
    }
    
    async function saveSetting(key, value) {
      try {
        const supabase = await app.waitForSupabase();
        
        const { error } = await supabase
          .from('settings')
          .upsert({ key, value }, { onConflict: 'key' });
        
        if (error) throw error;
        showToast('Settings saved', 'success');
      } catch (err) {
        console.error('Save error:', err);
        showToast('Failed to save: ' + err.message, 'error');
      }
    }
    
    async function saveTerms() {
      const value = {
        quote: $('#quote-terms').value,
        invoice: $('#invoice-terms').value
      };
      await saveSetting('terms_and_conditions', value);
    }
    
    // Company form
    $('#company-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const value = {
        name: $('#company-name').value,
        email: $('#company-email').value,
        phone: $('#company-phone').value,
        website: $('#company-website').value,
        address: $('#company-address').value,
        city: $('#company-city').value,
        state: $('#company-state').value,
        zip: $('#company-zip').value
      };
      await saveSetting('company', value);
      
      // Also save branding
      const branding = {
        tagline: $('#company-tagline').value,
        color: $('#brand-color').value
      };
      await saveSetting('branding', branding);
    });
    
    // Quote settings form
    $('#quote-settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const value = {
        default_valid_days: parseInt($('#default-valid-days').value) || 30,
        default_tax_rate: parseFloat($('#default-tax-rate').value) || 6.25,
        default_deposit: parseInt($('#default-deposit').value) || 50
      };
      await saveSetting('quotes', value);
    });
    
    // Invoice settings form
    $('#invoice-settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const value = {
        default_payment_terms: parseInt($('#default-payment-terms').value) || 30,
        late_fee_percent: parseFloat($('#late-fee-percent').value) || 0
      };
      await saveSetting('invoices', value);
    });
    
    // Notification form
    $('#notification-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const value = {
        new_appointment: $('#notify-new-appointment').checked,
        quote_accepted: $('#notify-quote-accepted').checked,
        quote_declined: $('#notify-quote-declined').checked,
        quote_viewed: $('#notify-quote-viewed').checked,
        invoice_viewed: $('#notify-invoice-viewed').checked,
        payment_received: $('#notify-payment-received').checked,
        customer_upload: $('#notify-customer-upload').checked,
        job_stage_changed: $('#notify-job-stage-changed').checked
      };
      await saveSetting('notifications', value);
    });
    
    // Lead Sources Management
    let leadSources = [];
    
    async function loadLeadSources() {
      try {
        const supabase = await app.waitForSupabase();
        const { data, error } = await supabase
          .from('lead_sources')
          .select('*')
          .order('sort_order');
        
        if (error) throw error;
        leadSources = data || [];
        renderLeadSources();
      } catch (err) {
        console.error('Failed to load lead sources:', err);
        $('#lead-sources-list').innerHTML = '<p class="text-muted">Failed to load lead sources</p>';
      }
    }
    
    function renderLeadSources() {
      const container = $('#lead-sources-list');
      
      if (leadSources.length === 0) {
        container.innerHTML = '<p class="text-muted">No lead sources defined. Click "Add Source" to create one.</p>';
        return;
      }
      
      container.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
          ${leadSources.map(ls => `
            <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-sm) var(--space-md); background: var(--color-bg-soft); border-radius: var(--radius-md);">
              <span style="flex: 1; font-weight: 500;">${ls.name}</span>
              <label style="display: flex; align-items: center; gap: var(--space-xs); font-size: 0.75rem; color: var(--color-text-muted);">
                <input type="checkbox" ${ls.is_active ? 'checked' : ''} onchange="toggleLeadSource('${ls.id}', this.checked)">
                Active
              </label>
              <button class="btn btn-ghost btn-sm" onclick="editLeadSource('${ls.id}')">Edit</button>
              <button class="btn btn-ghost btn-sm text-danger" onclick="deleteLeadSource('${ls.id}')">√ó</button>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    window.addLeadSource = async () => {
      const name = prompt('Enter lead source name:');
      if (!name?.trim()) return;
      
      try {
        const supabase = await app.waitForSupabase();
        const maxOrder = Math.max(...leadSources.map(ls => ls.sort_order || 0), 0);
        
        const { error } = await supabase
          .from('lead_sources')
          .insert({ name: name.trim(), sort_order: maxOrder + 1 });
        
        if (error) throw error;
        showToast('Lead source added', 'success');
        loadLeadSources();
      } catch (err) {
        showToast('Failed to add: ' + err.message, 'error');
      }
    };
    
    window.editLeadSource = async (id) => {
      const ls = leadSources.find(l => l.id === id);
      if (!ls) return;
      
      const newName = prompt('Edit lead source name:', ls.name);
      if (!newName?.trim() || newName === ls.name) return;
      
      try {
        const supabase = await app.waitForSupabase();
        const { error } = await supabase
          .from('lead_sources')
          .update({ name: newName.trim() })
          .eq('id', id);
        
        if (error) throw error;
        showToast('Lead source updated', 'success');
        loadLeadSources();
      } catch (err) {
        showToast('Failed to update: ' + err.message, 'error');
      }
    };
    
    window.toggleLeadSource = async (id, isActive) => {
      try {
        const supabase = await app.waitForSupabase();
        const { error } = await supabase
          .from('lead_sources')
          .update({ is_active: isActive })
          .eq('id', id);
        
        if (error) throw error;
      } catch (err) {
        showToast('Failed to update: ' + err.message, 'error');
        loadLeadSources(); // Revert UI
      }
    };
    
    window.deleteLeadSource = async (id) => {
      if (!confirm('Delete this lead source?')) return;
      
      try {
        const supabase = await app.waitForSupabase();
        const { error } = await supabase
          .from('lead_sources')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        showToast('Lead source deleted', 'success');
        loadLeadSources();
      } catch (err) {
        showToast('Failed to delete: ' + err.message, 'error');
      }
    };
    
    // ==========================================
    // APPOINTMENT TYPES MANAGEMENT
    // ==========================================
    let appointmentTypes = [];
    const defaultIcons = ['üìÖ', 'üìè', 'üè†', 'üëÅÔ∏è', '‚úÖ', 'üîç', 'üí∞', 'üöö', 'üìû', 'üî®', '‚≠ê', 'üìã'];
    const defaultColors = ['#6366f1', '#8b5cf6', '#3b82f6', '#06b6d4', '#10b981', '#f59e0b', '#f97316', '#ec4899', '#64748b'];
    
    async function loadAppointmentTypes() {
      try {
        const supabase = await app.waitForSupabase();
        const { data, error } = await supabase
          .from('appointment_types')
          .select('*')
          .order('sort_order');
        
        if (error) throw error;
        appointmentTypes = data || [];
        renderAppointmentTypes();
      } catch (err) {
        console.error('Failed to load appointment types:', err);
        $('#appointment-types-list').innerHTML = '<p class="text-muted">Failed to load appointment types</p>';
      }
    }
    
    function renderAppointmentTypes() {
      const container = $('#appointment-types-list');
      
      if (appointmentTypes.length === 0) {
        container.innerHTML = '<p class="text-muted">No appointment types defined. Click "Add Type" to create one.</p>';
        return;
      }
      
      container.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
          ${appointmentTypes.map(at => `
            <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-sm) var(--space-md); background: var(--color-bg-soft); border-radius: var(--radius-md);">
              <span style="font-size: 1.25rem;">${at.icon || 'üìÖ'}</span>
              <span style="flex: 1; font-weight: 500;">${at.name}</span>
              <span style="width: 20px; height: 20px; border-radius: 4px; background: ${at.color || '#6366f1'};"></span>
              <label style="display: flex; align-items: center; gap: var(--space-xs); font-size: 0.75rem; color: var(--color-text-muted);">
                <input type="checkbox" ${at.is_active ? 'checked' : ''} onchange="toggleAppointmentType('${at.id}', this.checked)">
                Active
              </label>
              <button class="btn btn-ghost btn-sm" onclick="editAppointmentType('${at.id}')">Edit</button>
              <button class="btn btn-ghost btn-sm text-danger" onclick="deleteAppointmentType('${at.id}')">√ó</button>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    window.addAppointmentType = () => showAppointmentTypeModal();
    
    window.editAppointmentType = (id) => {
      const at = appointmentTypes.find(t => t.id === id);
      if (at) showAppointmentTypeModal(at);
    };
    
    function showAppointmentTypeModal(apptType = null) {
      const isEdit = !!apptType;
      
      const content = createElement('div');
      content.innerHTML = `
        <div class="form-group">
          <label class="form-label">Name *</label>
          <input type="text" id="at-name" class="form-input" value="${apptType?.name || ''}" placeholder="e.g., Site Visit">
        </div>
        <div class="form-group">
          <label class="form-label">Icon</label>
          <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs); margin-bottom: var(--space-sm);">
            ${defaultIcons.map(icon => `
              <button type="button" class="btn btn-ghost" style="font-size: 1.25rem; padding: 8px; ${apptType?.icon === icon ? 'outline: 2px solid var(--color-primary);' : ''}" 
                onclick="$('#at-icon').value='${icon}'; this.parentElement.querySelectorAll('button').forEach(b => b.style.outline=''); this.style.outline='2px solid var(--color-primary)';">
                ${icon}
              </button>
            `).join('')}
          </div>
          <input type="text" id="at-icon" class="form-input" value="${apptType?.icon || 'üìÖ'}" placeholder="Emoji icon" style="width: 80px;">
        </div>
        <div class="form-group">
          <label class="form-label">Color</label>
          <div style="display: flex; flex-wrap: wrap; gap: var(--space-xs); margin-bottom: var(--space-sm);">
            ${defaultColors.map(color => `
              <button type="button" style="width: 32px; height: 32px; border-radius: 6px; background: ${color}; border: 2px solid ${apptType?.color === color ? 'var(--color-text)' : 'transparent'}; cursor: pointer;"
                onclick="$('#at-color').value='${color}'; this.parentElement.querySelectorAll('button').forEach(b => b.style.borderColor='transparent'); this.style.borderColor='var(--color-text)';">
              </button>
            `).join('')}
          </div>
          <input type="color" id="at-color" value="${apptType?.color || '#6366f1'}" style="width: 60px; height: 38px;">
        </div>
      `;
      
      const footer = createElement('div', { className: 'flex justify-end gap-md' });
      const cancelBtn = createElement('button', { className: 'btn btn-secondary', textContent: 'Cancel' });
      const saveBtn = createElement('button', { className: 'btn btn-primary', textContent: isEdit ? 'Save Changes' : 'Add Type' });
      footer.appendChild(cancelBtn);
      footer.appendChild(saveBtn);
      
      const modal = createModal({
        title: isEdit ? 'Edit Appointment Type' : 'Add Appointment Type',
        content,
        footer
      });
      
      cancelBtn.onclick = () => closeModal(modal);
      saveBtn.onclick = async () => {
        const name = $('#at-name').value.trim();
        const icon = $('#at-icon').value.trim() || 'üìÖ';
        const color = $('#at-color').value;
        
        if (!name) {
          showToast('Name is required', 'error');
          return;
        }
        
        try {
          const supabase = await app.waitForSupabase();
          
          if (isEdit) {
            await supabase.from('appointment_types').update({ name, icon, color }).eq('id', apptType.id);
            showToast('Appointment type updated', 'success');
          } else {
            const maxOrder = Math.max(...appointmentTypes.map(t => t.sort_order || 0), 0);
            await supabase.from('appointment_types').insert({ name, icon, color, sort_order: maxOrder + 1 });
            showToast('Appointment type added', 'success');
          }
          
          closeModal(modal);
          loadAppointmentTypes();
        } catch (err) {
          showToast('Failed to save: ' + err.message, 'error');
        }
      };
    }
    
    window.toggleAppointmentType = async (id, isActive) => {
      try {
        const supabase = await app.waitForSupabase();
        await supabase.from('appointment_types').update({ is_active: isActive }).eq('id', id);
      } catch (err) {
        showToast('Failed to update: ' + err.message, 'error');
        loadAppointmentTypes();
      }
    };
    
    window.deleteAppointmentType = async (id) => {
      if (!confirm('Delete this appointment type?')) return;
      
      try {
        const supabase = await app.waitForSupabase();
        await supabase.from('appointment_types').delete().eq('id', id);
        showToast('Appointment type deleted', 'success');
        loadAppointmentTypes();
      } catch (err) {
        showToast('Failed to delete: ' + err.message, 'error');
      }
    };
    
    // ==========================================
    // USER MANAGEMENT
    // ==========================================
    let appUsers = [];
    let appRoles = [];
    
    async function loadRoles() {
      try {
        const supabase = await app.waitForSupabase();
        const { data, error } = await supabase
          .from('app_roles')
          .select('*')
          .order('sort_order');
        
        if (error) throw error;
        appRoles = data || [];
        renderRoles();
      } catch (err) {
        console.error('Failed to load roles:', err);
        $('#roles-list').innerHTML = '<p class="text-muted">Failed to load roles</p>';
      }
    }
    
    async function loadUsers() {
      try {
        const supabase = await app.waitForSupabase();
        const { data, error } = await supabase
          .from('app_users')
          .select('*, app_roles(name)')
          .order('name');
        
        if (error) throw error;
        appUsers = data || [];
        renderUsers();
      } catch (err) {
        console.error('Failed to load users:', err);
        $('#users-list').innerHTML = '<p class="text-muted">Failed to load users</p>';
      }
    }
    
    function renderUsers() {
      const container = $('#users-list');
      
      if (appUsers.length === 0) {
        container.innerHTML = '<p class="text-muted">No users found. Click "Add User" to create one.</p>';
        return;
      }
      
      container.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
          ${appUsers.map(user => `
            <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-sm) var(--space-md); background: var(--color-bg-soft); border-radius: var(--radius-md);">
              <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--color-primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                ${user.name.charAt(0).toUpperCase()}
              </div>
              <span style="flex: 1; font-weight: 500;">${user.name}</span>
              <span class="badge badge-info">${user.app_roles?.name || 'No Role'}</span>
              ${user.last_login ? `<span style="font-size: 0.75rem; color: var(--color-text-muted);">Last login: ${formatDate(user.last_login)}</span>` : ''}
              <label style="display: flex; align-items: center; gap: var(--space-xs); font-size: 0.75rem; color: var(--color-text-muted);">
                <input type="checkbox" ${user.is_active ? 'checked' : ''} onchange="toggleUser('${user.id}', this.checked)">
                Active
              </label>
              <button class="btn btn-ghost btn-sm" onclick="editUser('${user.id}')">Edit</button>
              <button class="btn btn-ghost btn-sm text-danger" onclick="deleteUser('${user.id}')">√ó</button>
            </div>
          `).join('')}
        </div>
      `;
    }
    
    function renderRoles() {
      const container = $('#roles-list');
      
      if (appRoles.length === 0) {
        container.innerHTML = '<p class="text-muted">No roles found. Click "Add Role" to create one.</p>';
        return;
      }
      
      const permissionLabels = {
        can_access_settings: 'Settings',
        can_view_financials: 'Financials',
        can_delete: 'Delete',
        can_manage_users: 'Users',
        can_view_pipeline: 'View Pipeline',
        can_edit_pipeline: 'Edit Pipeline',
        can_view_customers: 'View Customers',
        can_edit_customers: 'Edit Customers',
        can_view_quotes: 'View Quotes',
        can_edit_quotes: 'Edit Quotes',
        can_view_invoices: 'View Invoices',
        can_send_invoices: 'Send Invoices'
      };
      
      container.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: var(--space-sm);">
          ${appRoles.map(role => {
            const permissions = Object.entries(permissionLabels)
              .filter(([key]) => role[key])
              .map(([, label]) => label);
            
            return `
              <div style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); background: var(--color-bg-soft); border-radius: var(--radius-md);">
                <div style="flex: 1;">
                  <div style="font-weight: 600;">${role.name} ${role.is_system ? '<span style="font-size: 0.7rem; color: var(--color-text-muted);">(System)</span>' : ''}</div>
                  <div style="font-size: 0.75rem; color: var(--color-text-muted); margin-top: 2px;">
                    ${permissions.length > 0 ? permissions.join(' ‚Ä¢ ') : 'No permissions'}
                  </div>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="editRole('${role.id}')">Edit</button>
                ${!role.is_system ? `<button class="btn btn-ghost btn-sm text-danger" onclick="deleteRole('${role.id}')">√ó</button>` : ''}
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    window.addUser = () => showUserModal();
    
    window.editUser = (id) => {
      const user = appUsers.find(u => u.id === id);
      if (user) showUserModal(user);
    };
    
    function showUserModal(user = null) {
      const isEdit = !!user;
      
      const roleOptions = appRoles.map(r => 
        `<option value="${r.id}" ${user?.role_id === r.id ? 'selected' : ''}>${r.name}</option>`
      ).join('');
      
      const content = createElement('div');
      content.innerHTML = `
        <div class="form-group">
          <label class="form-label">Name *</label>
          <input type="text" id="user-name" class="form-input" value="${user?.name || ''}" placeholder="e.g., John Smith">
        </div>
        <div class="form-group">
          <label class="form-label">${isEdit ? 'New PIN (leave blank to keep current)' : 'PIN *'}</label>
          <input type="password" id="user-pin" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="10">
          <div class="form-help">4-10 digit PIN for login</div>
        </div>
        <div class="form-group">
          <label class="form-label">Role *</label>
          <select id="user-role" class="form-select">
            <option value="">-- Select Role --</option>
            ${roleOptions}
          </select>
        </div>
      `;
      
      const footer = createElement('div', { className: 'flex justify-end gap-md' });
      const cancelBtn = createElement('button', { className: 'btn btn-secondary', textContent: 'Cancel' });
      const saveBtn = createElement('button', { className: 'btn btn-primary', textContent: isEdit ? 'Save Changes' : 'Add User' });
      footer.appendChild(cancelBtn);
      footer.appendChild(saveBtn);
      
      const modal = createModal({
        title: isEdit ? 'Edit User' : 'Add User',
        content,
        footer
      });
      
      cancelBtn.onclick = () => closeModal(modal);
      saveBtn.onclick = async () => {
        const name = $('#user-name').value.trim();
        const pin = $('#user-pin').value.trim();
        const role_id = $('#user-role').value;
        
        if (!name) {
          showToast('Name is required', 'error');
          return;
        }
        
        if (!isEdit && !pin) {
          showToast('PIN is required', 'error');
          return;
        }
        
        if (pin && (pin.length < 4 || !/^\d+$/.test(pin))) {
          showToast('PIN must be 4-10 digits', 'error');
          return;
        }
        
        if (!role_id) {
          showToast('Role is required', 'error');
          return;
        }
        
        try {
          const supabase = await app.waitForSupabase();
          const data = { name, role_id };
          if (pin) data.pin = pin;
          
          if (isEdit) {
            await supabase.from('app_users').update(data).eq('id', user.id);
            showToast('User updated', 'success');
          } else {
            data.pin = pin;
            await supabase.from('app_users').insert(data);
            showToast('User added', 'success');
          }
          
          closeModal(modal);
          loadUsers();
        } catch (err) {
          showToast('Failed to save: ' + err.message, 'error');
        }
      };
    }
    
    window.toggleUser = async (id, isActive) => {
      const currentUser = getCurrentUser();
      if (currentUser?.id === id && !isActive) {
        showToast('Cannot deactivate your own account', 'error');
        loadUsers();
        return;
      }
      
      try {
        const supabase = await app.waitForSupabase();
        await supabase.from('app_users').update({ is_active: isActive }).eq('id', id);
      } catch (err) {
        showToast('Failed to update: ' + err.message, 'error');
        loadUsers();
      }
    };
    
    window.deleteUser = async (id) => {
      const currentUser = getCurrentUser();
      if (currentUser?.id === id) {
        showToast('Cannot delete your own account', 'error');
        return;
      }
      
      if (!confirm('Delete this user?')) return;
      
      try {
        const supabase = await app.waitForSupabase();
        await supabase.from('app_users').delete().eq('id', id);
        showToast('User deleted', 'success');
        loadUsers();
      } catch (err) {
        showToast('Failed to delete: ' + err.message, 'error');
      }
    };
    
    // ==========================================
    // ROLES MANAGEMENT
    // ==========================================
    
    window.addRole = () => showRoleModal();
    
    window.editRole = (id) => {
      const role = appRoles.find(r => r.id === id);
      if (role) showRoleModal(role);
    };
    
    function showRoleModal(role = null) {
      const isEdit = !!role;
      
      const permissions = [
        { key: 'can_access_settings', label: 'Access Settings', desc: 'Can view and modify system settings', section: 'Admin' },
        { key: 'can_view_financials', label: 'View Financials', desc: 'Can see payment info, balances, totals', section: 'Admin' },
        { key: 'can_delete', label: 'Delete Items', desc: 'Can delete customers, quotes, jobs, etc.', section: 'Admin' },
        { key: 'can_manage_users', label: 'Manage Users', desc: 'Can add/edit/remove users and roles', section: 'Admin' },
        { key: 'can_view_pipeline', label: 'View Pipeline', desc: 'Can see the deals pipeline page', section: 'Pipeline' },
        { key: 'can_edit_pipeline', label: 'Edit Pipeline', desc: 'Can manage deals and job status', section: 'Pipeline' },
        { key: 'can_view_customers', label: 'View Customers', desc: 'Can see the customers page', section: 'Customers' },
        { key: 'can_edit_customers', label: 'Edit Customers', desc: 'Can add and edit customer info', section: 'Customers' },
        { key: 'can_view_quotes', label: 'View Quotes', desc: 'Can see quotes and catalog pages', section: 'Quotes' },
        { key: 'can_edit_quotes', label: 'Edit Quotes', desc: 'Can create and edit quotes', section: 'Quotes' },
        { key: 'can_view_invoices', label: 'View Invoices', desc: 'Can see the invoices page', section: 'Invoices' },
        { key: 'can_send_invoices', label: 'Send Invoices', desc: 'Can create and send invoices', section: 'Invoices' }
      ];
      
      // Group permissions by section
      const sections = {};
      permissions.forEach(p => {
        if (!sections[p.section]) sections[p.section] = [];
        sections[p.section].push(p);
      });
      
      const content = createElement('div');
      content.innerHTML = `
        <div class="form-group">
          <label class="form-label">Role Name *</label>
          <input type="text" id="role-name" class="form-input" value="${role?.name || ''}" placeholder="e.g., Sales Rep" ${role?.is_system ? 'readonly style="background: var(--color-bg-soft);"' : ''}>
          ${role?.is_system ? '<div class="form-help">System roles cannot be renamed</div>' : ''}
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <input type="text" id="role-desc" class="form-input" value="${role?.description || ''}" placeholder="Brief description of this role">
        </div>
        <div class="form-group">
          <label class="form-label">Permissions</label>
          ${Object.entries(sections).map(([section, perms]) => `
            <div style="margin-top: var(--space-md);">
              <div style="font-size: 0.75rem; font-weight: 600; color: var(--color-text-muted); margin-bottom: var(--space-xs); text-transform: uppercase;">${section}</div>
              <div style="display: flex; flex-direction: column; gap: var(--space-xs);">
                ${perms.map(p => `
                  <label style="display: flex; align-items: flex-start; gap: var(--space-sm); padding: var(--space-sm); background: var(--color-bg-soft); border-radius: var(--radius-sm); cursor: pointer;">
                    <input type="checkbox" id="perm-${p.key}" ${role?.[p.key] ? 'checked' : ''} style="margin-top: 3px;">
                    <div>
                      <div style="font-weight: 500;">${p.label}</div>
                      <div style="font-size: 0.75rem; color: var(--color-text-muted);">${p.desc}</div>
                    </div>
                  </label>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      const footer = createElement('div', { className: 'flex justify-end gap-md' });
      const cancelBtn = createElement('button', { className: 'btn btn-secondary', textContent: 'Cancel' });
      const saveBtn = createElement('button', { className: 'btn btn-primary', textContent: isEdit ? 'Save Changes' : 'Add Role' });
      footer.appendChild(cancelBtn);
      footer.appendChild(saveBtn);
      
      const modal = createModal({
        title: isEdit ? 'Edit Role' : 'Add Role',
        content,
        footer,
        size: 'lg'
      });
      
      cancelBtn.onclick = () => closeModal(modal);
      saveBtn.onclick = async () => {
        const name = $('#role-name').value.trim();
        const description = $('#role-desc').value.trim();
        
        if (!name) {
          showToast('Role name is required', 'error');
          return;
        }
        
        const data = {
          name: role?.is_system ? role.name : name,
          description,
          can_access_settings: $('#perm-can_access_settings').checked,
          can_view_financials: $('#perm-can_view_financials').checked,
          can_delete: $('#perm-can_delete').checked,
          can_manage_users: $('#perm-can_manage_users').checked,
          can_view_pipeline: $('#perm-can_view_pipeline').checked,
          can_edit_pipeline: $('#perm-can_edit_pipeline').checked,
          can_view_customers: $('#perm-can_view_customers').checked,
          can_edit_customers: $('#perm-can_edit_customers').checked,
          can_view_quotes: $('#perm-can_view_quotes').checked,
          can_edit_quotes: $('#perm-can_edit_quotes').checked,
          can_view_invoices: $('#perm-can_view_invoices').checked,
          can_send_invoices: $('#perm-can_send_invoices').checked
        };
        
        try {
          const supabase = await app.waitForSupabase();
          
          if (isEdit) {
            await supabase.from('app_roles').update(data).eq('id', role.id);
            showToast('Role updated', 'success');
          } else {
            const maxOrder = Math.max(...appRoles.map(r => r.sort_order || 0), 0);
            data.sort_order = maxOrder + 1;
            await supabase.from('app_roles').insert(data);
            showToast('Role added', 'success');
          }
          
          closeModal(modal);
          loadRoles();
        } catch (err) {
          showToast('Failed to save: ' + err.message, 'error');
        }
      };
    }
    
    window.deleteRole = async (id) => {
      const role = appRoles.find(r => r.id === id);
      if (role?.is_system) {
        showToast('Cannot delete system roles', 'error');
        return;
      }
      
      // Check if any users have this role
      const usersWithRole = appUsers.filter(u => u.role_id === id);
      if (usersWithRole.length > 0) {
        showToast(`Cannot delete: ${usersWithRole.length} user(s) have this role`, 'error');
        return;
      }
      
      if (!confirm('Delete this role?')) return;
      
      try {
        const supabase = await app.waitForSupabase();
        await supabase.from('app_roles').delete().eq('id', id);
        showToast('Role deleted', 'success');
        loadRoles();
      } catch (err) {
        showToast('Failed to delete: ' + err.message, 'error');
      }
    };
    
    // Initialize - load all data in parallel
    async function initSettings() {
      const supabase = await app.waitForSupabase();
      
      // Load all data in parallel
      const [settingsRes, leadSourcesRes, apptTypesRes, rolesRes, usersRes] = await Promise.all([
        supabase.from('settings').select('*'),
        supabase.from('lead_sources').select('*').order('sort_order'),
        supabase.from('appointment_types').select('*').order('sort_order'),
        supabase.from('app_roles').select('*').order('sort_order'),
        supabase.from('app_users').select('*, app_roles(name)').order('name')
      ]);
      
      // Process settings
      if (settingsRes.data) {
        settingsRes.data.forEach(s => {
          const input = document.getElementById(s.key);
          if (input) {
            if (input.type === 'checkbox') input.checked = s.value === 'true';
            else input.value = s.value || '';
          }
        });
      }
      
      // Process lead sources
      leadSources = leadSourcesRes.data || [];
      renderLeadSources();
      
      // Process appointment types
      appointmentTypes = apptTypesRes.data || [];
      renderAppointmentTypes();
      
      // Process roles
      appRoles = rolesRes.data || [];
      renderRoles();
      
      // Process users
      appUsers = usersRes.data || [];
      renderUsers();
    }
    
    initSettings();
  </script>
</body>
</html>
