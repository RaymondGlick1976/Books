<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking Forms | Admin | Homestead Cabinet Design</title>
  <link rel="stylesheet" href="/css/styles.css?v=34">
  <style>
    .forms-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl); }
    .form-row { display: flex; align-items: center; padding: var(--space-md); background: white; border: 1px solid var(--color-border); border-radius: var(--radius-md); margin-bottom: var(--space-sm); }
    .form-row:hover { border-color: var(--color-primary); }
    .form-name { font-weight: 600; flex: 1; }
    .form-stats { color: var(--color-text-muted); font-size: 0.875rem; margin-right: var(--space-lg); }
    .form-link { color: var(--color-primary); font-size: 0.875rem; margin-right: var(--space-lg); display: flex; align-items: center; gap: var(--space-xs); }
    .form-link a { color: inherit; text-decoration: none; }
    .form-link a:hover { text-decoration: underline; }
    .form-actions { display: flex; gap: var(--space-sm); }
    .copy-btn { cursor: pointer; padding: 4px; border-radius: var(--radius-sm); }
    .copy-btn:hover { background: var(--color-bg-soft); }
    
    /* Builder styles */
    .builder-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-xl); }
    @media (max-width: 1200px) { .builder-grid { grid-template-columns: 1fr; } }
    .preview-frame { background: var(--color-bg-soft); border-radius: var(--radius-lg); padding: var(--space-lg); min-height: 600px; }
    .preview-header { text-align: center; margin-bottom: var(--space-xl); }
    .preview-title { font-size: 1.5rem; font-weight: 600; color: var(--color-primary); margin-bottom: var(--space-sm); }
    .preview-desc { color: var(--color-text-muted); }
    .preview-form { background: white; padding: var(--space-xl); border-radius: var(--radius-lg); border: 1px solid var(--color-border); }
    
    .question-item { display: flex; align-items: center; gap: var(--space-sm); padding: var(--space-sm); background: var(--color-bg-soft); border-radius: var(--radius-md); margin-bottom: var(--space-sm); }
    .question-drag { cursor: grab; color: var(--color-text-muted); }
    .question-prompt { flex: 1; font-size: 0.875rem; }
    .question-type { font-size: 0.75rem; color: var(--color-text-muted); background: white; padding: 2px 8px; border-radius: var(--radius-sm); }
    .question-required { font-size: 0.75rem; color: var(--color-danger); }
    
    .embed-code { background: var(--color-bg-soft); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-md); font-family: monospace; font-size: 0.8rem; white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto; }
    
    .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm) 0; border-bottom: 1px solid var(--color-border-light); }
    .toggle-row:last-child { border-bottom: none; }
    .toggle-label { font-size: 0.875rem; }
    
    .tabs { display: flex; gap: var(--space-sm); border-bottom: 1px solid var(--color-border); margin-bottom: var(--space-lg); }
    .tab { padding: var(--space-sm) var(--space-md); cursor: pointer; border-bottom: 2px solid transparent; color: var(--color-text-muted); font-size: 0.875rem; }
    .tab:hover { color: var(--color-text); }
    .tab.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
  <div class="app-layout">
    <aside class="app-sidebar">
      <div class="sidebar-logo">
        <img src="/images/logo.gif" alt="Homestead Cabinet Design" style="height: 40px; filter: brightness(0) invert(1);">
      </div>
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item"><a href="/admin/index.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>Dashboard</a></li>
          <li class="sidebar-nav-item"><a href="/admin/pipeline.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>Deals Pipeline</a></li>
          <li class="sidebar-nav-item"><a href="/admin/customers.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Customers</a></li>
          <li class="sidebar-nav-item"><a href="/admin/quotes.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/></svg>Quotes</a></li>
          <li class="sidebar-nav-item"><a href="/admin/invoices.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/></svg>Invoices</a></li>
        </ul>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Lead Capture</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/booking-forms.html" class="sidebar-nav-link active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>Booking Forms</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Catalog</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/catalog.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>Items Catalog</a></li>
          </ul>
        </div>
        <div class="sidebar-section">
          <div class="sidebar-section-title">Settings</div>
          <ul class="sidebar-nav">
            <li class="sidebar-nav-item"><a href="/admin/settings.html" class="sidebar-nav-link"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg>Settings</a></li>
          </ul>
        </div>
      </nav>
    </aside>
    
    <main class="app-main">
      <!-- Forms List View -->
      <div id="list-view">
        <header class="app-header">
          <div class="forms-header">
            <div>
              <h2>Booking Forms</h2>
              <p class="text-muted">Create forms to capture leads from your website or share directly</p>
            </div>
            <button class="btn btn-primary" onclick="createNewForm()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
              Add Booking Form
            </button>
          </div>
        </header>
        
        <div class="app-content">
          <div class="card">
            <div class="card-body">
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Form Name</th>
                    <th>Total Submissions</th>
                    <th>Link to Booking Form</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="forms-table-body">
                  <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Form Builder View -->
      <div id="builder-view" style="display: none;">
        <header class="app-header">
          <div class="forms-header">
            <div>
              <button class="btn btn-secondary btn-sm" onclick="showListView()">‚Üê Back to Forms</button>
              <h2 id="builder-title" style="margin-top: var(--space-sm);">Edit Form</h2>
            </div>
            <div class="flex gap-sm">
              <button class="btn btn-secondary" onclick="previewForm()">Preview</button>
              <button class="btn btn-primary" onclick="saveForm()">Save Changes</button>
            </div>
          </div>
        </header>
        
        <div class="app-content">
          <div class="builder-grid">
            <!-- Settings Panel -->
            <div>
              <div class="card mb-lg">
                <div class="card-header"><h3 class="card-title">Form Settings</h3></div>
                <div class="card-body">
                  <input type="hidden" id="form-id">
                  <div class="form-group">
                    <label class="form-label">Form Name</label>
                    <input type="text" id="form-name" class="form-input" placeholder="e.g., Kitchen Consultation">
                  </div>
                  <div class="form-group">
                    <label class="form-label">URL Slug</label>
                    <div class="flex gap-sm items-center">
                      <span class="text-muted text-sm">/book/</span>
                      <input type="text" id="form-slug" class="form-input" placeholder="kitchen-consultation" style="flex:1;">
                    </div>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Header Title</label>
                    <input type="text" id="form-header-title" class="form-input" placeholder="Appointment Request">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Header Description</label>
                    <input type="text" id="form-header-desc" class="form-input" placeholder="Choose a phone call or in-home appointment">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Primary Color</label>
                    <input type="color" id="form-color" value="#6366f1" style="width: 60px; height: 38px;">
                  </div>
                </div>
              </div>
              
              <div class="card mb-lg">
                <div class="card-header"><h3 class="card-title">Field Visibility</h3></div>
                <div class="card-body">
                  <div class="toggle-row">
                    <span class="toggle-label">Show Address Fields</span>
                    <label class="toggle-switch"><input type="checkbox" id="show-address" checked><span class="toggle-slider"></span></label>
                  </div>
                  <div class="toggle-row">
                    <span class="toggle-label">Show Service Details</span>
                    <label class="toggle-switch"><input type="checkbox" id="show-service" checked><span class="toggle-slider"></span></label>
                  </div>
                  <div class="toggle-row">
                    <span class="toggle-label">Show "How did you hear about us?"</span>
                    <label class="toggle-switch"><input type="checkbox" id="show-how-heard" checked><span class="toggle-slider"></span></label>
                  </div>
                  <div class="toggle-row">
                    <span class="toggle-label">Show Date/Time Selection</span>
                    <label class="toggle-switch"><input type="checkbox" id="show-datetime"><span class="toggle-slider"></span></label>
                  </div>
                  <div class="toggle-row">
                    <span class="toggle-label">Allow Photo Attachments</span>
                    <label class="toggle-switch"><input type="checkbox" id="allow-attachments" checked><span class="toggle-slider"></span></label>
                  </div>
                  <div class="toggle-row">
                    <span class="toggle-label">Require Attachments</span>
                    <label class="toggle-switch"><input type="checkbox" id="require-attachments"><span class="toggle-slider"></span></label>
                  </div>
                  <div class="toggle-row">
                    <span class="toggle-label">Show SMS Consent</span>
                    <label class="toggle-switch"><input type="checkbox" id="show-sms" checked><span class="toggle-slider"></span></label>
                  </div>
                </div>
              </div>
              
              <div class="card mb-lg">
                <div class="card-header">
                  <h3 class="card-title">Custom Questions</h3>
                  <button class="btn btn-secondary btn-sm" onclick="openQuestionModal()">+ Add Question</button>
                </div>
                <div class="card-body">
                  <div id="questions-list">
                    <p class="text-muted text-sm">No custom questions added.</p>
                  </div>
                </div>
              </div>
              
              <div class="card mb-lg">
                <div class="card-header"><h3 class="card-title">Thank You Page</h3></div>
                <div class="card-body">
                  <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" id="thank-you-title" class="form-input" value="Thank You!">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea id="thank-you-message" class="form-input" rows="3">We have received your request and will contact you shortly.</textarea>
                  </div>
                </div>
              </div>
              
              <div class="card">
                <div class="card-header"><h3 class="card-title">Share & Embed</h3></div>
                <div class="card-body">
                  <div class="tabs">
                    <div class="tab active" data-tab="link">Direct Link</div>
                    <div class="tab" data-tab="embed">Embed Code</div>
                  </div>
                  
                  <div class="tab-content active" id="tab-link">
                    <div class="form-group">
                      <label class="form-label">Form URL</label>
                      <div class="flex gap-sm">
                        <input type="text" id="form-url" class="form-input" readonly style="flex:1;">
                        <button class="btn btn-secondary" onclick="copyFormUrl()">Copy</button>
                      </div>
                    </div>
                  </div>
                  
                  <div class="tab-content" id="tab-embed">
                    <div class="form-group">
                      <label class="form-label">Iframe Embed</label>
                      <div class="embed-code" id="embed-iframe"></div>
                      <button class="btn btn-secondary btn-sm mt-sm" onclick="copyEmbed('iframe')">Copy Code</button>
                    </div>
                    <div class="form-group mt-lg">
                      <label class="form-label">JavaScript Embed</label>
                      <div class="embed-code" id="embed-js"></div>
                      <button class="btn btn-secondary btn-sm mt-sm" onclick="copyEmbed('js')">Copy Code</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Preview Panel -->
            <div class="preview-frame">
              <div class="preview-header">
                <div class="preview-title" id="preview-title">Appointment Request</div>
                <div class="preview-desc" id="preview-desc">Choose a phone call or in-home appointment</div>
              </div>
              <div class="preview-form" id="preview-form">
                <!-- Preview rendered by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Question Modal -->
  <div id="question-modal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="question-modal-title">Add Question</h3>
        <button class="modal-close" onclick="closeQuestionModal()"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="question-id">
        <div class="form-group">
          <label class="form-label">Question/Prompt *</label>
          <input type="text" id="question-prompt" class="form-input" placeholder="e.g., Choose a Phone Call or In-home Consultation">
        </div>
        <div class="form-group">
          <label class="form-label">Field Type</label>
          <select id="question-type" class="form-input" onchange="toggleChoicesField()">
            <option value="text">Text Input</option>
            <option value="textarea">Text Area</option>
            <option value="dropdown">Dropdown</option>
            <option value="radio">Radio Buttons</option>
            <option value="checkbox">Checkbox</option>
          </select>
        </div>
        <div class="form-group" id="choices-group" style="display:none;">
          <label class="form-label">Choices (one per line)</label>
          <textarea id="question-choices" class="form-input" rows="4" placeholder="Phone Call&#10;In-home Consultation"></textarea>
        </div>
        <div class="form-group">
          <label class="form-check">
            <input type="checkbox" id="question-required" class="form-check-input">
            <span class="form-check-label">Required field</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeQuestionModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveQuestion()">Save Question</button>
      </div>
    </div>
  </div>
  
  <script src="/js/utils.js"></script>
  <script>
    let forms = [];
    let currentForm = null;
    let questions = [];
    const baseUrl = window.location.origin;
    
    async function init() {
      await loadForms();
      setupTabs();
    }
    
    async function loadForms() {
      try {
        const supabase = await app.waitForSupabase();
        const { data, error } = await supabase.from('booking_forms').select('*').order('created_at');
        if (error) throw error;
        forms = data || [];
        renderFormsList();
      } catch (err) {
        console.error(err);
        showToast('Failed to load forms', 'error');
      }
    }
    
    function renderFormsList() {
      const tbody = $('#forms-table-body');
      if (forms.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No forms yet. Click "Add Booking Form" to create one.</td></tr>';
        return;
      }
      tbody.innerHTML = forms.map(f => `
        <tr>
          <td><strong>${f.name}</strong></td>
          <td>${f.submission_count || 0}</td>
          <td>
            <div class="form-link">
              <a href="/book/${f.slug}" target="_blank">${window.location.host}/book/${f.slug}</a>
              <span class="copy-btn" onclick="copyLink('${f.slug}')" title="Copy link">üìã</span>
            </div>
          </td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="editForm('${f.id}')">Edit</button>
            <button class="btn btn-sm btn-secondary" onclick="deleteForm('${f.id}')" style="color:var(--color-danger);">Delete</button>
          </td>
        </tr>
      `).join('');
    }
    
    function copyLink(slug) {
      navigator.clipboard.writeText(`${baseUrl}/book/${slug}`);
      showToast('Link copied!', 'success');
    }
    
    async function createNewForm() {
      const name = prompt('Form name:', 'New Form');
      if (!name) return;
      
      const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '');
      
      try {
        const supabase = await app.waitForSupabase();
        const { data, error } = await supabase.from('booking_forms').insert([{ name, slug }]).select().single();
        if (error) throw error;
        
        await loadForms();
        editForm(data.id);
        showToast('Form created', 'success');
      } catch (err) {
        console.error(err);
        showToast('Failed to create form: ' + err.message, 'error');
      }
    }
    
    async function editForm(id) {
      currentForm = forms.find(f => f.id === id);
      if (!currentForm) return;
      
      // Load questions
      try {
        const supabase = await app.waitForSupabase();
        const { data } = await supabase.from('booking_form_questions').select('*').eq('form_id', id).order('sort_order');
        questions = data || [];
      } catch (err) {
        questions = [];
      }
      
      // Populate form
      $('#form-id').value = currentForm.id;
      $('#form-name').value = currentForm.name;
      $('#form-slug').value = currentForm.slug;
      $('#form-header-title').value = currentForm.header_title || '';
      $('#form-header-desc').value = currentForm.header_description || '';
      $('#form-color').value = currentForm.primary_color || '#6366f1';
      $('#show-address').checked = currentForm.show_address !== false;
      $('#show-service').checked = currentForm.show_service_details !== false;
      $('#show-how-heard').checked = currentForm.show_how_heard !== false;
      $('#show-datetime').checked = currentForm.show_date_time === true;
      $('#allow-attachments').checked = currentForm.allow_attachments !== false;
      $('#require-attachments').checked = currentForm.attachments_required === true;
      $('#show-sms').checked = currentForm.show_sms_consent !== false;
      $('#thank-you-title').value = currentForm.thank_you_title || 'Thank You!';
      $('#thank-you-message').value = currentForm.thank_you_message || '';
      
      updateEmbedCodes();
      renderQuestions();
      updatePreview();
      
      $('#builder-title').textContent = `Edit: ${currentForm.name}`;
      $('#list-view').style.display = 'none';
      $('#builder-view').style.display = 'block';
    }
    
    function showListView() {
      $('#list-view').style.display = 'block';
      $('#builder-view').style.display = 'none';
      loadForms();
    }
    
    async function saveForm() {
      const id = $('#form-id').value;
      const data = {
        name: $('#form-name').value,
        slug: $('#form-slug').value,
        header_title: $('#form-header-title').value,
        header_description: $('#form-header-desc').value,
        primary_color: $('#form-color').value,
        show_address: $('#show-address').checked,
        show_service_details: $('#show-service').checked,
        show_how_heard: $('#show-how-heard').checked,
        show_date_time: $('#show-datetime').checked,
        allow_attachments: $('#allow-attachments').checked,
        attachments_required: $('#require-attachments').checked,
        show_sms_consent: $('#show-sms').checked,
        thank_you_title: $('#thank-you-title').value,
        thank_you_message: $('#thank-you-message').value,
        updated_at: new Date().toISOString()
      };
      
      try {
        const supabase = await app.waitForSupabase();
        await supabase.from('booking_forms').update(data).eq('id', id);
        currentForm = { ...currentForm, ...data };
        updateEmbedCodes();
        showToast('Form saved', 'success');
      } catch (err) {
        console.error(err);
        showToast('Failed to save form', 'error');
      }
    }
    
    async function deleteForm(id) {
      if (!confirm('Delete this form and all its submissions?')) return;
      try {
        const supabase = await app.waitForSupabase();
        await supabase.from('booking_forms').delete().eq('id', id);
        await loadForms();
        showToast('Form deleted', 'success');
      } catch (err) {
        showToast('Failed to delete', 'error');
      }
    }
    
    function updateEmbedCodes() {
      const url = `${baseUrl}/book/${currentForm.slug}`;
      $('#form-url').value = url;
      $('#embed-iframe').textContent = `<iframe src="${url}" width="100%" height="800" frameborder="0"></iframe>`;
      $('#embed-js').textContent = `<div id="hcd-booking-form"></div>\n<script src="${baseUrl}/js/booking-embed.js" data-form="${currentForm.slug}"><\/script>`;
    }
    
    function copyFormUrl() {
      navigator.clipboard.writeText($('#form-url').value);
      showToast('URL copied!', 'success');
    }
    
    function copyEmbed(type) {
      const code = type === 'iframe' ? $('#embed-iframe').textContent : $('#embed-js').textContent;
      navigator.clipboard.writeText(code);
      showToast('Code copied!', 'success');
    }
    
    // Questions
    function renderQuestions() {
      const list = $('#questions-list');
      if (questions.length === 0) {
        list.innerHTML = '<p class="text-muted text-sm">No custom questions added.</p>';
        return;
      }
      list.innerHTML = questions.map(q => `
        <div class="question-item">
          <span class="question-drag">‚ò∞</span>
          <span class="question-prompt">${q.prompt}</span>
          <span class="question-type">${q.field_type}</span>
          ${q.is_required ? '<span class="question-required">Required</span>' : ''}
          <button class="btn btn-sm" onclick="editQuestion('${q.id}')">‚úèÔ∏è</button>
          <button class="btn btn-sm" onclick="deleteQuestion('${q.id}')" style="color:var(--color-danger);">√ó</button>
        </div>
      `).join('');
    }
    
    function openQuestionModal(q = null) {
      if (q) {
        $('#question-modal-title').textContent = 'Edit Question';
        $('#question-id').value = q.id;
        $('#question-prompt').value = q.prompt;
        $('#question-type').value = q.field_type;
        $('#question-choices').value = (q.choices || []).join('\n');
        $('#question-required').checked = q.is_required;
      } else {
        $('#question-modal-title').textContent = 'Add Question';
        $('#question-id').value = '';
        $('#question-prompt').value = '';
        $('#question-type').value = 'text';
        $('#question-choices').value = '';
        $('#question-required').checked = false;
      }
      toggleChoicesField();
      $('#question-modal').classList.add('active');
    }
    
    function closeQuestionModal() { $('#question-modal').classList.remove('active'); }
    
    function toggleChoicesField() {
      const type = $('#question-type').value;
      $('#choices-group').style.display = ['dropdown', 'radio'].includes(type) ? 'block' : 'none';
    }
    
    function editQuestion(id) {
      const q = questions.find(x => x.id === id);
      if (q) openQuestionModal(q);
    }
    
    async function saveQuestion() {
      const id = $('#question-id').value;
      const type = $('#question-type').value;
      const data = {
        form_id: currentForm.id,
        prompt: $('#question-prompt').value,
        field_type: type,
        choices: ['dropdown', 'radio'].includes(type) ? $('#question-choices').value.split('\n').filter(x => x.trim()) : null,
        is_required: $('#question-required').checked,
        sort_order: id ? undefined : questions.length
      };
      
      if (!data.prompt) { showToast('Question prompt is required', 'error'); return; }
      
      try {
        const supabase = await app.waitForSupabase();
        if (id) {
          await supabase.from('booking_form_questions').update(data).eq('id', id);
        } else {
          const { data: newQ } = await supabase.from('booking_form_questions').insert([data]).select().single();
          questions.push(newQ);
        }
        
        // Reload questions
        const { data: qs } = await supabase.from('booking_form_questions').select('*').eq('form_id', currentForm.id).order('sort_order');
        questions = qs || [];
        
        closeQuestionModal();
        renderQuestions();
        updatePreview();
        showToast('Question saved', 'success');
      } catch (err) {
        console.error(err);
        showToast('Failed to save question', 'error');
      }
    }
    
    async function deleteQuestion(id) {
      if (!confirm('Delete this question?')) return;
      try {
        const supabase = await app.waitForSupabase();
        await supabase.from('booking_form_questions').delete().eq('id', id);
        questions = questions.filter(q => q.id !== id);
        renderQuestions();
        updatePreview();
      } catch (err) {
        showToast('Failed to delete', 'error');
      }
    }
    
    // Preview
    function updatePreview() {
      $('#preview-title').textContent = $('#form-header-title').value || 'Appointment Request';
      $('#preview-title').style.color = $('#form-color').value;
      $('#preview-desc').textContent = $('#form-header-desc').value || '';
      
      let html = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
          <div><label style="font-size:0.8rem;color:#666;">First Name *</label><input type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="First Name"></div>
          <div><label style="font-size:0.8rem;color:#666;">Last Name *</label><input type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="Last Name"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
          <div><label style="font-size:0.8rem;color:#666;">Email *</label><input type="email" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="Email"></div>
          <div><label style="font-size:0.8rem;color:#666;">Phone *</label><input type="tel" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="Phone"></div>
        </div>
      `;
      
      if ($('#show-address').checked) {
        html += `
          <div style="margin-bottom:16px;"><label style="font-size:0.8rem;color:#666;">Address *</label><input type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;" placeholder="Street"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
            <div><label style="font-size:0.8rem;color:#666;">City *</label><input type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"></div>
            <div><label style="font-size:0.8rem;color:#666;">State *</label><input type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"></div>
            <div><label style="font-size:0.8rem;color:#666;">ZIP *</label><input type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"></div>
          </div>
        `;
      }
      
      if ($('#show-service').checked) {
        html += `<div style="margin-bottom:16px;"><label style="font-size:0.8rem;color:#666;">Service Details *</label><textarea style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;min-height:80px;" placeholder="Enter as many details as you can..."></textarea></div>`;
      }
      
      if ($('#show-how-heard').checked) {
        html += `<div style="margin-bottom:16px;"><label style="font-size:0.8rem;color:#666;">How did you hear about us? *</label><select style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"><option>Select...</option></select></div>`;
      }
      
      // Custom questions
      questions.forEach(q => {
        const req = q.is_required ? ' *' : '';
        if (q.field_type === 'textarea') {
          html += `<div style="margin-bottom:16px;"><label style="font-size:0.8rem;color:#666;">${q.prompt}${req}</label><textarea style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"></textarea></div>`;
        } else if (q.field_type === 'dropdown') {
          const opts = (q.choices || []).map(c => `<option>${c}</option>`).join('');
          html += `<div style="margin-bottom:16px;"><label style="font-size:0.8rem;color:#666;">${q.prompt}${req}</label><select style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"><option>Select...</option>${opts}</select></div>`;
        } else if (q.field_type === 'radio') {
          const opts = (q.choices || []).map(c => `<label style="display:block;margin:4px 0;"><input type="radio" name="q_${q.id}"> ${c}</label>`).join('');
          html += `<div style="margin-bottom:16px;"><label style="font-size:0.8rem;color:#666;display:block;margin-bottom:4px;">${q.prompt}${req}</label>${opts}</div>`;
        } else {
          html += `<div style="margin-bottom:16px;"><label style="font-size:0.8rem;color:#666;">${q.prompt}${req}</label><input type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;"></div>`;
        }
      });
      
      if ($('#allow-attachments').checked) {
        html += `
          <div style="margin-bottom:16px;">
            <label style="font-size:0.8rem;color:#666;">Please add a few photos of your project</label>
            <div style="border:2px dashed #ddd;border-radius:8px;padding:32px;text-align:center;color:#999;">
              <div>Drag & Drop Images Here</div>
              <div style="margin:8px 0;">or</div>
              <button type="button" style="background:${$('#form-color').value};color:white;border:none;padding:8px 16px;border-radius:4px;">Browse Files</button>
            </div>
          </div>
        `;
      }
      
      if ($('#show-sms').checked) {
        html += `
          <div style="margin-bottom:16px;padding:12px;background:#f9f9f9;border-radius:8px;font-size:0.75rem;color:#666;">
            <label><input type="checkbox"> I agree to receive text messages from Homestead Cabinet Design...</label>
          </div>
        `;
      }
      
      html += `<button type="button" style="width:100%;background:${$('#form-color').value};color:white;border:none;padding:12px;border-radius:4px;font-size:1rem;cursor:pointer;">Submit Request</button>`;
      
      $('#preview-form').innerHTML = html;
    }
    
    // Tabs
    function setupTabs() {
      $$('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.dataset.tab;
          $$('.tab').forEach(t => t.classList.remove('active'));
          $$('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          $(`#tab-${tabId}`).classList.add('active');
        });
      });
      
      // Live preview updates
      ['form-header-title', 'form-header-desc', 'form-color', 'show-address', 'show-service', 'show-how-heard', 'show-datetime', 'allow-attachments', 'show-sms'].forEach(id => {
        const el = $('#' + id);
        if (el) el.addEventListener('change', updatePreview);
        if (el) el.addEventListener('input', updatePreview);
      });
    }
    
    function previewForm() {
      if (currentForm) window.open(`/book/${currentForm.slug}`, '_blank');
    }
    
    init();
  </script>
</body>
</html>
